<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VZOR — Guest Access</title>
<script src="https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
<style>
:root {
    --bg: #0B0F1A;
    --card: #111827;
    --card-hover: #1E293B;
    --border: rgba(255,255,255,0.07);
    --border-hover: rgba(255,255,255,0.14);
    --text: #F1F5F9;
    --text2: #94A3B8;
    --text3: #64748B;
    --accent: #3B82F6;
    --accent-hover: #60A5FA;
    --green: #22C55E;
    --amber: #F59E0B;
    --red: #EF4444;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,'Helvetica Neue',Arial,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
.wrap { max-width:760px; margin:0 auto; padding:32px 20px; }

/* Header */
.header { display:flex; align-items:center; justify-content:space-between; margin-bottom:32px; }
.header h1 { font-size:18px; font-weight:300; letter-spacing:6px; }
.header .link-home { color:var(--text3); font-size:12px; text-decoration:none; letter-spacing:1px; }
.header .link-home:hover { color:var(--text2); }

/* Login */
#login { text-align:center; margin-top:100px; }
#login input { padding:14px 20px; width:300px; font-size:14px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); outline:none; text-align:center; }
#login input:focus { border-color:var(--border-hover); }
#login input::placeholder { color:var(--text3); }
#login button { display:block; margin:16px auto 0; padding:10px 36px; font-size:11px; letter-spacing:2px; text-transform:uppercase; color:var(--text2); background:transparent; border:1px solid var(--border); border-radius:20px; cursor:pointer; }
#login button:hover { border-color:var(--accent); color:var(--text); }

#panel { display:none; }

/* Create section */
.create-bar { display:flex; gap:8px; margin-bottom:24px; align-items:stretch; }
.create-bar input, .create-bar select {
    padding:10px 14px; font-size:13px; background:var(--card); border:1px solid var(--border);
    border-radius:8px; color:var(--text); outline:none; font-family:inherit;
}
.create-bar input { flex:1; }
.create-bar input::placeholder { color:var(--text3); }
.create-bar input:focus, .create-bar select:focus { border-color:var(--border-hover); }
.create-bar select { cursor:pointer; -webkit-appearance:none; min-width:100px; color:var(--text2); }
.create-bar select option { background:var(--card); }
.btn-add {
    padding:10px 24px; font-size:12px; letter-spacing:2px; text-transform:uppercase;
    color:#fff; background:var(--accent); border:none; border-radius:8px; cursor:pointer;
    white-space:nowrap; transition:background 0.2s;
}
.btn-add:hover { background:var(--accent-hover); }

/* Result banner */
#result { display:none; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:28px; margin-bottom:24px; }
.result-grid { display:flex; gap:28px; align-items:flex-start; }
.result-qr { flex-shrink:0; }
.result-qr canvas { border-radius:8px; }
.result-info { flex:1; }
.result-info .name { font-size:14px; color:var(--text2); margin-bottom:4px; }
.result-info .code { font-family:'SF Mono','Fira Code',monospace; font-size:26px; font-weight:300; letter-spacing:4px; margin-bottom:12px; }
.result-info .short-link { font-size:13px; color:var(--text3); font-family:monospace; margin-bottom:4px; }
.result-info .expires { font-size:12px; color:var(--text3); margin-bottom:16px; }
.result-actions { display:flex; gap:8px; flex-wrap:wrap; }
.rbtn { padding:7px 16px; font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--text2); background:transparent; border:1px solid var(--border); border-radius:16px; cursor:pointer; font-family:inherit; transition:all 0.2s; }
.rbtn:hover { border-color:var(--text2); color:var(--text); }
.rbtn.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
.rbtn.primary:hover { background:var(--accent-hover); }
.rbtn.copied { background:rgba(34,197,94,0.1); border-color:var(--green); color:var(--green); }

/* Guest list */
.list-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.list-header h2 { font-size:13px; font-weight:400; letter-spacing:3px; text-transform:uppercase; color:var(--text3); }
.count { font-size:12px; color:var(--text3); }

.guest { background:var(--card); border:1px solid var(--border); border-radius:10px; margin-bottom:8px; overflow:hidden; transition:border-color 0.2s; }
.guest:hover { border-color:var(--border-hover); }
.guest-row { display:flex; align-items:center; padding:14px 18px; cursor:pointer; }
.guest-main { flex:1; }
.guest-name { font-size:14px; color:var(--text); margin-bottom:2px; }
.guest-meta { font-size:11px; color:var(--text3); }
.guest-meta span { margin-right:16px; }
.guest-code { font-family:monospace; font-size:13px; letter-spacing:2px; color:var(--text3); margin-right:16px; }
.pill { display:inline-block; padding:2px 8px; font-size:9px; border-radius:10px; letter-spacing:1px; text-transform:uppercase; margin-right:8px; }
.pill.active { background:rgba(34,197,94,0.1); color:var(--green); }
.pill.expired { background:rgba(239,68,68,0.1); color:var(--red); }
.pill.stopped { background:rgba(239,68,68,0.1); color:var(--red); }
.dots-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:18px; padding:4px 8px; border-radius:6px; }
.dots-btn:hover { background:rgba(255,255,255,0.05); color:var(--text); }

/* Expanded detail */
.guest-detail { display:none; padding:0 18px 16px; border-top:1px solid var(--border); }
.guest-detail.open { display:flex; gap:20px; padding-top:16px; }
.detail-qr { flex-shrink:0; }
.detail-qr canvas { border-radius:6px; }
.detail-right { flex:1; }
.detail-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.detail-label { font-size:11px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; width:80px; flex-shrink:0; }
.detail-value { font-size:13px; color:var(--text2); font-family:monospace; }
.detail-value a { color:var(--text2); text-decoration:none; }
.detail-value a:hover { color:var(--text); }
.detail-actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:12px; }
.dbtn { padding:5px 14px; font-size:10px; letter-spacing:1px; text-transform:uppercase; background:transparent; border:1px solid var(--border); border-radius:14px; cursor:pointer; font-family:inherit; transition:all 0.2s; }
.dbtn.copy { color:var(--text2); }
.dbtn.copy:hover { border-color:var(--accent); color:var(--accent); }
.dbtn.copy.done { border-color:var(--green); color:var(--green); }
.dbtn.extend { color:var(--green); border-color:rgba(34,197,94,0.2); }
.dbtn.extend:hover { border-color:var(--green); }
.dbtn.download { color:var(--accent); border-color:rgba(59,130,246,0.2); }
.dbtn.download:hover { border-color:var(--accent); }
.dbtn.stop { color:var(--red); border-color:rgba(239,68,68,0.15); }
.dbtn.stop:hover { border-color:var(--red); background:rgba(239,68,68,0.08); }
.dbtn.start { color:var(--green); border-color:rgba(34,197,94,0.15); }
.dbtn.start:hover { border-color:var(--green); background:rgba(34,197,94,0.08); }
.dbtn.share { color:var(--text3); }
.dbtn.share:hover { color:var(--text2); border-color:var(--text3); }
.dbtn.delete { color:var(--red); border-color:rgba(239,68,68,0.15); }
.dbtn.delete:hover { border-color:var(--red); background:rgba(239,68,68,0.08); }
.dbtn.save { color:var(--green); border-color:rgba(34,197,94,0.2); }
.dbtn.save:hover { border-color:var(--green); }
.dbtn.save.done { background:rgba(34,197,94,0.1); }
.edit-input { padding:4px 8px; font-size:12px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); outline:none; font-family:inherit; width:160px; }
.edit-input:focus { border-color:var(--border-hover); }

.empty { text-align:center; color:var(--text3); padding:48px; font-size:12px; letter-spacing:2px; }
</style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <h1>VZOR</h1>
        <a href="https://vzor-ai.com" class="link-home" target="_blank">vzor-ai.com</a>
    </div>

    <div id="login">
        <input type="password" id="secret-input" placeholder="Admin key" autocomplete="off">
        <button onclick="doLogin()">Enter</button>
    </div>

    <div id="panel">
        <div class="create-bar">
            <input type="text" id="f-name" placeholder="Guest name">
            <input type="email" id="f-email" placeholder="Email">
            <select id="f-days">
                <option value="7">7 days</option>
                <option value="30" selected>30 days</option>
                <option value="90">90 days</option>
                <option value="365">1 year</option>
            </select>
            <button class="btn-add" onclick="addGuest()">+ Add</button>
        </div>

        <div id="result"></div>

        <div class="list-header">
            <h2>Guests</h2>
            <span class="count" id="guest-count"></span>
        </div>
        <div id="guest-list"></div>
    </div>
</div>

<script>
var S = sessionStorage.getItem("vzor_a") || "";
if (S) { document.getElementById("login").style.display="none"; document.getElementById("panel").style.display="block"; loadAll(); }

document.getElementById("secret-input").addEventListener("keydown", function(e){ if(e.key==="Enter") doLogin(); });

function doLogin(){
    S = document.getElementById("secret-input").value.trim();
    if(!S) return;
    fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){
        if(r.ok){ sessionStorage.setItem("vzor_a",S); document.getElementById("login").style.display="none"; document.getElementById("panel").style.display="block"; loadAll(); }
        else alert("Wrong key");
    });
}

function sc(code){ return code.replace(/VZOR-/g,"").replace(/-/g,""); }
function surl(code){ return "vzor-ai.com/go/"+sc(code); }
function fullurl(code){ return "https://vzor-ai.com/go/"+sc(code); }
function tokenUrl(token){ return "https://vzor-ai.com/api/auth/token/"+token; }
function relTime(d){ if(!d) return "never"; var ms=Date.now()-new Date(d).getTime(); var m=ms/60000; if(m<60) return Math.floor(m)+"m ago"; var h=m/60; if(h<24) return Math.floor(h)+"h ago"; return Math.floor(h/24)+"d ago"; }
function fmtDate(d){ return new Date(d).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}); }
function esc(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function makeQR(url, size){
    return new QRCodeStyling({
        width:size, height:size, type:"canvas", data:url,
        dotsOptions:{ type:"rounded", color:"#FFFFFF" },
        cornersSquareOptions:{ type:"extra-rounded", color:"#FFFFFF" },
        cornersDotOptions:{ type:"dot", color:"#FFFFFF" },
        backgroundOptions:{ color:"#111827" },
        qrOptions:{ errorCorrectionLevel:"H" }
    });
}
function makeQRhd(url){
    return new QRCodeStyling({
        width:1024, height:1024, type:"canvas", data:url,
        dotsOptions:{ type:"rounded", color:"#FFFFFF" },
        cornersSquareOptions:{ type:"extra-rounded", color:"#FFFFFF" },
        cornersDotOptions:{ type:"dot", color:"#FFFFFF" },
        backgroundOptions:{ color:"#111827" },
        qrOptions:{ errorCorrectionLevel:"H" }
    });
}

var lastCreated = null;

async function addGuest(){
    var name=document.getElementById("f-name").value.trim();
    if(!name){ document.getElementById("f-name").focus(); return; }
    var email=document.getElementById("f-email").value.trim();
    var days=parseInt(document.getElementById("f-days").value);
    var r=await fetch("/api/admin/guests",{method:"POST",headers:{"Content-Type":"application/json","X-Admin-Secret":S},body:JSON.stringify({name:name,email:email,expires_days:days})});
    var d=await r.json();
    if(!r.ok){ alert(d.detail||"Error"); return; }
    lastCreated=d;

    var el=document.getElementById("result");
    el.style.display="block";
    el.innerHTML='<div class="result-grid"><div class="result-qr" id="rqr"></div><div class="result-info">'
        +'<div class="name">'+esc(d.guest.name)+'</div>'
        +'<div class="code">'+d.access_code+'</div>'
        +'<div class="short-link">'+surl(d.access_code)+'</div>'
        +'<div class="expires">Valid until '+fmtDate(d.guest.expires_at)+'</div>'
        +'<div class="result-actions">'
        +'<button class="rbtn primary" onclick="dlResultQR()">Download QR</button>'
        +'<button class="rbtn" id="copy-code-btn" onclick="copyResultCode()">Copy code</button>'
        +'<button class="rbtn" id="copy-link-btn" onclick="copyResultLink()">Copy link</button>'
        +'<button class="rbtn" onclick="shareWA()">WhatsApp</button>'
        +'<button class="rbtn" onclick="shareTG()">Telegram</button>'
        +'</div></div></div>';

    var qr=makeQR(tokenUrl(d.guest.token),200);
    qr.append(document.getElementById("rqr"));
    lastCreated._qr=qr;

    document.getElementById("f-name").value="";
    document.getElementById("f-email").value="";
    loadAll();
}

function dlResultQR(){ if(!lastCreated) return; var hd=makeQRhd(tokenUrl(lastCreated.guest.token)); hd.download({name:"VZOR-"+sc(lastCreated.access_code),extension:"png"}); }
function copyResultCode(){ if(!lastCreated) return; navigator.clipboard.writeText(lastCreated.access_code); flashBtn("copy-code-btn","Copied!"); }
function copyResultLink(){ if(!lastCreated) return; navigator.clipboard.writeText(fullurl(lastCreated.access_code)); flashBtn("copy-link-btn","Copied!"); }
function flashBtn(id,txt){ var b=document.getElementById(id); if(!b) return; var o=b.textContent; b.textContent=txt; b.classList.add("copied"); setTimeout(function(){ b.textContent=o; b.classList.remove("copied"); },1500); }
function shareWA(){ if(!lastCreated) return; window.open("https://wa.me/?text="+encodeURIComponent("VZOR — private access\n\nCode: "+lastCreated.access_code+"\n"+fullurl(lastCreated.access_code)),"_blank"); }
function shareTG(){ if(!lastCreated) return; window.open("https://t.me/share/url?url="+encodeURIComponent(fullurl(lastCreated.access_code))+"&text="+encodeURIComponent("VZOR access code: "+lastCreated.access_code),"_blank"); }

async function loadAll(){
    var r=await fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}});
    if(!r.ok){ S=""; sessionStorage.removeItem("vzor_a"); location.reload(); return; }
    var d=await r.json();
    var list=d.guests||[];
    document.getElementById("guest-count").textContent=list.length+" total";
    if(!list.length){ document.getElementById("guest-list").innerHTML='<div class="empty">No guests yet</div>'; return; }

    var html="";
    for(var i=0;i<list.length;i++){
        var g=list[i];
        var now=new Date(), exp=new Date(g.expires_at), isExp=exp<now;
        var st=!g.is_active?"stopped":isExp?"expired":"active";
        var stLabel=!g.is_active?"stopped":isExp?"expired":"active";

        html+='<div class="guest" id="g-'+g.id+'">'
            +'<div class="guest-row" onclick="toggle('+g.id+')">'
            +'<div class="guest-main">'
            +'<div class="guest-name"><span class="pill '+st+'">'+stLabel+'</span>'+esc(g.name)+'</div>'
            +'<div class="guest-meta">'
            +'<span>Last: '+relTime(g.last_login_at)+'</span>'
            +'<span>Logins: '+(g.login_count||0)+'</span>'
            +'<span>Expires: '+fmtDate(g.expires_at)+'</span>'
            +'</div></div>'
            +'<div class="guest-code">'+g.access_code+'</div>'
            +'</div>'
            +'<div class="guest-detail" id="det-'+g.id+'">'
            +'<div class="detail-qr" id="dqr-'+g.id+'"></div>'
            +'<div class="detail-right">'
            +'<div class="detail-row"><span class="detail-label">Name</span><input class="edit-input" id="en-'+g.id+'" value="'+esc(g.name)+'" onclick="event.stopPropagation()"></div>'
            +'<div class="detail-row"><span class="detail-label">Email</span><input class="edit-input" id="ee-'+g.id+'" value="'+esc(g.email||"")+'" placeholder="email" onclick="event.stopPropagation()"></div>'
            +'<div class="detail-row"><span class="detail-label">Link</span><span class="detail-value"><a href="'+fullurl(g.access_code)+'" target="_blank">'+surl(g.access_code)+'</a></span></div>'
            +'<div class="detail-row"><span class="detail-label">Code</span><span class="detail-value">'+g.access_code+'</span></div>'
            +'<div class="detail-row"><span class="detail-label">Created</span><span class="detail-value">'+fmtDate(g.created_at)+'</span></div>'
            +'<div class="detail-actions">'
            +'<button class="dbtn save" id="sv-'+g.id+'" onclick="event.stopPropagation();saveGuest('+g.id+')">Save</button>'
            +'<button class="dbtn copy" id="cl-'+g.id+'" onclick="event.stopPropagation();copyGuestLink('+g.id+',\''+esc(g.access_code)+'\')">Copy link</button>'
            +'<button class="dbtn download" onclick="event.stopPropagation();dlGuestQR('+g.id+',\''+esc(g.access_code)+'\')">Download QR</button>';

        if(g.is_active){
            html+='<span style="display:inline-flex;align-items:center;gap:4px">'
                +'<input type="number" id="ext-'+g.id+'" value="30" min="1" max="999" onclick="event.stopPropagation()" style="width:52px;padding:4px 6px;font-size:11px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);outline:none;text-align:center;font-family:inherit">'
                +'<button class="dbtn extend" onclick="event.stopPropagation();extendG('+g.id+')">+ days</button>'
                +'</span>'
                ;
        if(g.is_active){
            html+='<button class="dbtn stop" onclick="event.stopPropagation();stopG('+g.id+')">Stop</button>';
        } else {
            html+='<button class="dbtn start" onclick="event.stopPropagation();startG('+g.id+')">Start</button>';
        }
        }
        if(true){
            html+='<button class="dbtn delete" onclick="event.stopPropagation();deleteG('+g.id+')">Delete</button>';
        }

        html+='<button class="dbtn share" onclick="event.stopPropagation();shareGuestWA(\''+esc(g.access_code)+'\')">WhatsApp</button>'
            +'<button class="dbtn share" onclick="event.stopPropagation();shareGuestTG(\''+esc(g.access_code)+'\')">Telegram</button>'
            +'</div></div></div></div>';
    }
    document.getElementById("guest-list").innerHTML=html;
}

var openGuests={};
function toggle(id){
    var det=document.getElementById("det-"+id);
    if(!det) return;
    if(det.classList.contains("open")){
        det.classList.remove("open");
        delete openGuests[id];
    } else {
        det.classList.add("open");
        // Render QR if not done
        if(!openGuests[id]){
            openGuests[id]=true;
            // Need token - fetch guests to find it
            fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){return r.json();}).then(function(d){
                var g=(d.guests||[]).find(function(x){return x.id===id;});
                if(!g) return;
                var qr=makeQR(tokenUrl(g.token),160);
                var container=document.getElementById("dqr-"+id);
                if(container){ container.innerHTML=""; qr.append(container); }
                openGuests[id]=qr;
            });
        }
    }
}

function copyGuestLink(id,code){
    navigator.clipboard.writeText(fullurl(code));
    var b=document.getElementById("cl-"+id);
    if(b){ b.textContent="Copied!"; b.classList.add("done"); setTimeout(function(){ b.textContent="Copy link"; b.classList.remove("done"); },1500); }
}

function dlGuestQR(id,code){
    // Fetch token and generate HD QR for download
    fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){return r.json();}).then(function(d){
        var g=(d.guests||[]).find(function(x){return x.id===id;});
        if(!g) return;
        var hd=makeQRhd(tokenUrl(g.token));
        hd.download({name:"VZOR-"+sc(code),extension:"png"});
    });
}

async function extendG(id){
    var inp=document.getElementById("ext-"+id);
    var days=inp?parseInt(inp.value):30;
    if(!days||days<1){ return; }
    await fetch("/api/admin/guests/"+id+"/extend",{method:"POST",headers:{"Content-Type":"application/json","X-Admin-Secret":S},body:JSON.stringify({days:days})});
    openGuests={}; loadAll();
}

async function stopG(id){
    if(!confirm('Stop access for this guest?')) return;
    await fetch('/api/admin/guests/'+id,{method:'DELETE',headers:{'X-Admin-Secret':S}});
    loadGuests();
}
async function startG(id){
    if(!confirm('Reactivate access for this guest?')) return;
    await fetch('/api/admin/guests/'+id+'/activate',{method:'POST',headers:{'X-Admin-Secret':S}});
    loadGuests();
}
async function deleteG(id){
    if(!confirm("Permanently delete this guest?")) return;
    await fetch("/api/admin/guests/"+id+"/delete",{method:"POST",headers:{"X-Admin-Secret":S}});
    openGuests={}; loadAll();
}

function shareGuestWA(code){ window.open("https://wa.me/?text="+encodeURIComponent("VZOR — private access\n\nCode: "+code+"\n"+fullurl(code)),"_blank"); }
function shareGuestTG(code){ window.open("https://t.me/share/url?url="+encodeURIComponent(fullurl(code))+"&text="+encodeURIComponent("VZOR access code: "+code),"_blank"); }
</script>
</body>
</html>
