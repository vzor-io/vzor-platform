<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VZOR — Guest Access</title>
<script src="https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
<style>
:root {
    --bg: #0B0F1A;
    --card: #111827;
    --card-hover: #1E293B;
    --border: rgba(255,255,255,0.07);
    --border-hover: rgba(255,255,255,0.14);
    --text: #F1F5F9;
    --text2: #94A3B8;
    --text3: #64748B;
    --accent: #3B82F6;
    --accent-hover: #60A5FA;
    --green: #22C55E;
    --amber: #F59E0B;
    --red: #EF4444;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,'Helvetica Neue',Arial,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
.wrap { max-width:760px; margin:0 auto; padding:32px 20px; }

/* Header */
.header { display:flex; align-items:center; justify-content:space-between; margin-bottom:32px; }
.header h1 { font-size:18px; font-weight:300; letter-spacing:6px; }
.header .link-home { color:var(--text3); font-size:12px; text-decoration:none; letter-spacing:1px; }
.header .link-home:hover { color:var(--text2); }

/* Login */
#login { text-align:center; margin-top:100px; }
#login input { padding:14px 20px; width:300px; font-size:14px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); outline:none; text-align:center; }
#login input:focus { border-color:var(--border-hover); }
#login input::placeholder { color:var(--text3); }
#login button { display:block; margin:16px auto 0; padding:10px 36px; font-size:11px; letter-spacing:2px; text-transform:uppercase; color:var(--text2); background:transparent; border:1px solid var(--border); border-radius:20px; cursor:pointer; }
#login button:hover { border-color:var(--accent); color:var(--text); }

#panel { display:none; }

/* Create section */
.create-bar { display:flex; gap:8px; margin-bottom:24px; align-items:stretch; }
.create-bar input, .create-bar select {
    padding:10px 14px; font-size:13px; background:var(--card); border:1px solid var(--border);
    border-radius:8px; color:var(--text); outline:none; font-family:inherit;
}
.create-bar input { flex:1; }
.create-bar input::placeholder { color:var(--text3); }
.create-bar input:focus, .create-bar select:focus { border-color:var(--border-hover); }
.create-bar select { cursor:pointer; -webkit-appearance:none; min-width:100px; color:var(--text2); }
.create-bar select option { background:var(--card); }
.btn-add {
    padding:10px 24px; font-size:12px; letter-spacing:2px; text-transform:uppercase;
    color:#fff; background:var(--accent); border:none; border-radius:8px; cursor:pointer;
    white-space:nowrap; transition:background 0.2s;
}
.btn-add:hover { background:var(--accent-hover); }

/* Result banner */
#result { display:none; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:28px; margin-bottom:24px; }
.result-grid { display:flex; gap:28px; align-items:flex-start; }
.result-qr { flex-shrink:0; }
.result-qr canvas { border-radius:8px; }
.result-info { flex:1; }
.result-info .name { font-size:14px; color:var(--text2); margin-bottom:4px; }
.result-info .code { font-family:'SF Mono','Fira Code',monospace; font-size:26px; font-weight:300; letter-spacing:4px; margin-bottom:12px; }
.result-info .short-link { font-size:13px; color:var(--text3); font-family:monospace; margin-bottom:4px; }
.result-info .expires { font-size:12px; color:var(--text3); margin-bottom:16px; }
.result-actions { display:flex; gap:8px; flex-wrap:wrap; }
.rbtn { padding:7px 16px; font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--text2); background:transparent; border:1px solid var(--border); border-radius:16px; cursor:pointer; font-family:inherit; transition:all 0.2s; }
.rbtn:hover { border-color:var(--text2); color:var(--text); }
.rbtn.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
.rbtn.primary:hover { background:var(--accent-hover); }
.rbtn.copied { background:rgba(34,197,94,0.1); border-color:var(--green); color:var(--green); }

/* Guest list */
.list-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.list-header h2 { font-size:13px; font-weight:400; letter-spacing:3px; text-transform:uppercase; color:var(--text3); }
.count { font-size:12px; color:var(--text3); }

.guest { background:var(--card); border:1px solid var(--border); border-radius:10px; margin-bottom:8px; overflow:hidden; transition:border-color 0.2s; }
.guest:hover { border-color:var(--border-hover); }
.guest-row { display:flex; align-items:center; padding:14px 18px; cursor:pointer; }
.guest-main { flex:1; }
.guest-name { font-size:14px; color:var(--text); margin-bottom:2px; }
.guest-meta { font-size:11px; color:var(--text3); }
.guest-meta span { margin-right:16px; }
.guest-code { font-family:monospace; font-size:13px; letter-spacing:2px; color:var(--text3); margin-right:16px; }
.pill { display:inline-block; padding:2px 8px; font-size:9px; border-radius:10px; letter-spacing:1px; text-transform:uppercase; margin-right:8px; }
.pill.active { background:rgba(34,197,94,0.1); color:var(--green); }
.pill.expired { background:rgba(239,68,68,0.1); color:var(--red); }
.pill.stopped { background:rgba(239,68,68,0.1); color:var(--red); }
.dots-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:18px; padding:4px 8px; border-radius:6px; }
.dots-btn:hover { background:rgba(255,255,255,0.05); color:var(--text); }

/* Expanded detail */
.guest-detail { display:none; padding:0 18px 16px; border-top:1px solid var(--border); }
.guest-detail.open { display:flex; gap:20px; padding-top:16px; }
.detail-qr { flex-shrink:0; }
.detail-qr canvas { border-radius:6px; }
.detail-right { flex:1; }
.detail-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.detail-label { font-size:11px; color:var(--text3); letter-spacing:1px; text-transform:uppercase; width:80px; flex-shrink:0; }
.detail-value { font-size:13px; color:var(--text2); font-family:monospace; }
.detail-value a { color:var(--text2); text-decoration:none; }
.detail-value a:hover { color:var(--text); }
.detail-actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:12px; }
.dbtn { padding:5px 14px; font-size:10px; letter-spacing:1px; text-transform:uppercase; background:transparent; border:1px solid var(--border); border-radius:14px; cursor:pointer; font-family:inherit; transition:all 0.2s; }
.dbtn.copy { color:var(--text2); }
.dbtn.copy:hover { border-color:var(--accent); color:var(--accent); }
.dbtn.copy.done { border-color:var(--green); color:var(--green); }
.dbtn.extend { color:var(--green); border-color:rgba(34,197,94,0.2); }
.dbtn.extend:hover { border-color:var(--green); }
.dbtn.download { color:var(--accent); border-color:rgba(59,130,246,0.2); }
.dbtn.download:hover { border-color:var(--accent); }
.dbtn.stop { color:var(--red); border-color:rgba(239,68,68,0.15); }
.dbtn.stop:hover { border-color:var(--red); background:rgba(239,68,68,0.08); }
.dbtn.start { color:var(--green); border-color:rgba(34,197,94,0.15); }
.dbtn.start:hover { border-color:var(--green); background:rgba(34,197,94,0.08); }
.dbtn.share { color:var(--text3); }
.dbtn.share:hover { color:var(--text2); border-color:var(--text3); }
.dbtn.delete { color:var(--red); border-color:rgba(239,68,68,0.15); }
.dbtn.delete:hover { border-color:var(--red); background:rgba(239,68,68,0.08); }
.dbtn.save { color:var(--green); border-color:rgba(34,197,94,0.2); }
.dbtn.save:hover { border-color:var(--green); }
.dbtn.save.done { background:rgba(34,197,94,0.1); }
.edit-input { padding:4px 8px; font-size:12px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); outline:none; font-family:inherit; width:160px; }
.edit-input:focus { border-color:var(--border-hover); }

.empty { text-align:center; color:var(--text3); padding:48px; font-size:12px; letter-spacing:2px; }
</style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <h1>VZOR</h1>
        <a href="https://vzor-ai.com" class="link-home" target="_blank">vzor-ai.com</a>
    </div>

    <div id="login">
        <input type="password" id="secret-input" placeholder="Admin key" autocomplete="off">
        <button onclick="doLogin()">Enter</button>
    </div>

    <div id="panel">
        <div class="create-bar">
            <input type="text" id="f-name" placeholder="Guest name">
            <input type="email" id="f-email" placeholder="Email">
            <select id="f-days">
                <option value="7">7 days</option>
                <option value="30" selected>30 days</option>
                <option value="90">90 days</option>
                <option value="365">1 year</option>
            </select>
            <button class="btn-add" onclick="addGuest()">+ Add</button>
        </div>

        <div id="result"></div>

        <div class="list-header">
            <h2>Guests</h2>
            <span class="count" id="guest-count"></span>
        </div>
        <div id="guest-list"></div>
    </div>
</div>

<script>
var VZOR_LOGO = 'data:image/png;base64,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';
var S = sessionStorage.getItem("vzor_a") || "";
if (S) { document.getElementById("login").style.display="none"; document.getElementById("panel").style.display="block"; loadAll(); }

document.getElementById("secret-input").addEventListener("keydown", function(e){ if(e.key==="Enter") doLogin(); });

function doLogin(){
    S = document.getElementById("secret-input").value.trim();
    if(!S) return;
    fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){
        if(r.ok){ sessionStorage.setItem("vzor_a",S); document.getElementById("login").style.display="none"; document.getElementById("panel").style.display="block"; loadAll(); }
        else alert("Wrong key");
    });
}

function sc(code){ return code.replace(/VZOR-/g,"").replace(/-/g,""); }
function surl(code){ return "vzor-ai.com/go/"+sc(code); }
function fullurl(code){ return "https://vzor-ai.com/go/"+sc(code); }
function tokenUrl(token){ return "https://vzor-ai.com/api/auth/token/"+token; }
function relTime(d){ if(!d) return "never"; var ms=Date.now()-new Date(d).getTime(); var m=ms/60000; if(m<60) return Math.floor(m)+"m ago"; var h=m/60; if(h<24) return Math.floor(h)+"h ago"; return Math.floor(h/24)+"d ago"; }
function fmtDate(d){ return new Date(d).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}); }
function esc(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function makeQR(url, size){
    return new QRCodeStyling({
        width:size, height:size, type:"canvas", data:url,
        dotsOptions:{ type:"rounded", color:"#FFFFFF" },
        cornersSquareOptions:{ type:"extra-rounded", color:"#FFFFFF" },
        cornersDotOptions:{ type:"dot", color:"#FFFFFF" },
        backgroundOptions:{ color:"#111827" },
        image:VZOR_LOGO,
        imageOptions:{ crossOrigin:"anonymous", margin:6, hideBackgroundDots:true },
        qrOptions:{ errorCorrectionLevel:"H" }
    });
}
function makeQRhd(url){
    return new QRCodeStyling({
        width:1024, height:1024, type:"canvas", data:url,
        dotsOptions:{ type:"rounded", color:"#FFFFFF" },
        cornersSquareOptions:{ type:"extra-rounded", color:"#FFFFFF" },
        cornersDotOptions:{ type:"dot", color:"#FFFFFF" },
        backgroundOptions:{ color:"#111827" },
        image:VZOR_LOGO,
        imageOptions:{ crossOrigin:"anonymous", margin:6, hideBackgroundDots:true },
        qrOptions:{ errorCorrectionLevel:"H" }
    });
}

var lastCreated = null;

async function addGuest(){
    var name=document.getElementById("f-name").value.trim();
    if(!name){ document.getElementById("f-name").focus(); return; }
    var email=document.getElementById("f-email").value.trim();
    var days=parseInt(document.getElementById("f-days").value);
    var r=await fetch("/api/admin/guests",{method:"POST",headers:{"Content-Type":"application/json","X-Admin-Secret":S},body:JSON.stringify({name:name,email:email,expires_days:days})});
    var d=await r.json();
    if(!r.ok){ alert(d.detail||"Error"); return; }
    lastCreated=d;

    var el=document.getElementById("result");
    el.style.display="block";
    el.innerHTML='<div class="result-grid"><div class="result-qr" id="rqr"></div><div class="result-info">'
        +'<div class="name">'+esc(d.guest.name)+'</div>'
        +'<div class="code">'+d.access_code+'</div>'
        +'<div class="short-link">'+surl(d.access_code)+'</div>'
        +'<div class="expires">Valid until '+fmtDate(d.guest.expires_at)+'</div>'
        +'<div class="result-actions">'
        +'<button class="rbtn primary" onclick="dlResultQR()">Download QR</button>'
        +'<button class="rbtn" id="copy-code-btn" onclick="copyResultCode()">Copy code</button>'
        +'<button class="rbtn" id="copy-link-btn" onclick="copyResultLink()">Copy link</button>'
        +'<button class="rbtn" onclick="shareWA()">WA link</button>'
        +'<button class="rbtn" onclick="shareTG()">TG link</button>'
        +'<button class="rbtn" onclick="shareResultQR(&#39;WhatsApp&#39;)">WA QR</button>'
        +'<button class="rbtn" onclick="shareResultQR(&#39;Telegram&#39;)">TG QR</button>'
        +'</div></div></div>';

    var qr=makeQR(tokenUrl(d.guest.token),200);
    qr.append(document.getElementById("rqr"));
    lastCreated._qr=qr;

    document.getElementById("f-name").value="";
    document.getElementById("f-email").value="";
    loadAll();
}

function dlResultQR(){ if(!lastCreated) return; var hd=makeQRhd(tokenUrl(lastCreated.guest.token)); hd.download({name:"VZOR-"+sc(lastCreated.access_code),extension:"png"}); }
function copyResultCode(){ if(!lastCreated) return; navigator.clipboard.writeText(lastCreated.access_code); flashBtn("copy-code-btn","Copied!"); }
function copyResultLink(){ if(!lastCreated) return; navigator.clipboard.writeText(fullurl(lastCreated.access_code)); flashBtn("copy-link-btn","Copied!"); }
function flashBtn(id,txt){ var b=document.getElementById(id); if(!b) return; var o=b.textContent; b.textContent=txt; b.classList.add("copied"); setTimeout(function(){ b.textContent=o; b.classList.remove("copied"); },1500); }
function shareWA(){ if(!lastCreated) return; window.open("https://wa.me/?text="+encodeURIComponent("VZOR — private access\n\nCode: "+lastCreated.access_code+"\n"+fullurl(lastCreated.access_code)),"_blank"); }
async function shareResultQR(platform){
    if(!lastCreated) return;
    var qr=makeQRhd(tokenUrl(lastCreated.guest.token));
    var blob=await qr.getRawData("png");
    if(!blob) return;
    var file=new File([blob],"VZOR-"+sc(lastCreated.access_code)+".png",{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
        navigator.share({files:[file],title:"VZOR QR",text:"VZOR access: "+lastCreated.access_code});
    } else {
        var url=URL.createObjectURL(blob);
        var a=document.createElement("a");
        a.href=url; a.download="VZOR-"+sc(lastCreated.access_code)+".png"; a.click();
        URL.revokeObjectURL(url);
        alert("QR saved. Attach it manually in "+platform);
    }
}
function shareTG(){ if(!lastCreated) return; window.open("https://t.me/share/url?url="+encodeURIComponent(fullurl(lastCreated.access_code))+"&text="+encodeURIComponent("VZOR access code: "+lastCreated.access_code),"_blank"); }

async function loadAll(){
    var r=await fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}});
    if(!r.ok){ S=""; sessionStorage.removeItem("vzor_a"); location.reload(); return; }
    var d=await r.json();
    var list=d.guests||[];
    document.getElementById("guest-count").textContent=list.length+" total";
    if(!list.length){ document.getElementById("guest-list").innerHTML='<div class="empty">No guests yet</div>'; return; }

    var html="";
    for(var i=0;i<list.length;i++){
        var g=list[i];
        var now=new Date(), exp=new Date(g.expires_at), isExp=exp<now;
        var st=!g.is_active?"stopped":isExp?"expired":"active";
        var stLabel=!g.is_active?"stopped":isExp?"expired":"active";

        html+='<div class="guest" id="g-'+g.id+'">'
            +'<div class="guest-row" onclick="toggle('+g.id+')">'
            +'<div class="guest-main">'
            +'<div class="guest-name"><span class="pill '+st+'">'+stLabel+'</span>'+esc(g.name)+'</div>'
            +'<div class="guest-meta">'
            +'<span>Last: '+relTime(g.last_login_at)+'</span>'
            +'<span>Logins: '+(g.login_count||0)+'</span>'
            +'<span>Expires: '+fmtDate(g.expires_at)+'</span>'
            +'</div></div>'
            +'<div class="guest-code">'+g.access_code+'</div>'
            +'</div>'
            +'<div class="guest-detail" id="det-'+g.id+'">'
            +'<div class="detail-qr" id="dqr-'+g.id+'"></div>'
            +'<div class="detail-right">'
            +'<div class="detail-row"><span class="detail-label">Name</span><input class="edit-input" id="en-'+g.id+'" value="'+esc(g.name)+'" onclick="event.stopPropagation()"></div>'
            +'<div class="detail-row"><span class="detail-label">Email</span><input class="edit-input" id="ee-'+g.id+'" value="'+esc(g.email||"")+'" placeholder="email" onclick="event.stopPropagation()"></div>'
            +'<div class="detail-row"><span class="detail-label">Link</span><span class="detail-value"><a href="'+fullurl(g.access_code)+'" target="_blank">'+surl(g.access_code)+'</a></span></div>'
            +'<div class="detail-row"><span class="detail-label">Code</span><span class="detail-value">'+g.access_code+'</span></div>'
            +'<div class="detail-row"><span class="detail-label">Created</span><span class="detail-value">'+fmtDate(g.created_at)+'</span></div>'
            +'<div class="detail-actions">'
            +'<button class="dbtn save" id="sv-'+g.id+'" onclick="event.stopPropagation();saveGuest('+g.id+')">Save</button>'
            +'<button class="dbtn copy" id="cl-'+g.id+'" onclick="event.stopPropagation();copyGuestLink('+g.id+',\''+esc(g.access_code)+'\')">Copy link</button>'
            +'<button class="dbtn download" onclick="event.stopPropagation();dlGuestQR('+g.id+',\''+esc(g.access_code)+'\')">Download QR</button>';

        if(g.is_active){
            html+='<span style="display:inline-flex;align-items:center;gap:4px">'
                +'<input type="number" id="ext-'+g.id+'" value="30" min="1" max="999" onclick="event.stopPropagation()" style="width:52px;padding:4px 6px;font-size:11px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);outline:none;text-align:center;font-family:inherit">'
                +'<button class="dbtn extend" onclick="event.stopPropagation();extendG('+g.id+')">+ days</button>'
                +'</span>';
            html+='<button class="dbtn stop" onclick="event.stopPropagation();stopG('+g.id+')">Stop</button>';
        } else {
            html+='<button class="dbtn start" onclick="event.stopPropagation();startG('+g.id+')">Start</button>';
        }
        if(true){
            html+='<button class="dbtn delete" onclick="event.stopPropagation();deleteG('+g.id+')">Delete</button>';
        }

        html+='<button class="dbtn share" onclick="event.stopPropagation();shareGuestWA(&#39;'+esc(g.access_code)+'&#39;)">WA link</button>'
            +'<button class="dbtn share" onclick="event.stopPropagation();shareQRImage('+g.id+',&#39;'+esc(g.access_code)+'&#39;,&#39;WhatsApp&#39;)">WA QR</button>'
            +'<button class="dbtn share" onclick="event.stopPropagation();shareGuestTG(&#39;'+esc(g.access_code)+'&#39;)">TG link</button>'
            +'<button class="dbtn share" onclick="event.stopPropagation();shareQRImage('+g.id+',&#39;'+esc(g.access_code)+'&#39;,&#39;Telegram&#39;)">TG QR</button>'
            +'</div></div></div></div>';
    }
    document.getElementById("guest-list").innerHTML=html;
}

var openGuests={};
function toggle(id){
    var det=document.getElementById("det-"+id);
    if(!det) return;
    if(det.classList.contains("open")){
        det.classList.remove("open");
        delete openGuests[id];
    } else {
        det.classList.add("open");
        // Render QR if not done
        if(!openGuests[id]){
            openGuests[id]=true;
            // Need token - fetch guests to find it
            fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){return r.json();}).then(function(d){
                var g=(d.guests||[]).find(function(x){return x.id===id;});
                if(!g) return;
                var qr=makeQR(tokenUrl(g.token),160);
                var container=document.getElementById("dqr-"+id);
                if(container){ container.innerHTML=""; qr.append(container); }
                openGuests[id]=qr;
            });
        }
    }
}

function copyGuestLink(id,code){
    navigator.clipboard.writeText(fullurl(code));
    var b=document.getElementById("cl-"+id);
    if(b){ b.textContent="Copied!"; b.classList.add("done"); setTimeout(function(){ b.textContent="Copy link"; b.classList.remove("done"); },1500); }
}

function dlGuestQR(id,code){
    // Fetch token and generate HD QR for download
    fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}}).then(function(r){return r.json();}).then(function(d){
        var g=(d.guests||[]).find(function(x){return x.id===id;});
        if(!g) return;
        var hd=makeQRhd(tokenUrl(g.token));
        hd.download({name:"VZOR-"+sc(code),extension:"png"});
    });
}

async function extendG(id){
    var inp=document.getElementById("ext-"+id);
    var days=inp?parseInt(inp.value):30;
    if(!days||days<1){ return; }
    await fetch("/api/admin/guests/"+id+"/extend",{method:"POST",headers:{"Content-Type":"application/json","X-Admin-Secret":S},body:JSON.stringify({days:days})});
    openGuests={}; loadAll();
}

async function stopG(id){
    if(!confirm('Stop access for this guest?')) return;
    await fetch('/api/admin/guests/'+id,{method:'DELETE',headers:{'X-Admin-Secret':S}});
    openGuests={};loadAll();
}
async function startG(id){
    if(!confirm('Reactivate access for this guest?')) return;
    await fetch('/api/admin/guests/'+id+'/activate',{method:'POST',headers:{'X-Admin-Secret':S}});
    openGuests={};loadAll();
}
async function deleteG(id){
    if(!confirm("Permanently delete this guest?")) return;
    await fetch("/api/admin/guests/"+id+"/delete",{method:"POST",headers:{"X-Admin-Secret":S}});
    openGuests={}; loadAll();
}

async function saveGuest(id){
    var name=document.getElementById("en-"+id);
    var email=document.getElementById("ee-"+id);
    if(!name) return;
    var r=await fetch("/api/admin/guests/"+id+"/update",{method:"POST",headers:{"Content-Type":"application/json","X-Admin-Secret":S},body:JSON.stringify({name:name.value.trim(),email:email?email.value.trim():""})});
    if(r.ok){
        var b=document.getElementById("sv-"+id);
        if(b){b.textContent="Saved!";b.classList.add("done");setTimeout(function(){b.textContent="Save";b.classList.remove("done");},1500);}
        openGuests={};loadAll();
    }
}

async function shareQRImage(guestId, code, platform){
    var r=await fetch("/api/admin/guests",{headers:{"X-Admin-Secret":S}});
    var d=await r.json();
    var g=(d.guests||[]).find(function(x){return x.id===guestId;});
    if(!g) return;
    var qr=makeQRhd(tokenUrl(g.token));
    var blob=await qr.getRawData("png");
    if(!blob) return;
    var file=new File([blob],"VZOR-"+sc(code)+".png",{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
        navigator.share({files:[file],title:"VZOR QR",text:"VZOR access: "+code});
    } else {
        var url=URL.createObjectURL(blob);
        var a=document.createElement("a");
        a.href=url; a.download="VZOR-"+sc(code)+".png"; a.click();
        URL.revokeObjectURL(url);
        alert("QR saved. Attach it manually in "+platform);
    }
}

function shareGuestWA(code){ window.open("https://wa.me/?text="+encodeURIComponent("VZOR — private access\n\nCode: "+code+"\n"+fullurl(code)),"_blank"); }
function shareGuestTG(code){ window.open("https://t.me/share/url?url="+encodeURIComponent(fullurl(code))+"&text="+encodeURIComponent("VZOR access code: "+code),"_blank"); }
</script>
</body>
</html>
