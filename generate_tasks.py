#!/usr/bin/env python3
"""
VZOR DevProject Structure v2.1 - Generate 169 tasks JSON.
Output: tasks_169.json ready for upload via curl to /api/tasks/save
"""
import json

BLOCKS = [
    {
        "name": "Инвестиционный анализ",
        "phase": "Инвестиционный анализ",
        "sections": [
            {
                "id": "1.1", "title": "Маркетинговый анализ рынка",
                "tasks": [
                    (1, "Анализ макроэкономических показателей региона", "ВВП, инфляция, ставка ЦБ, тренды рынка недвижимости"),
                    (2, "Демографический анализ целевой локации", "Население, миграция, возрастная структура, доходы"),
                    (3, "Анализ платёжеспособного спроса", "Средний доход, кредитоспособность, ипотечный потенциал"),
                    (4, "Исследование конкурентной среды", "Текущие и заявленные проекты, УТП конкурентов"),
                    (5, "Анализ поглощения (абсорбции)", "Темпы продаж у конкурентов, сроки экспозиции"),
                    (6, "Ценовой анализ первичного рынка", "Цены за м² по сегментам и классам, динамика"),
                    (7, "Ценовой анализ вторичного рынка", "Вторичка как бенчмарк, спред первичка/вторичка"),
                    (8, "Анализ арендного рынка", "Арендные ставки, доходность, cap rate"),
                    (9, "Прогноз развития инфраструктуры", "Транспорт, соц. объекты, ген.план развития территории"),
                    (10, "Определение целевого продукта", "Тип жилья, класс, предварительная квартирография в ТЗ"),
                ]
            },
            {
                "id": "1.2", "title": "Земельный участок: юридический due diligence",
                "tasks": [
                    (11, "Проверка прав собственности и обременений", "ЕГРН, аресты, залоги, сервитуты"),
                    (12, "Анализ градостроительной документации", "ПЗЗ, ГПЗУ, ВРИ, предельные ТЭП"),
                    (13, "Анализ инженерных сетей и коммуникаций", "Точки подключения, мощности, предварительные ТУ"),
                    (14, "Геодезические и геологические предварительные данные", "Рельеф, грунты, гидрология"),
                    (15, "Анализ транспортной доступности", "Дороги, метро, подъезды, парковка"),
                    (16, "Оценка рыночной стоимости участка", "Рыночная оценка, кадастровая стоимость"),
                ]
            },
            {
                "id": "1.3", "title": "Ограничения и обременения участка (ЗОУИТ)",
                "tasks": [
                    (17, "Проверка охранных зон ОКН", "Памятники, ансамбли, защитные зоны"),
                    (18, "Проверка санитарно-защитных зон (СЗЗ)", "Промышленные объекты, ТЭЦ, кладбища"),
                    (19, "Проверка водоохранных зон", "Реки, водоёмы, береговые полосы"),
                    (20, "Проверка приаэродромных территорий", "Ограничения высотности вблизи аэропортов"),
                    (21, "Проверка зон охраны инженерных сетей", "Газопроводы, ЛЭП, магистральные трубопроводы"),
                    (22, "Проверка экологических ограничений", "ООПТ, красная книга, загрязнённые земли"),
                    (23, "Проверка ограничений высотности застройки", "Высотный регламент города, ГПЗУ"),
                    (24, "Оценка рисков по участку", "Оползни, подтопления, сейсмика, радон"),
                    (25, "Сводное заключение по ограничениям", "Карта ЗОУИТ, влияние на ТЭП и себестоимость"),
                ]
            },
            {
                "id": "1.4", "title": "Финансовая модель: себестоимость проекта",
                "tasks": [
                    (26, "Расчёт стоимости земли и оформления", "Покупка/аренда, кадастр, регистрация"),
                    (27, "Расчёт стоимости проектирования", "Изыскания, проект стадия П, РД, экспертиза"),
                    (28, "Расчёт себестоимости СМР", "Материалы, работа, механизмы, накладные"),
                    (29, "Бюджет на подключение коммуникаций", "Электро, вода, газ, тепло, канализация"),
                    (30, "Расчёт затрат на благоустройство", "Озеленение, площадки, дороги, МАФ"),
                    (31, "Маркетинговый бюджет", "Реклама, отдел продаж, брокеры, CRM"),
                    (32, "Административные и управленческие расходы", "Штат, офис, юристы, бухгалтерия"),
                    (33, "Расчёт налоговой нагрузки", "НДС, налог на прибыль, земельный, имущественный"),
                ]
            },
            {
                "id": "1.5", "title": "Финмодель для банка: ПФ + эскроу",
                "tasks": [
                    (34, "Моделирование денежных потоков (DCF)", "Помесячный cash flow: расходы + поступления"),
                    (35, "Расчёт графика продаж по этапам строительства", "Старт → котлован → каркас → ввод"),
                    (36, "Модель проектного финансирования (214-ФЗ)", "Кредитная линия, транши, ставка ПФ"),
                    (37, "Модель накопления эскроу-счетов", "Помесячное накопление, покрытие долга"),
                    (38, "Расчёт процентных расходов по ПФ", "Рыночная ставка до покрытия → льготная"),
                    (39, "Модель собственного участия (equity)", "Собственные средства 15-30%"),
                    (40, "Расчёт IRR, NPV, ROI, PI", "Показатели эффективности для инвестора"),
                    (41, "Расчёт прибыли проекта (margin)", "Выручка − себестоимость − проценты ПФ"),
                    (42, "Расчёт срока окупаемости (PP, DPP)", "Простой и дисконтированный срок возврата"),
                    (43, "Анализ точки безубыточности", "% продаж для выхода в ноль"),
                ]
            },
            {
                "id": "1.6", "title": "Стресс-тестирование и риск-менеджмент",
                "tasks": [
                    (44, "Сценарный анализ (баз./опт./песс.)", "Изменение цен, себестоимости, сроков"),
                    (45, "Анализ чувствительности (sensitivity)", "Влияние параметров на NPV/IRR"),
                    (46, "Monte Carlo симуляция", "Вероятностное моделирование рисков"),
                    (47, "Реестр рисков проекта", "Строительные, рыночные, правовые, финансовые"),
                    (48, "Матрица рисков: вероятность × импакт", "Калибровка, приоритизация, heat map"),
                    (49, "План митигации рисков", "Стратегии снижения, резервы, страхование"),
                ]
            },
            {
                "id": "1.7", "title": "Структурирование сделки и GO/NO GO",
                "tasks": [
                    (50, "Выбор организационно-правовой формы", "ООО, АО, SPV, ПИФ"),
                    (51, "Структурирование партнёрства / JV", "Условия входа/выхода инвесторов"),
                    (52, "Подготовка инвестиционного меморандума", "ТЭО + финмодель + риски"),
                    (53, "Due diligence контрагентов", "Проверка подрядчиков, проектировщиков"),
                    (54, "Разработка exit-стратегии", "Продажа пакета, IPO, рефинансирование"),
                    (55, "РЕШЕНИЕ GO / NO GO", "Презентация банку → одобрение ПФ → старт"),
                ]
            },
        ]
    },
    {
        "name": "Проектирование",
        "phase": "Проектирование",
        "sections": [
            {
                "id": "2.1", "title": "Получение ГПЗУ и анализ градпотенциала",
                "tasks": [
                    (1, "Получение ГПЗУ", "Градплан ЗУ через Москомархитектуру"),
                    (2, "Анализ предельных параметров ГПЗУ", "Этажность, плотность, % застройки, отступы"),
                    (3, "Проверка ЗОУИТ в составе ГПЗУ", "ОКН, СЗЗ, водоохранные, ЛЭП"),
                    (4, "Оценка градпотенциала участка", "Максимальная продаваемая площадь"),
                    (5, "Решение о необходимости изменения ВРИ/ПЗЗ", "Если параметры ГПЗУ не подходят"),
                ]
            },
            {
                "id": "2.2", "title": "Продуктовая концепция и квартирография",
                "tasks": [
                    (6, "Формирование продуктовой стратегии", "Класс ЖК, УТП, целевая аудитория"),
                    (7, "Разработка квартирографии (ТЗ)", "Линейка квартир, площади, пропорции"),
                    (8, "Оптимизация квартирографии по рынку", "Исключение внутренней конкуренции"),
                    (9, "Требования к коммерческим помещениям", "Первые этажи: площади, функции"),
                    (10, "Требования к паркингу и кладовым", "Количество м/м, соотношение"),
                    (11, "Требования к МОП и отделке", "Входные группы, лифтхоллы"),
                    (12, "Формирование ТЗ на проектирование", "ГПЗУ + квартирография + требования"),
                ]
            },
            {
                "id": "2.3", "title": "Эскизная концепция / АГР",
                "tasks": [
                    (13, "Разработка мастерплана / СПОЗУ", "Посадка зданий на участке"),
                    (14, "Вариантное проектирование (2-5 вариантов)", "Сравнение ТЭП и визуальных решений"),
                    (15, "Разработка объёмно-планировочных решений", "Секции, этажность, конфигурация"),
                    (16, "Разработка типовых планов этажей", "Планировки квартир из ТЗ"),
                    (17, "Разработка фасадных решений", "Материалы, цвета, витражи"),
                    (18, "Визуализация (рендеры, 3D-модель)", "3D-визуализация + 3D-модель"),
                    (19, "Предварительный расчёт ТЭП", "Общая/жилая/полезная площадь"),
                    (20, "Согласование концепции с заказчиком", "Утверждение ТЭП, фасадов, бюджета"),
                ]
            },
            {
                "id": "2.4", "title": "Согласование АГР в Москомархитектуре",
                "tasks": [
                    (21, "Подготовка буклета АГР", "Альбом А3: фасады, план, ТЭП"),
                    (22, "Подача АГР в Москомархитектуру", "Через портал mos.ru"),
                    (23, "Рассмотрение на Архсовете", "Для крупных/значимых объектов"),
                    (24, "Устранение замечаний Москомархитектуры", "Корректировка фасадов, объёмов"),
                    (25, "Получение Свидетельства об утверждении АГР", "Утверждённый облик для стадии П"),
                ]
            },
            {
                "id": "2.5", "title": "Инженерные изыскания и ТУ",
                "tasks": [
                    (26, "Получение ТУ на электроснабжение", "Мощность, точка подключения"),
                    (27, "Получение ТУ на водоснабжение и водоотведение", "Расходы, давление, ливнёвка"),
                    (28, "Получение ТУ на теплоснабжение", "Тепловая нагрузка, параметры"),
                    (29, "Получение ТУ на газоснабжение", "Газопровод, ГРУ, присоединение"),
                    (30, "Получение ТУ на телекоммуникации", "Интернет, телефония, ТВ"),
                    (31, "Инженерные изыскания: геодезия", "Топографическая съёмка M1:500"),
                    (32, "Инженерные изыскания: геология", "Бурение, лабораторные анализы"),
                    (33, "Инженерные изыскания: экология", "Радиация, загрязнение, шум"),
                    (34, "Инженерные изыскания: гидрометеорология", "Уровень грунтовых вод, осадки"),
                    (35, "Дендрологическое обследование", "Перечётная ведомость, порубочный билет"),
                    (36, "Историко-культурная экспертиза", "ОКН, археология, охранные зоны"),
                ]
            },
            {
                "id": "2.6", "title": "Стадия П: архитектура и конструктив",
                "tasks": [
                    (37, "Архитектурные решения (АР)", "Фасады, планировки, кровля"),
                    (38, "Конструктивные решения (КР)", "Фундаменты, каркас, перекрытия"),
                    (39, "Проектирование подземного паркинга", "Количество м/м, рампы, пожарные отсеки"),
                    (40, "Проектирование коммерческих помещений", "Первые этажи, ритейл"),
                    (41, "Проектирование вертикального транспорта", "Лифты: количество, скорость"),
                    (42, "Проектирование входных групп", "Архитектура, МГН, безопасность"),
                ]
            },
            {
                "id": "2.7", "title": "Проектная документация: инженерия",
                "tasks": [
                    (43, "Раздел ОВиК", "Отопление, вентиляция, кондиционирование"),
                    (44, "Раздел ВК", "Водоснабжение и канализация"),
                    (45, "Раздел ЭОМ", "Электрооборудование, щитовые"),
                    (46, "Раздел СС (слаботочные системы)", "Домофон, СКУД, видеонаблюдение"),
                    (47, "Раздел АТХ (автоматизация)", "Умный дом, диспетчерская, АСКУЭ"),
                    (48, "Наружные сети: электроснабжение", "Кабельные линии, ТП, подстанции"),
                    (49, "Наружные сети: теплоснабжение", "Теплотрасса, ИТП/ЦТП"),
                    (50, "Наружные сети: водоснабжение", "Водоводы, насосные станции"),
                    (51, "Наружные сети: канализация и ливнёвка", "Коллекторы, очистные, КНС"),
                    (52, "Наружные сети: газоснабжение", "Газопровод, ГРУ"),
                ]
            },
            {
                "id": "2.8", "title": "Специальные разделы ПД",
                "tasks": [
                    (53, "ПОС (проект организации строительства)", "Стройгенплан, этапность, графики"),
                    (54, "ПОД (проект организации демонтажа)", "Снос существующих зданий"),
                    (55, "Пожарная безопасность (ПБ)", "Эвакуация, пожаротушение, АУПС"),
                    (56, "Мероприятия по охране окруж. среды", "Экология, рекультивация"),
                    (57, "Мероприятия для МГН", "Доступная среда, пандусы, лифты"),
                    (58, "Энергоэффективность", "Класс энергоэффективности, утепление"),
                    (59, "Благоустройство территории", "Озеленение, дорожки, МАФ"),
                ]
            },
            {
                "id": "2.9", "title": "Экспертиза, согласования, BIM",
                "tasks": [
                    (60, "BIM-моделирование", "3D модель, clash detection, LOD 300+"),
                    (61, "Прохождение государственной экспертизы", "Проверка ПД и результатов изысканий"),
                    (62, "Устранение замечаний экспертизы", "Корректировка документации"),
                    (63, "Согласование АГР/АГО", "Архитектурно-градостроительный облик"),
                    (64, "Согласование с КГИОП", "Памятники, охранные зоны"),
                    (65, "Получение разрешения на строительство (РнС)", "РнС в органах стройнадзора"),
                    (66, "Разработка рабочей документации (РД)", "Детальные чертежи для строительства"),
                    (67, "Авторский надзор", "Контроль соответствия проекту"),
                ]
            },
        ]
    },
    {
        "name": "Строительство",
        "phase": "Строительство",
        "sections": [
            {
                "id": "3.1", "title": "Подготовительный период",
                "tasks": [
                    (1, "Получение разрешения на строительство", "РнС в Госстройнадзоре"),
                    (2, "Подготовка стройплощадки", "Ограждение, бытовки, временные сооружения"),
                    (3, "Снос/демонтаж существующих строений", "Если на участке есть объекты"),
                ]
            },
            {
                "id": "3.2", "title": "Нулевой цикл",
                "tasks": [
                    (4, "Земляные работы, котлован", "Выемка грунта, крепление стен"),
                    (5, "Устройство свайного основания", "Забивка/бурение свай, испытания"),
                    (6, "Устройство фундамента", "Монолитная плита, ростверк"),
                    (7, "Гидроизоляция фундамента", "Битумная, мембранная"),
                    (8, "Возведение подземной части (паркинг)", "Монолит, рампы, вентиляция"),
                ]
            },
            {
                "id": "3.3", "title": "Надземная часть",
                "tasks": [
                    (9, "Возведение надземного каркаса", "Монолит: колонны, стены, перекрытия"),
                    (10, "Кладочные работы (наружные стены)", "Кирпич, газобетон, перегородки"),
                    (11, "Монтаж фасадных систем", "Навесной фасад, штукатурка, витражи"),
                    (12, "Устройство кровли", "Кровельный пирог, водоотведение"),
                ]
            },
            {
                "id": "3.4", "title": "Инженерия и отделка",
                "tasks": [
                    (13, "Монтаж внутренних инженерных систем", "ОВиК, ВК, ЭОМ, слаботочка"),
                    (14, "Монтаж лифтового оборудования", "Шахты, кабины, пусконаладка"),
                    (15, "Внутренняя отделка МОП", "Лестницы, холлы, входные группы"),
                    (16, "Отделка квартир", "Чистовая / предчистовая"),
                    (17, "Прокладка наружных инженерных сетей", "Подключение к городским сетям"),
                    (18, "Благоустройство территории", "Дороги, тротуары, озеленение"),
                ]
            },
            {
                "id": "3.5", "title": "Контроль и ввод",
                "tasks": [
                    (19, "Пусконаладочные работы", "Тестирование всех систем"),
                    (20, "Строительный контроль", "Ведение журналов, проверки"),
                    (21, "Технический надзор заказчика", "Контроль качества и объёмов"),
                    (22, "Строительный аудит", "Независимая проверка"),
                    (23, "Получение ЗОС", "Заключение о соответствии"),
                    (24, "Получение разрешения на ввод (РнВ)", "Ввод объекта в эксплуатацию"),
                    (25, "Постановка на кадастровый учёт", "Кадастровый паспорт, техплан"),
                    (26, "Присвоение почтового адреса", "Адресный реестр"),
                    (27, "Передача в управляющую компанию", "Документация, ключи, системы"),
                ]
            },
        ]
    },
    {
        "name": "Продажи",
        "phase": "Продажи",
        "sections": [
            {
                "id": "4.1", "title": "Маркетинг и подготовка к продажам",
                "tasks": [
                    (1, "Разработка маркетинговой стратегии", "Позиционирование, УТП, каналы, бюджет"),
                    (2, "Нейминг и брендинг проекта", "Название ЖК, логотип, айдентика"),
                    (3, "Создание сайта проекта", "Лендинг, 3D-туры, планировки"),
                    (4, "Оформление проектной декларации", "214-ФЗ требования"),
                    (5, "Открытие эскроу-счетов", "Договоры с банками"),
                    (6, "Организация шоу-рума / офиса продаж", "Макеты, отделочные образцы, VR"),
                    (7, "Формирование прайс-листа", "Цены за м², коэффициенты"),
                ]
            },
            {
                "id": "4.2", "title": "Активные продажи",
                "tasks": [
                    (8, "Запуск рекламных кампаний", "Контекст, таргет, наружная, СМИ"),
                    (9, "Динамическое ценообразование", "Повышение цен по этапам"),
                    (10, "Управление воронкой продаж (CRM)", "Лиды, конверсия, аналитика"),
                    (11, "Работа с ипотечными программами", "Субсидии, партнёрства с банками"),
                    (12, "Программы trade-in", "Зачёт старого жилья"),
                    (13, "Рассрочка и спецусловия", "Скидки, акции, бронирование"),
                    (14, "Юридическое сопровождение сделок", "ДДУ, регистрация Росреестр"),
                    (15, "Продажа коммерческих помещений", "Ритейл, офисы, машиноместа"),
                    (16, "Продажа/аренда паркинга", "Машиноместа, кладовые"),
                ]
            },
            {
                "id": "4.3", "title": "Передача и постпродажа",
                "tasks": [
                    (17, "Приёмка квартир дольщиками", "Акты, устранение замечаний"),
                    (18, "Передача ключей", "Логистика, документы, гарантии"),
                    (19, "Управление гарантийными обязательствами", "5 лет гарантия, рекламации"),
                    (20, "Анализ эффективности продаж", "KPI, план-факт, отчётность"),
                ]
            },
        ]
    },
]


def build():
    tasks = []
    deps = []

    for block_idx, block in enumerate(BLOCKS):
        prefix = f"B{block_idx+1}"
        phase = block["phase"]

        # L0 phase node
        l0_id = f"{prefix}-L0"
        tasks.append({
            "id": l0_id,
            "title": block["name"],
            "phase": phase,
            "level": 0,
            "status": "pending",
            "progress": 0,
            "agent": "",
            "database": "",
            "dependsOn": []
        })

        prev_sec_id = None
        for sec in block["sections"]:
            sec_id = f"{prefix}-{sec['id']}"
            sec_deps = [l0_id]
            if prev_sec_id:
                sec_deps.append(prev_sec_id)

            tasks.append({
                "id": sec_id,
                "title": f"{sec['id']} {sec['title']}",
                "phase": phase,
                "level": 1,
                "status": "pending",
                "progress": 0,
                "agent": "",
                "database": "",
                "dependsOn": sec_deps
            })
            deps.append({"from": l0_id, "to": sec_id})
            if prev_sec_id:
                deps.append({"from": prev_sec_id, "to": sec_id})
            prev_sec_id = sec_id

            # L2 subtasks
            prev_t_id = None
            for n, title, desc in sec["tasks"]:
                t_id = f"{prefix}-{sec['id']}-T{n}"
                t_deps = [sec_id]
                if prev_t_id:
                    t_deps.append(prev_t_id)

                tasks.append({
                    "id": t_id,
                    "title": title,
                    "phase": phase,
                    "level": 2,
                    "status": "pending",
                    "progress": 0,
                    "agent": "",
                    "database": desc,
                    "dependsOn": t_deps
                })
                deps.append({"from": sec_id, "to": t_id})
                if prev_t_id:
                    deps.append({"from": prev_t_id, "to": t_id})
                prev_t_id = t_id

    return tasks, deps


if __name__ == "__main__":
    tasks, deps = build()
    l0 = sum(1 for t in tasks if t["level"] == 0)
    l1 = sum(1 for t in tasks if t["level"] == 1)
    l2 = sum(1 for t in tasks if t["level"] == 2)
    print(f"Total: {len(tasks)} tasks (L0:{l0} L1:{l1} L2:{l2}), {len(deps)} deps")

    payload = {
        "tasks": tasks,
        "dependencies": deps,
        "category": "",
        "session_id": "default"
    }
    with open(r"C:\Users\vzor\tasks_169.json", "w", encoding="utf-8") as f:
        json.dump(payload, f, ensure_ascii=False, indent=2)
    print("Saved to tasks_169.json")
