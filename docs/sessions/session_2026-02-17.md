# Сессия 2026-02-17 — Настройка RAGFlow баз знаний
**Статус:** ЗАВЕРШЕНО
**Что сделано:** Загрузка, сортировка и обработка 36 документов в 10 базах знаний RAGFlow

---

## 1. Что было сделано

### 1.1 Сортировка документов
- Загружено 41 файл с локальной машины на сервер
- Путь на сервере: `/home/vzor/documents/`
- Удалено 5 дубликатов и 2 мусорных файла
- 36 уникальных документов рассортированы по 10 доменным папкам

### 1.2 Создание баз знаний RAGFlow
Создано 10 баз знаний через RAGFlow API:

| База знаний | ID | Документы | Чанки |
|---|---|---|---|
| ЭС — Электроснабжение | 8a26d27c0c1011f1a70a7ecd752f3782 | 6 | 833 |
| ВК — Водоснабжение и канализация | 8a3e6e640c1011f1920e7ecd752f3782 | 8 | 403 |
| ОВиК — Отопление вентиляция кондиционирование | 8a52fa860c1011f1989c7ecd752f3782 | 5 | 473 |
| ПБ — Пожарная безопасность | 8a673f060c1011f186b67ecd752f3782 | 3 | 363 |
| ГС — Газоснабжение | 8a7b00340c1011f195977ecd752f3782 | 2 | 222 |
| АР — Архитектурные решения | 8a8ee0550c1011f1964e7ecd752f3782 | 2 | 119 |
| ОДИ — Доступность для МГН | 8aa2b06e0c1011f1ae857ecd752f3782 | 2 | 25 |
| СС — Сети связи | 8ab6419a0c1011f1b2c57ecd752f3782 | 4 | 149 |
| ТУ — Технические условия и регламенты | 8ac948f20c1011f197657ecd752f3782 | 3 | 213 |
| Общее — Проектное дело | 8adda8a20c1011f1ab1e7ecd752f3782 | 1 | 92 |
| **ИТОГО** | | **36** | **2892** |

### 1.3 Исправление TEI/Embedding
- RAGFlow v0.23.1 не включает встроенные embedding модели
- Включён TEI (Text Embeddings Inference) с моделью BAAI/bge-m3
- Сервер RAM увеличена с 16 GB до 32 GB (Cloud.ru)
- Исправлено 2 бага:
  1. `service_conf.yaml.template` — добавлено `name: "BAAI/bge-m3"`
  2. MySQL `tenant_llm` — исправлено `max_tokens` с 0 на 8192

### 1.4 Результат парсинга
- 35 из 36 документов — DONE
- 1 FAIL — ПП_РФ_87_Состав_проектной_документации.docx (нужно конвертировать в PDF)

---

## 2. Карта документов по папкам

### /home/vzor/documents/ЭС/ (6 файлов)
1. СП_256.1325800.2016_Электроустановки_жилых_и_общественных_зданий.pdf
2. СП_76.13330.2016_Электротехнические_устройства.pdf
3. Шеховцов_Расчет_схем_электроснабжения.pdf
4. Стандарт_экспертизы_электроснабжения.pdf
5. Кабышев_Обухов_Расчет_систем_электроснабжения.pdf
6. Сазыкин_Проектирование_систем_электроснабжения.pdf

### /home/vzor/documents/ВК/ (8 файлов)
1. СП_31.13330.2021_Водоснабжение_наружные_сети.pdf
2. Сомов_Квитка_Водоснабжение_учебник.pdf
3. Воронов_Яковлев_Водоотведение_очистка.pdf
4. Воронов_Водоотведение.pdf
5. Водоснабжение_и_водоотведение_пособие_ТувГУ.pdf
6. Абрамов_Водоснабжение_учебник.pdf
7. СанПиН_2.1.4.1116-02_Питьевая_вода_расфасованная.pdf
8. СанПиН_2.1.4.1175-02_Качество_воды_нецентрализованных.pdf

### /home/vzor/documents/ОВиК/ (5 файлов)
1. СП_60.13330.2020_Отопление_вентиляция_кондиционирование.pdf
2. Крупнов_Руководство_проектирование_ОВиК.pdf
3. Балашов_Проектирование_отопления_вентиляции.pdf
4. Цыганков_Рецензия_проектирование_вентиляции.pdf
5. Системы_вентиляции_и_кондиционирования_рекомендации.pdf

### /home/vzor/documents/ПБ/ (3 файла)
1. СП_4.13130.2009_Ограничение_распространения_пожара.pdf
2. СП_1.13130.2009_Эвакуационные_пути_и_выходы.pdf
3. СП_5.13130.2009_АПС_и_пожаротушение.pdf

### /home/vzor/documents/ГС/ (2 файла)
1. ПП_РФ_1547_Правила_подключения_к_газу.pdf
2. СП_402.1325800.2018_Газопотребление_жилых_зданий.pdf

### /home/vzor/documents/АР/ (2 файла)
1. СП_117.13330.2011_Общественные_здания_административного_назначения.pdf
2. СП_118.13330.2012_Общественные_здания_и_сооружения.pdf

### /home/vzor/documents/ОДИ/ (2 файла)
1. ГОСТ_Р_52875-2007_Тактильные_указатели.pdf
2. ГОСТ_Р_51261-2017_Опорные_устройства_реабилитации.pdf

### /home/vzor/documents/СС/ (4 файла)
1. СП_134.13330.2022_Системы_электросвязи.pdf
2. Рекомендации_проектирование_систем_связи_Москомархитектура.pdf
3. Давыдов_Проектирование_телекоммуникационных_систем.pdf
4. СП_519.1325800.2023_Сети_связи_правила_проектирования.pdf

### /home/vzor/documents/ТУ/ (3 файла)
1. ПП_РФ_145_Порядок_госэкспертизы.pdf
2. ПП_РФ_87_Состав_проектной_документации.docx (FAIL)
3. ПП_РФ_861_Правила_технологического_присоединения.pdf

### /home/vzor/documents/Общее/ (1 файл)
1. Аникин_Царев_Проектное_дело_в_строительстве.pdf

---

## 3. Изменения конфигурации на сервере

### RAGFlow .env (/home/vzor/ragflow/docker/.env)
- Строка ~169: раскомментировано COMPOSE_PROFILES=${COMPOSE_PROFILES},tei-cpu
- Строка ~181: TEI_MODEL=${TEI_MODEL:-BAAI/bge-m3}

### RAGFlow service_conf.yaml.template (/home/vzor/ragflow/docker/service_conf.yaml.template)
- Добавлено name: "BAAI/bge-m3" в секцию user_default_llm.default_models.embedding_model

### MySQL таблица tenant_llm (база rag_flow)
- UPDATE tenant_llm SET max_tokens=8192 WHERE llm_name='BAAI/bge-m3' AND llm_factory='Builtin'

---

## 4. API доступ к базам знаний

### RAGFlow API
- URL с сервера: http://localhost:9380/api/v1
- URL извне: http://95.174.95.209:9380/api/v1
- Токен: ragflow-c36bd6a4202fcfefaed61f8e9df5456e
- Заголовок: Authorization: Bearer ragflow-c36bd6a4202fcfefaed61f8e9df5456e
- Tenant ID: f3d5a31a067911f1adb70ade3ab485df

### Embedding модель
- Модель: BAAI/bge-m3 (1024-мерные вектора)
- Сервис: TEI (Text Embeddings Inference) на http://tei:80 внутри Docker сети
- Режим: CPU (требует 32 GB RAM)

---

## 5. Docker-контейнеры RAGFlow

- docker-ragflow-cpu-1 — RAGFlow v0.23.1
- docker-tei-cpu-1 — TEI embedding (BAAI/bge-m3, CPU)
- docker-mysql-1 — MySQL 8.0.39
- docker-es01-1 — Elasticsearch 8.11.3
- docker-minio-1 — MinIO
- docker-redis-1 — Valkey/Redis 8

Запуск: cd /home/vzor/ragflow/docker && docker compose up -d
Остановка: cd /home/vzor/ragflow/docker && docker compose stop
