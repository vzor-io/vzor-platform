# ЗАДАЧА НА 2026-02-18 — Подключение RAGFlow баз знаний к Agent Zero
**Приоритет:** ВЫСОКИЙ
**Предусловие:** Сессия 2026-02-17 завершена, 10 баз знаний RAGFlow готовы (2892 чанка)

---

## КОНТЕКСТ

### Что уже есть
1. **10 баз знаний RAGFlow** с 35 обработанными документами (2892 чанка с embedding BAAI/bge-m3)
2. **Реестр 67 субагентов** — файл VZOR_AGENTS_REGISTRY.md на рабочем столе (C:\Users\vzor\Desktop\)
3. **Нормативный справочник** — файл NORMATIVE_REFERENCE.md на рабочем столе
4. **Agent Zero** работает на сервере: http://95.174.95.209:50080
5. **RAGFlow API** работает: http://95.174.95.209:9380/api/v1

### Инфраструктура
- Сервер: 95.174.95.209 (Cloud.ru, 32 GB RAM, 4 vCPU)
- SSH: ssh -i "C:\Users\vzor\Desktop\.ssh\id_ed25519" vzor@95.174.95.209
- Agent Zero данные: /home/vzor/agent-zero-data/
- Agent Zero роль: /home/vzor/agent-zero-data/agents/agent0/prompts/agent.system.main.role.md
- Agent Zero инструменты: /home/vzor/agent-zero-data/instruments/custom/
- Agent Zero знания: /home/vzor/agent-zero-data/knowledge/custom/main/
- RAGFlow API токен: ragflow-c36bd6a4202fcfefaed61f8e9df5456e

---

## ЗАДАЧИ

### Задача 1: Создать инструмент ragflow_search для Agent Zero
**Что:** Python-инструмент, который Agent Zero может вызывать для поиска по базам знаний RAGFlow
**Где:** /home/vzor/agent-zero-data/instruments/custom/ragflow_search.py (или .md)
**Логика:**
- Принимает запрос (question) и опционально ID базы знаний (dataset_id)
- Если dataset_id не указан — ищет по ВСЕМ 10 базам
- Вызывает RAGFlow Retrieval API: POST /api/v1/retrieval
- Возвращает найденные чанки с указанием источника

**RAGFlow Retrieval API формат:**
```json
POST http://localhost:9380/api/v1/retrieval
Headers: Authorization: Bearer ragflow-c36bd6a4202fcfefaed61f8e9df5456e
Body: {
  "question": "текст запроса",
  "dataset_ids": ["id1", "id2"],
  "similarity_threshold": 0.2,
  "vector_similarity_weight": 0.3,
  "top_k": 5
}
```

**ID баз знаний для маппинга:**
```python
KB_MAP = {
    "ЭС": "8a26d27c0c1011f1a70a7ecd752f3782",
    "ВК": "8a3e6e640c1011f1920e7ecd752f3782",
    "ОВиК": "8a52fa860c1011f1989c7ecd752f3782",
    "ПБ": "8a673f060c1011f186b67ecd752f3782",
    "ГС": "8a7b00340c1011f195977ecd752f3782",
    "АР": "8a8ee0550c1011f1964e7ecd752f3782",
    "ОДИ": "8aa2b06e0c1011f1ae857ecd752f3782",
    "СС": "8ab6419a0c1011f1b2c57ecd752f3782",
    "ТУ": "8ac948f20c1011f197657ecd752f3782",
    "Общее": "8adda8a20c1011f1ab1e7ecd752f3782",
}
ALL_KB_IDS = list(KB_MAP.values())
```

### Задача 2: Обновить системную роль Agent Zero
**Что:** Добавить в системный промпт Agent Zero информацию о доступных базах знаний
**Где:** /home/vzor/agent-zero-data/agents/agent0/prompts/agent.system.main.role.md
**Добавить:**
- Список доступных баз знаний с описанием содержимого
- Инструкцию: при вопросах по нормативам — сначала искать в RAGFlow
- Маппинг тем к базам знаний (электроснабжение → ЭС, пожарка → ПБ и т.д.)

### Задача 3: Загрузить нормативный справочник в знания Agent Zero
**Что:** Скопировать NORMATIVE_REFERENCE.md в папку знаний Agent Zero
**Где:** /home/vzor/agent-zero-data/knowledge/custom/main/
**Зачем:** Агент будет иметь встроенные знания о структуре проектной документации по ПП РФ 87

### Задача 4: Протестировать поиск
**Что:** Проверить что Agent Zero корректно ищет по базам знаний
**Тесты:**
1. "Какие требования к электроснабжению жилого дома?" → должен найти в ЭС
2. "Нормы пожарной безопасности для эвакуационных путей" → должен найти в ПБ
3. "Требования к вентиляции жилых зданий" → должен найти в ОВиК
4. "Правила подключения к газу" → должен найти в ГС

### Задача 5 (опционально): Исправить FAIL документ
**Что:** Конвертировать ПП_РФ_87.docx в PDF и загрузить в RAGFlow
**Где:** База знаний ТУ (8ac948f20c1011f197657ecd752f3782)

### Задача 6 (опционально): Загрузить недостающие документы
**Что:** Найти и загрузить документы для разделов, где пока нет баз знаний:
- КР — Конструктивные решения (СП 20, СП 22, СП 63, СП 16, СП 14)
- СМ — Сметная документация
- ПОС — Проект организации строительства
- ООС — Охрана окружающей среды
- ЭЭ — Энергоэффективность

---

## ПОРЯДОК ВЫПОЛНЕНИЯ

1. Задача 1 (ragflow_search инструмент) — ПЕРВАЯ, без неё агент не может искать
2. Задача 3 (справочник в знания) — быстро, просто скопировать файл
3. Задача 2 (обновить роль) — после создания инструмента
4. Задача 4 (тестирование) — после всех настроек
5. Задачи 5-6 — по необходимости

---

## ВАЖНЫЕ ЗАМЕЧАНИЯ

- Agent Zero запущен в Docker: данные в /home/vzor/agent-zero-data/
- После изменения инструментов/промптов Agent Zero нужно перезапустить или перезагрузить через UI
- RAGFlow API работает на localhost:9380 (внутри Docker сети доступен по имени контейнера)
- Embedding модель BAAI/bge-m3 работает на CPU — поиск может быть медленным (1-3 сек на запрос)
- RAM сервера 32 GB — после настройки агентов можно попробовать уменьшить до 16 GB (но TEI может не влезть)
