# План реализации v3.10 — Полная архитектура нод

> **Цель:** Создать полноценную систему визуального программирования для девелопмента
> **База:** index_v3.9.html
> **Принцип:** Каждое изменение проверяется перед следующим

---

## ЧАСТЬ 1: ДЕТАЛЬНЫЙ АНАЛИЗ ЗАДАЧ ПО БЛОКАМ

### 1.1 БЛОК INVEST (Инвестиционный анализ)

#### Задачи и их параметры:

**1. Анализ участка (Cadastre Analysis)**
```
ВХОДЫ:
├── cadastral_number: string     # "77:01:0001234:567"
├── address: string              # Альтернативный поиск
└── api_key: string              # Ключ Росреестра (опционально)

ВЫХОДЫ:
├── geo_json: GeoJSON            # Границы участка
├── area: number                 # Площадь (м²)
├── vri: string                  # Вид разрешённого использования
├── category: string             # Категория земель
├── encumbrances: array          # Обременения
└── owner_info: object           # Информация о собственнике
```

**2. Градостроительный анализ (Urban Analysis)**
```
ВХОДЫ:
├── geo_json: GeoJSON            # От "Анализ участка"
├── pzz_database: reference      # База ПЗЗ региона
└── snip_database: reference     # База СНиП

ВЫХОДЫ:
├── max_floors: number           # Макс. этажность
├── max_density: number          # Плотность застройки
├── setbacks: object             # Отступы от границ
├── allowed_functions: array     # Разрешённые функции
├── restrictions: array          # Ограничения
└── tep_preliminary: object      # Предварительные ТЭП
```

**3. Анализ конкурентов (Market Analysis)**
```
ВХОДЫ:
├── coordinates: [lat, lng]      # Центр поиска
├── radius_km: number            # Радиус анализа
├── object_type: enum            # Жильё/Офис/Торговля
└── market_database: reference   # База рынка (ЦИАН, ДомКлик)

ВЫХОДЫ:
├── competitors: array           # Список конкурентов
├── avg_price_sqm: number        # Средняя цена за м²
├── price_range: [min, max]      # Диапазон цен
├── absorption_rate: number      # Скорость продаж
├── demand_index: number         # Индекс спроса
└── market_report: file          # Отчёт PDF
```

**4. Юридическая проверка (Legal Check)**
```
ВХОДЫ:
├── cadastral_number: string     # От "Анализ участка"
├── owner_info: object           # От "Анализ участка"
└── legal_database: reference    # База судебных дел

ВЫХОДЫ:
├── title_clean: boolean         # Чистота титула
├── disputes: array              # Судебные споры
├── liens: array                 # Залоги
├── risk_score: number           # Оценка риска (0-100)
└── legal_report: file           # Юридическое заключение
```

**5. Финансовая модель (Financial Model)**
```
ВХОДЫ:
├── tep: object                  # ТЭП от градоанализа
├── prices: object               # Цены от анализа рынка
├── construction_cost: number    # Стоимость строительства
├── land_cost: number            # Стоимость земли
├── financing: object            # Условия финансирования
│   ├── equity_share: number     # Доля собственных средств
│   ├── debt_rate: number        # Ставка кредита
│   └── debt_term: number        # Срок кредита
└── timeline: object             # Сроки проекта

ВЫХОДЫ:
├── npv: number                  # Чистая приведённая стоимость
├── irr: number                  # Внутренняя норма доходности
├── payback_period: number       # Срок окупаемости
├── profit_margin: number        # Маржинальность
├── cashflow: array              # Денежный поток по периодам
├── sensitivity: object          # Анализ чувствительности
└── finmodel_file: file          # Excel с моделью
```

**6. Инвестиционный меморандум (Investment Memo)**
```
ВХОДЫ:
├── all_analysis: bundle         # Все предыдущие выходы
├── project_description: string  # Описание проекта
├── company_info: object         # Информация о девелопере
└── template: reference          # Шаблон документа

ВЫХОДЫ:
├── memo_pdf: file               # PDF меморандум
├── presentation: file           # PowerPoint
├── one_pager: file              # Краткая версия
└── data_room: folder            # Папка Data Room
```

---

### 1.2 БЛОК DESIGN (Проектирование)

**1. Концепция (Concept)**
```
ВХОДЫ:
├── tep: object                  # ТЭП от INVEST
├── site_geo: GeoJSON            # Границы участка
├── style: enum                  # Архитектурный стиль
├── target_audience: string      # Целевая аудитория
└── reference_images: array      # Референсы

ВЫХОДЫ:
├── concept_document: file       # Концепция PDF
├── massing_3d: file             # 3D массинг
├── renders: array               # Визуализации
├── functional_scheme: file      # Функциональная схема
└── preliminary_tep: object      # Уточнённые ТЭП
```

**2. Генплан (Master Plan)**
```
ВХОДЫ:
├── concept: bundle              # От "Концепция"
├── site_geo: GeoJSON            # Границы участка
├── utilities_data: object       # Данные по сетям
└── transport_data: object       # Транспортная ситуация

ВЫХОДЫ:
├── master_plan_dwg: file        # Генплан DWG
├── master_plan_pdf: file        # Генплан PDF
├── roads_scheme: file           # Схема проездов
├── parking_scheme: file         # Схема паркинга
├── landscaping_scheme: file     # Схема благоустройства
└── site_tep: object             # ТЭП площадки
```

**3. Архитектура (Architecture)**
```
ВХОДЫ:
├── master_plan: bundle          # От "Генплан"
├── building_type: enum          # Тип здания
├── floors: number               # Этажность
└── unit_mix: object             # Квартирография

ВЫХОДЫ:
├── floor_plans: array           # Планы этажей DWG
├── facades: array               # Фасады
├── sections: array              # Разрезы
├── 3d_model: file               # Модель BIM
├── unit_layouts: array          # Планировки квартир
└── architecture_tep: object     # ТЭП здания
```

**4. Конструктив (Structure)**
```
ВХОДЫ:
├── architecture: bundle         # От "Архитектура"
├── geology_report: file         # Геология
├── structural_system: enum      # Тип конструктива
└── loads: object                # Нагрузки

ВЫХОДЫ:
├── structural_scheme: file      # Конструктивная схема
├── foundation_plan: file        # План фундаментов
├── reinforcement: array         # Армирование
├── structural_calcs: file       # Расчёты
└── structure_bom: object        # Ведомость материалов
```

**5. Инженерия (Engineering)**
```
ВХОДЫ:
├── architecture: bundle         # От "Архитектура"
├── structure: bundle            # От "Конструктив"
├── utility_connections: object  # Точки подключения
└── climate_data: object         # Климатические данные

ВЫХОДЫ:
├── hvac_scheme: file            # Схема ОВиК
├── electrical_scheme: file      # Электрика
├── plumbing_scheme: file        # Водоснабжение
├── fire_safety: file            # Пожарная безопасность
├── bim_mep: file                # BIM модель сетей
└── engineering_bom: object      # Ведомость оборудования
```

**6. Экспертиза (Expertise)**
```
ВХОДЫ:
├── all_sections: bundle         # Все разделы проекта
├── permit_docs: array           # Разрешительная документация
└── expertise_type: enum         # Тип экспертизы

ВЫХОДЫ:
├── expertise_conclusion: file   # Заключение экспертизы
├── remarks: array               # Замечания
├── approval_status: boolean     # Статус одобрения
└── corrected_docs: array        # Исправленные документы
```

---

### 1.3 БЛОК BUILD (Строительство)

**1. Смета (Estimate)**
```
ВХОДЫ:
├── design_docs: bundle          # Проектная документация
├── bom_materials: object        # Ведомости материалов
├── price_database: reference    # База расценок
└── region: string               # Регион строительства

ВЫХОДЫ:
├── estimate_total: number       # Общая стоимость
├── estimate_breakdown: object   # Разбивка по разделам
├── materials_list: array        # Список материалов
├── labor_cost: number           # Стоимость работ
├── estimate_file: file          # Смета Excel
└── abc_analysis: object         # ABC анализ затрат
```

**2. Календарный план (Schedule)**
```
ВХОДЫ:
├── estimate: bundle             # От "Смета"
├── start_date: date             # Дата начала
├── resources: object            # Доступные ресурсы
└── constraints: array           # Ограничения

ВЫХОДЫ:
├── gantt_chart: file            # Диаграмма Ганта
├── critical_path: array         # Критический путь
├── milestones: array            # Вехи проекта
├── resource_plan: object        # План ресурсов
├── finish_date: date            # Дата завершения
└── schedule_file: file          # MS Project / Primavera
```

**3. Закупки (Procurement)**
```
ВХОДЫ:
├── materials_list: array        # От "Смета"
├── schedule: bundle             # От "Календарный план"
├── supplier_database: reference # База поставщиков
└── budget: number               # Бюджет на закупки

ВЫХОДЫ:
├── purchase_orders: array       # Заказы поставщикам
├── delivery_schedule: object    # График поставок
├── supplier_contracts: array    # Договоры
├── savings_report: object       # Отчёт об экономии
└── procurement_plan: file       # План закупок
```

**4. Контроль строительства (Construction Control)**
```
ВХОДЫ:
├── schedule: bundle             # Плановый график
├── actual_progress: object      # Фактический прогресс
├── quality_reports: array       # Отчёты по качеству
└── photo_reports: array         # Фотоотчёты

ВЫХОДЫ:
├── deviation_report: object     # Отклонения план/факт
├── spi: number                  # Индекс выполнения сроков
├── cpi: number                  # Индекс выполнения бюджета
├── issues: array                # Проблемы/риски
├── forecast_completion: date    # Прогноз завершения
└── control_dashboard: object    # Дашборд контроля
```

**5. Приёмка (Acceptance)**
```
ВХОДЫ:
├── as_built_docs: bundle        # Исполнительная документация
├── quality_certificates: array  # Сертификаты качества
├── test_reports: array          # Протоколы испытаний
└── inspection_results: array    # Результаты осмотров

ВЫХОДЫ:
├── acceptance_acts: array       # Акты приёмки
├── defects_list: array          # Ведомость дефектов
├── commissioning_cert: file     # Разрешение на ввод
├── warranty_docs: array         # Гарантийные документы
└── handover_package: folder     # Пакет документов
```

---

### 1.4 БЛОК SALES (Продажи)

**1. Ценообразование (Pricing)**
```
ВХОДЫ:
├── unit_layouts: array          # Планировки от DESIGN
├── market_analysis: bundle      # Анализ рынка от INVEST
├── construction_cost: number    # Себестоимость от BUILD
└── margin_target: number        # Целевая маржа

ВЫХОДЫ:
├── price_matrix: object         # Ценовая матрица
├── price_per_unit: array        # Цены по квартирам
├── floor_coefficients: object   # Коэффициенты этажей
├── view_premiums: object        # Премии за вид
├── pricing_strategy: file       # Стратегия ценообразования
└── revenue_forecast: number     # Прогноз выручки
```

**2. Маркетинг (Marketing)**
```
ВХОДЫ:
├── project_info: bundle         # Информация о проекте
├── renders: array               # Визуализации от DESIGN
├── target_audience: object      # Целевая аудитория
└── budget: number               # Маркетинговый бюджет

ВЫХОДЫ:
├── marketing_strategy: file     # Маркетинговая стратегия
├── brand_book: file             # Брендбук проекта
├── advertising_materials: array # Рекламные материалы
├── media_plan: object           # Медиаплан
├── website_content: folder      # Контент для сайта
└── sales_office_design: file    # Дизайн офиса продаж
```

**3. CRM и продажи (CRM & Sales)**
```
ВХОДЫ:
├── leads: array                 # Входящие лиды
├── price_matrix: object         # Ценовая матрица
├── available_units: array       # Доступные квартиры
└── sales_team: array            # Команда продаж

ВЫХОДЫ:
├── deals_funnel: object         # Воронка продаж
├── conversion_rate: number      # Конверсия
├── sales_velocity: number       # Скорость продаж
├── client_database: object      # База клиентов
├── sales_forecast: object       # Прогноз продаж
└── commission_report: object    # Отчёт по комиссиям
```

**4. Документооборот (Documentation)**
```
ВХОДЫ:
├── client_info: object          # Данные клиента
├── unit_info: object            # Данные квартиры
├── payment_terms: object        # Условия оплаты
└── document_templates: array    # Шаблоны документов

ВЫХОДЫ:
├── ddu_contract: file           # ДДУ (PDF)
├── payment_schedule: object     # График платежей
├── booking_agreement: file      # Договор бронирования
├── mortgage_docs: array         # Документы для ипотеки
├── registration_docs: array     # Документы для регистрации
└── handover_act: file           # Акт приёма-передачи
```

---

## ЧАСТЬ 2: ТИПЫ ДАННЫХ И ПОРТОВ

### 2.1 Базовые типы данных

| Тип | TypeScript | Цвет порта | Форма | Описание |
|-----|------------|------------|-------|----------|
| `string` | `string` | `#FFD93D` жёлтый | ● круг | Текст |
| `number` | `number` | `#4ECDC4` бирюзовый | ● круг | Число |
| `boolean` | `boolean` | `#FFFFFF` белый | ● круг | Да/Нет |
| `date` | `Date` | `#9B59B6` фиолетовый | ● круг | Дата |
| `file` | `File` | `#6BCB77` зелёный | ■ квадрат | Файл |
| `array` | `T[]` | `#3498DB` синий | ● круг | Массив |
| `object` | `object` | `#E74C3C` красный | ◆ ромб | Объект |
| `GeoJSON` | `GeoJSON` | `#1ABC9C` морской | ◆ ромб | Геоданные |
| `bundle` | `Bundle` | `#FF6B6B` коралловый | ◆ ромб | Комплекс данных |
| `reference` | `Reference` | `#95A5A6` серый | ○ кольцо | Ссылка на базу |

### 2.2 Правила соединения портов

```
Bundle (◆) → принимает ЛЮБОЙ тип
GeoJSON (◆) ↔ GeoJSON (◆)
object (◆) ↔ object (◆), bundle (◆)
file (■) ↔ file (■)
array (●) ↔ array (●) того же подтипа
number (●) ↔ number (●)
string (●) ↔ string (●)
date (●) ↔ date (●), string (●)
reference (○) → НЕ соединяется (только выбор из списка)
```

---

## ЧАСТЬ 3: СВЯЗИ МЕЖДУ БЛОКАМИ

### 3.1 Типичный поток данных

```
INVEST                    DESIGN                    BUILD                     SALES
───────────────────────────────────────────────────────────────────────────────────────

[Анализ участка]
     │
     ├─── geo_json ──────▶ [Концепция]
     │                          │
[Градоанализ]                   │
     │                          ├─── concept ──────▶ [Генплан]
     ├─── tep ──────────────────┘                        │
     │                                                   │
[Анализ рынка]                                          ├─── master_plan ──▶ [Архитектура]
     │                                                   │                        │
     ├─── prices ─────────────────────────────────────────────────────────────────┼──▶ [Ценообразование]
     │                                                                            │
[Финмодель]                                            [Смета] ◀─── design_docs ──┘
     │                                                    │
     └─── budget ─────────────────────────────────────────┼──▶ [Закупки]
                                                          │
                                                   [Календарный план]
                                                          │
                                                   [Контроль] ──▶ [Приёмка]
                                                                      │
                                                               [Документооборот] ◀──┘
```

### 3.2 Автоматические связи из 3D сцены

Когда пользователь создаёт задачу в 3D:
1. Задача появляется как точка в облаке
2. Автоматически создаётся нода в Node Editor
3. Связи между точками в 3D = связи между нодами
4. При выборе точки — подсвечивается нода и наоборот

---

## ЧАСТЬ 4: ЧЕКЛИСТ РЕАЛИЗАЦИИ

### Этап 1: Базовая структура (UI)
- [ ] Node Editor панель снизу (не модалка)
- [ ] Resize handle для панели
- [ ] SVG иконки в icon-bar
- [ ] Side panel при клике на иконку
- [ ] Голосовой ввод (Web Speech API)

### Этап 2: Система нод
- [ ] Базовый класс Node с портами
- [ ] Типы портов с цветами и формами
- [ ] Drag & drop нод
- [ ] Zoom/Pan холста нод

### Этап 3: Соединения
- [ ] Bezier curves между портами
- [ ] Проверка совместимости типов
- [ ] Анимация потока данных
- [ ] Удаление соединений

### Этап 4: Библиотека нод
- [ ] Ноды блока INVEST (6 штук)
- [ ] Ноды блока DESIGN (6 штук)
- [ ] Ноды блока BUILD (5 штук)
- [ ] Ноды блока SALES (4 штуки)

### Этап 5: Интеграция
- [ ] Синхронизация 3D точек ↔ нод
- [ ] Правая панель с деталями ноды
- [ ] Выполнение ноды (запуск агента)
- [ ] Экспорт результатов

---

## ЧАСТЬ 5: ФАЙЛОВАЯ СТРУКТУРА

```
web_platform_v2/frontend/
├── index_v3.10.html          # Основной файл (всё в одном)
├── index_v3.9.html           # Бэкап рабочей версии
└── index_v3.9_backup.html    # Резервная копия

docs/design/
├── NODE_EDITOR_ARCHITECTURE.md   # Архитектура (уже есть)
├── V3.10_IMPLEMENTATION_PLAN.md  # Этот план
└── GEMINI_MAKE_V3.10.md          # Инструкции для Gemini
```

---

*План создан: 2026-02-04*
*Автор: Claude Code*
