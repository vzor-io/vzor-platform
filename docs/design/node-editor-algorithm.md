# Node Editor: Полный алгоритм работы

> Документ для реализации. Совмещает математическую логику Grasshopper + UX удобство Blender + специфику девелопмента.

---

## 1. Концепция

**Два режима работы:**
1. **БЫСТРЫЙ** — выбрал блок, отметил задачи, система всё настроила автоматически
2. **РУЧНОЙ** — добавляешь ноды, настраиваешь, соединяешь проводами

**Принцип:** Grasshopper (data flow, логика) + Blender (UX, эргономика)

---

## 2. Уровни интерфейса

### Уровень 1: Выбор блока

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│   [+ ДОБАВИТЬ БЛОК]                                             │
│                                                                  │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│   │ 📊 ИНВЕСТ-      │  │ 📐 ПРОЕКТИ-     │  │ 🏗️ СТРОИ-       │ │
│   │    АНАЛИЗ       │  │    РОВАНИЕ      │  │    ТЕЛЬСТВО     │ │
│   │ 9 задач         │  │ 7 задач         │  │ 6 задач         │ │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                  │
│   ┌─────────────────┐  ┌─────────────────┐                      │
│   │ 💰 ПРОДАЖИ      │  │ ➕ СВОЙ БЛОК    │                      │
│   │ 4 задачи        │  │                 │                      │
│   └─────────────────┘  └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

### Уровень 2: Выбор задач из шаблона

После клика на блок — раскрывается список с чекбоксами:

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 ИНВЕСТ-АНАЛИЗ                                    [Свернуть] │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Выберите задачи для проекта:                                   │
│                                                                  │
│  ☑️ Градостроительный анализ          [⚙️]                      │
│  ☑️ Анализ локации                    [⚙️]                      │
│  ☑️ Анализ конкурентов                [⚙️]                      │
│  ☑️ Маркетинговый анализ              [⚙️]                      │
│  ☑️ ТЭО                               [⚙️]                      │
│  ☑️ Финансовая модель                 [⚙️]                      │
│  ☐ SWOT-анализ                        [⚙️]                      │
│  ☐ Оценка рисков                      [⚙️]                      │
│  ☑️ Инвестиционное заключение         [⚙️]                      │
│                                                                  │
│  [+ Добавить свою задачу]                                       │
│                                                                  │
│  [✓ Выбрать все]  [✗ Снять все]  [▶ СОЗДАТЬ ГРАФ]              │
└─────────────────────────────────────────────────────────────────┘
```

### Уровень 3: Настройка задачи (⚙️)

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚙️ НАСТРОЙКА: Градостроительный анализ                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  📥 ВХОДНЫЕ ДАННЫЕ                                              │
│  ├─ Кадастровый номер:  [_____________________]                │
│  ├─ Адрес:              [_____________________]                │
│  └─ Площадь участка:    [____] га                              │
│                                                                  │
│  📚 БАЗА ЗНАНИЙ                        [▼ Выбрать]              │
│  ☑️ ПЗЗ региона                                                │
│  ☑️ СП 42.13330                                                │
│  ☐ МГСН                                                        │
│  [+ Добавить свой документ]                                     │
│                                                                  │
│  📐 МЕТОДОЛОГИЯ                        [▼ Выбрать]              │
│  ○ Стандартный анализ                                          │
│  ● Расширенный (с SWOT)                                        │
│  ○ Экспресс                                                     │
│                                                                  │
│  🤖 АГЕНТ                              [▼ Выбрать]              │
│  ● Analyst (DeepSeek R1) — рекомендуется                       │
│  ○ Analyst (GPT-4)                                              │
│  ○ Analyst (Claude)                                             │
│                                                                  │
│  📤 ФОРМАТ ВЫХОДА                                               │
│  ☑️ PDF отчёт                                                  │
│  ☑️ Excel таблица                                              │
│  ☑️ JSON (для следующей задачи)                                │
│                                                                  │
│  [Отмена]                                    [💾 Сохранить]     │
└─────────────────────────────────────────────────────────────────┘
```

### Уровень 4: Созданный граф

После "СОЗДАТЬ ГРАФ" — появляется граф нод со связями:

```
┌───────────┐    ┌───────────┐    ┌───────────┐
│ Градостр. │───▶│ Анализ    │───▶│ Анализ    │
│ анализ    │    │ локации   │    │ конкурент.│
└───────────┘    └───────────┘    └─────┬─────┘
                                        │
                                        ▼
                 ┌───────────┐    ┌───────────┐
                 │ Маркетинг │◀───│    ТЭО    │
                 │ анализ    │    │           │
                 └─────┬─────┘    └─────┬─────┘
                       │                │
                       ▼                │
                 ┌───────────┐          │
                 │ Финансовая│◀─────────┘
                 │ модель    │
                 └─────┬─────┘
                       │
                       ▼
                 ┌───────────┐
                 │ Инвест.   │
                 │ заключение│
                 └───────────┘

[▶ ВЫПОЛНИТЬ ВСЁ]  [⏸ ПАУЗА]  [📊 ОТЧЁТ]
```

---

## 3. Визуальный дизайн ноды

### Структура ноды

```
┌─────────────────────────────────────┐
│  Градостроительный анализ       ▼   │  ← заголовок + кнопка раскрытия
├─────────────────────────────────────┤
│                                     │
│  База знаний:   [ПЗЗ, СНиП    ▼]   │  ← выпадающий список
│  Методология:   [Расширенный  ▼]   │  ← выпадающий список
│  Агент:         [Analyst      ▼]   │  ← выпадающий список
│                                     │
├─────────────────────────────────────┤
│  📄 report.pdf                      │  ← превью результата (когда done)
│  "Макс. этажность: 25..."           │
├─────────────────────────────────────┤
│  [▶ Выполнить]         [ГОТОВО ✓]  │  ← статус
└─────────────────────────────────────┘
```

### Сокеты (входы/выходы)

**Слева (входы):**
- ● Жёлтый = данные от предыдущей задачи
- ● Голубой = база знаний (если подключается внешняя)
- ● Фиолетовый = методология (если подключается внешняя)

**Справа (выходы):**
- ● Зелёный = результат (документ)
- ● Жёлтый = данные (JSON для следующей ноды)

### Цвета состояний

| Рамка/фон | Состояние |
|-----------|-----------|
| Серый | Ожидание |
| Оранжевый | Warning (не все входы) |
| Красный | Ошибка |
| Синий + пульсация | Выполняется |
| Зелёный | Готово |
| Бирюзовый | Выбрано |

---

## 4. Типовые задачи (шаблоны)

### 📊 ИНВЕСТ-АНАЛИЗ

| Задача | База знаний | Методология | Выход |
|--------|-------------|-------------|-------|
| Градостроительный анализ | ПЗЗ, СНиПы, ГПЗУ | Анализ ограничений | PDF отчёт |
| Анализ локации | Карты, 2ГИС, POI | Scoring локации | Карта + отчёт |
| Анализ конкурентов | База объектов | Сравнительный | Таблица Excel |
| Маркетинговый анализ | Данные продаж | Аналитика спроса | Отчёт |
| ТЭО | Нормативы затрат | Расчётная модель | Excel |
| Финансовая модель | — | DCF/NPV/IRR | Excel |
| SWOT-анализ | — | SWOT framework | Матрица |
| Оценка рисков | Риск-матрица | Scoring рисков | Карта рисков |
| Инвест. заключение | — | Сводка | GO/NO-GO |

### 📐 ПРОЕКТИРОВАНИЕ

| Задача | База знаний | Методология | Выход |
|--------|-------------|-------------|-------|
| Концепция | Референсы | Generative | 3D + описание |
| Архитектура (АР) | СНиПы | BIM | Чертежи |
| Конструктив (КР) | СП | Расчёт | Чертежи |
| Инженерия (ИОС) | Нормы | Расчёт | Схемы |
| Сети | ТУ | Согласование | Документы |
| Экспертиза | Требования | Проверка | Заключение |
| РнС | Регламент | Оформление | Разрешение |

### 🏗️ СТРОИТЕЛЬСТВО

| Задача | База знаний | Методология | Выход |
|--------|-------------|-------------|-------|
| Выбор подрядчика | База подрядчиков | Тендер | Договор |
| Смета | ГЭСН, ТЕР | Сметный расчёт | Excel |
| Технадзор | Нормы качества | Контроль | Акты |
| Контроль качества | СНиПы | Проверка | Отчёты |
| Снабжение | База поставщиков | Закупки | Заказы |
| Отчётность | Формы | Формирование | Отчёты |

### 💰 ПРОДАЖИ

| Задача | База знаний | Методология | Выход |
|--------|-------------|-------------|-------|
| Маркетинг стратегия | Рынок | Позиционирование | Стратегия |
| ДДУ/Договоры | Шаблоны, закон | Юр. проверка | Документы |
| CRM | — | Автоматизация | Настройка |
| Сервис | Стандарты | УК | Регламенты |

---

## 5. Связи между задачами (автоматические)

При создании графа система автоматически строит связи:

```
Градостроительный анализ
    │
    ├──▶ Анализ локации
    │         │
    │         ├──▶ Анализ конкурентов
    │         │         │
    │         │         ▼
    │         │    Маркетинговый анализ
    │         │         │
    │         ▼         │
    │       ТЭО ◀───────┘
    │         │
    │         ▼
    └──▶ Финансовая модель
              │
              ▼
         Инвест. заключение
```

**Логика связей:** результат задачи A нужен как вход для задачи B.

---

## 6. UX: Добавление входов

### Вариант A: Выпадающий список внутри ноды (основной)
```
База знаний: [ПЗЗ     ▼]
             ├─ ПЗЗ Москвы
             ├─ СП 42.13330
             ├─ МГСН
             └─ + Добавить свой...
```

### Вариант B: Провод (для нестандартных случаев)
```
Тянешь провод от выхода ноды "База знаний" →
Подключаешь к входу ноды "Задача" →
Готово
```

### Рекомендация
**Используем оба:**
- Выпадающие списки — для быстрого выбора из готовых вариантов
- Провода — для передачи данных между нодами и нестандартных подключений

---

## 7. Процесс выполнения

### Шаг 1: Создание структуры
```
Пользователь: "Инвест-анализ, участок 77:01:0001234:567"
     │
     ▼
Agent Zero создаёт граф задач (превью)
     │
     ▼
Пользователь проверяет, корректирует если нужно
     │
     ▼
"СОЗДАТЬ ГРАФ"
```

### Шаг 2: Выполнение
```
"ВЫПОЛНИТЬ ВСЁ"
     │
     ▼
Задачи выполняются последовательно по зависимостям:
  1. Градостр. анализ [████████░░] 80%
  2. Анализ локации   [░░░░░░░░░░] ожидание
  ...
     │
     ▼
Все задачи выполнены → формируется сводный отчёт
```

---

## 8. Технические требования

### Frontend
- Canvas для рисования нод и проводов
- Drag & drop нод
- Zoom / pan
- Контекстное меню (ПКМ)
- Синхронизация с 3D графом через единый store

### Backend
- WebSocket для real-time прогресса
- Очередь задач
- Сохранение состояния графа
- API для агентов

### Данные
```typescript
interface Task {
  id: string;
  name: string;
  block: 'invest' | 'design' | 'build' | 'sales';

  // Настройки
  knowledge: string[];  // IDs баз знаний
  methodology: string;  // ID методологии
  agent: string;        // ID агента

  // Входы/Выходы
  inputs: Connection[];
  outputs: Connection[];

  // Состояние
  status: 'pending' | 'running' | 'done' | 'error';
  progress: number;     // 0-100
  result?: TaskResult;

  // Позиция на canvas
  position: { x: number; y: number };
}
```

---

*Создано: 2025-02-01*
