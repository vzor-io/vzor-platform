# Архитектура Node Editor для VZOR

> **Цель:** Создать систему визуального программирования для управления задачами девелопмента.
> **Референсы:** Grasshopper (90%) + Blender Geometry Nodes (10%)

---

## 1. ПАНЕЛЬ NODE EDITOR

### Текущая проблема (скриншот 121)
- Окно появляется как модалка по центру
- Нельзя изменить размер
- Блокирует работу с 3D сценой

### Правильное решение: ВЫДВИЖНАЯ ПАНЕЛЬ СНИЗУ

```
┌─────────────────────────────────────────────────────────────────┐
│                         3D СЦЕНА                                │
│                    (облако точек)                               │
│                                                                 │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤  ← Ручка для resize
│ NODE EDITOR                                            [−] [×]  │
│ ┌─────────┐    ┌─────────┐    ┌─────────┐                      │
│ │  Нода 1 │───▶│  Нода 2 │───▶│  Нода 3 │                      │
│ └─────────┘    └─────────┘    └─────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

**Поведение:**
1. По умолчанию скрыта (высота = 0)
2. Клик на "Nodes" → выезжает снизу (высота = 30% экрана)
3. Пользователь тянет за верхнюю границу → resize от 20% до 80%
4. 3D сцена сжимается пропорционально (НЕ деформируется!)
5. Двойной клик на границу → развернуть на 50%

```css
#node-editor-panel {
    position: fixed;
    bottom: 0;
    left: 48px;  /* После icon-bar */
    right: 0;
    height: 0;
    background: #0a0a0a;
    border-top: 1px solid rgba(255,255,255,0.15);
    transition: height 0.3s ease;
    z-index: 100;
}

#node-editor-panel.open {
    height: 35vh;  /* Начальная высота */
}

#node-editor-resize-handle {
    position: absolute;
    top: -5px;
    left: 0;
    right: 0;
    height: 10px;
    cursor: ns-resize;
    background: transparent;
}

#node-editor-resize-handle:hover {
    background: rgba(78, 205, 196, 0.3);
}
```

---

## 2. ТИПЫ НОД ПО БЛОКАМ

### Блок: INVEST (Инвестиционный анализ)

| Нода | Входы | Выходы | Описание |
|------|-------|--------|----------|
| **Кадастр** | адрес / кадастровый номер | GeoJSON, площадь, ВРИ | Получить данные участка |
| **ПЗЗ Анализ** | GeoJSON участка | ТЭПы (этажность, плотность) | Градостроительные ограничения |
| **Конкуренты** | координаты, радиус | список объектов, цены | Анализ рынка |
| **Финмодель** | ТЭПы, цены, затраты | NPV, IRR, срок окупаемости | Расчёт экономики |
| **Отчёт Invest** | все данные выше | PDF, Excel | Сводный отчёт |

### Блок: DESIGN (Проектирование)

| Нода | Входы | Выходы | Описание |
|------|-------|--------|----------|
| **Мастер-план** | GeoJSON, ТЭПы | схема застройки | Генплан |
| **Архитектура** | мастер-план, стиль | 3D модель, визуализации | АР решения |
| **Конструктив** | архитектура | чертежи КР | Конструкции |
| **Инженерия** | архитектура | схемы ИОС | Сети |
| **Экспертиза** | все разделы | заключение | Проверка |

### Блок: BUILD (Строительство)

| Нода | Входы | Выходы | Описание |
|------|-------|--------|----------|
| **Смета** | проект | стоимость, материалы | Расчёт затрат |
| **График** | смета, ресурсы | Gantt диаграмма | Календарный план |
| **Закупки** | смета | заказы поставщикам | Снабжение |
| **Контроль** | факт, план | отклонения | Мониторинг |

### Блок: SALES (Продажи)

| Нода | Входы | Выходы | Описание |
|------|-------|--------|----------|
| **Прайс** | квартирография, рынок | ценовая матрица | Ценообразование |
| **ДДУ** | клиент, квартира | договор PDF | Документы |
| **CRM** | лиды | воронка продаж | Аналитика |
| **Маркетинг** | объект, ЦА | рекламные материалы | Продвижение |

---

## 3. СТРУКТУРА НОДЫ (Grasshopper стиль)

```
┌──────────────────────────────────────────────────────────────┐
│ ● ФИНАНСОВАЯ МОДЕЛЬ                              [▼] [?] [×] │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ВХОДЫ                                           ВЫХОДЫ      │
│  ─────                                           ──────      │
│                                                              │
│  ◆ ТЭПы ─────────────┐                                       │
│                      │         ┌──────────────▶ ● NPV        │
│  ● Цены продажи ─────┼────────▶│   РАСЧЁТ    │               │
│                      │         │             ├──▶ ● IRR      │
│  ● Затраты ──────────┤         │             │               │
│                      │         └─────────────┴──▶ ● Срок     │
│  ● Ставка ───────────┘                                       │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│  ПАРАМЕТРЫ                                                   │
│  ──────────                                                  │
│  Период расчёта:  [10 лет     ▼]                            │
│  Шаг дисконта:    [квартал    ▼]                            │
│  Инфляция:        [  8.5  ] %                                │
├──────────────────────────────────────────────────────────────┤
│  АГЕНТ                                                       │
│  ──────                                                      │
│  [Economist Agent ▼]    База: [VZOR Finance ▼]              │
├──────────────────────────────────────────────────────────────┤
│  [▶ ВЫПОЛНИТЬ]                              Статус: Готов ● │
└──────────────────────────────────────────────────────────────┘
```

### Типы сокетов (входов/выходов)

| Тип | Иконка | Цвет | Описание |
|-----|--------|------|----------|
| **Bundle** | ◆ ромб | `#FF6B6B` красный | Комплексные данные (весь контекст) |
| **Number** | ● круг | `#4ECDC4` бирюзовый | Числовые значения |
| **Text** | ● круг | `#FFD93D` жёлтый | Текстовые данные |
| **File** | ■ квадрат | `#6BCB77` зелёный | Файлы (PDF, Excel, JSON) |
| **Geo** | ◆ ромб | `#9B59B6` фиолетовый | Геоданные (GeoJSON, координаты) |
| **Table** | ▬ прямоугольник | `#3498DB` синий | Таблицы (DataFrame) |

---

## 4. СОЕДИНЕНИЯ МЕЖДУ НОДАМИ

### Визуальный стиль (как в Grasshopper)

```css
.node-connection {
    stroke: rgba(255, 255, 255, 0.4);
    stroke-width: 2;
    fill: none;
    /* Bezier curve */
}

.node-connection:hover {
    stroke: #4ECDC4;
    stroke-width: 3;
}

.node-connection.active {
    stroke: #4ECDC4;
    stroke-width: 2;
    /* Анимация потока данных */
    stroke-dasharray: 10 5;
    animation: flowAnimation 1s linear infinite;
}

@keyframes flowAnimation {
    to { stroke-dashoffset: -15; }
}
```

### Логика соединения

1. Клик на выходной сокет → начать провод
2. Перетащить к входному сокету совместимого типа
3. Если типы совместимы → соединить (провод фиксируется)
4. Если несовместимы → провод красный, не соединяется

**Совместимость типов:**
- Bundle → принимает любой тип
- Number ↔ Number
- Text ↔ Text
- File → File (с проверкой формата)
- Geo → Geo
- Table → Table, File

---

## 5. ФОРМАТЫ ВЫВОДА

### Нода "Экспорт"

```
┌────────────────────────────────────────────┐
│ ● ЭКСПОРТ ОТЧЁТА                      [×]  │
├────────────────────────────────────────────┤
│                                            │
│  ◆ Данные ──────────┐                      │
│                     │                      │
│                     ▼                      │
│            ┌───────────────┐               │
│            │   ФОРМАТ:     │               │
│            │ ○ PDF         │               │
│            │ ● Excel       │               │
│            │ ○ JSON        │               │
│            │ ○ CSV         │               │
│            │ ○ Word        │               │
│            └───────────────┘               │
│                     │                      │
│                     ▼                      │
│              ■ Файл ────────────▶          │
│                                            │
│  [💾 СОХРАНИТЬ]        [📤 ОТПРАВИТЬ]      │
└────────────────────────────────────────────┘
```

### Превью результата

При наведении на выходной сокет → tooltip с превью:

```
┌─────────────────────────────────┐
│  📊 NPV Preview                 │
│  ───────────────                │
│  Значение: 245,000,000 ₽       │
│  Период: 10 лет                │
│  Уверенность: 87%              │
│                                 │
│  [Открыть полный отчёт →]      │
└─────────────────────────────────┘
```

---

## 6. ЛЕВАЯ ПАНЕЛЬ ИКОНОК (Icon Bar)

### Текущая проблема (скриншот 123)
- Иконки-эмодзи выглядят "из 90-х"
- Непонятное назначение

### Правильный дизайн: Хай-тек стиль

```css
.icon-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    background: transparent;
    border: 1px solid transparent;
    transition: all 0.2s ease;

    /* Хай-тек иконка */
    color: rgba(255, 255, 255, 0.4);
    font-size: 16px;
}

.icon-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
}

.icon-btn.active {
    background: rgba(78, 205, 196, 0.1);
    border-color: rgba(78, 205, 196, 0.3);
    color: #4ECDC4;
    box-shadow: 0 0 10px rgba(78, 205, 196, 0.2);
}
```

### Назначение иконок

| Позиция | Иконка | Название | Функция |
|---------|--------|----------|---------|
| 1 | 📊 → `<svg>` | Invest | Открыть панель задач блока Invest |
| 2 | 📐 → `<svg>` | Design | Открыть панель задач блока Design |
| 3 | 🏗 → `<svg>` | Build | Открыть панель задач блока Build |
| 4 | 💰 → `<svg>` | Sales | Открыть панель задач блока Sales |
| --- | разделитель | --- | --- |
| 5 | 📁 → `<svg>` | Files | Файловый менеджер проекта |
| (внизу) | ⚙ → `<svg>` | Settings | Настройки |

**SVG иконки (хай-тек стиль):**

```html
<!-- Invest -->
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path d="M3 3v18h18"/>
    <path d="M7 14l4-4 4 4 5-5"/>
</svg>

<!-- Design -->
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path d="M3 21h18"/>
    <path d="M5 21V7l7-4 7 4v14"/>
    <path d="M9 21v-6h6v6"/>
</svg>

<!-- Build -->
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <rect x="2" y="6" width="20" height="15" rx="2"/>
    <path d="M12 2v4M7 10h2M15 10h2"/>
</svg>

<!-- Sales -->
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <circle cx="12" cy="12" r="10"/>
    <path d="M12 6v6l4 2"/>
</svg>
```

---

## 7. ПРИМЕР WORKFLOW: ИНВЕСТ-АНАЛИЗ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  КАДАСТР    │     │  ПЗЗ АНАЛИЗ │     │ КОНКУРЕНТЫ  │
│             │     │             │     │             │
│ [Номер]─────┼────▶│ GeoJSON ────┼──┐  │ [Радиус]────┤
│             │     │             │  │  │             │
│      ●──────┼──┐  │      ●──────┼──┼─▶│      ●──────┤
│   GeoJSON   │  │  │    ТЭПы     │  │  │   Цены      │
└─────────────┘  │  └─────────────┘  │  └──────┬──────┘
                 │                   │         │
                 │  ┌────────────────┘         │
                 │  │                          │
                 ▼  ▼                          ▼
            ┌─────────────────────────────────────┐
            │         ФИНАНСОВАЯ МОДЕЛЬ           │
            │                                     │
            │  ◆ ТЭПы                             │
            │  ● Цены ─────────────▶ ● NPV        │
            │  ● Затраты                          │
            │                      ▶ ● IRR        │
            │                                     │
            │                      ▶ ● Срок       │
            └──────────────┬──────────────────────┘
                           │
                           ▼
            ┌─────────────────────────────────────┐
            │           ЭКСПОРТ ОТЧЁТА            │
            │                                     │
            │  ◆ Данные                           │
            │              ────────▶ ■ PDF        │
            │                                     │
            │  [💾 СОХРАНИТЬ]                     │
            └─────────────────────────────────────┘
```

---

## 8. ИНТЕГРАЦИЯ С 3D СЦЕНОЙ

### Синхронизация точка ↔ нода

```javascript
// При клике на точку в 3D
function onPointClick(taskId) {
    // 1. Выделить ноду в Node Editor
    highlightNode(taskId);

    // 2. Центрировать вид на ноду
    panToNode(taskId);

    // 3. Открыть панель если закрыта
    if (!nodeEditorOpen) openNodeEditor();
}

// При клике на ноду в Node Editor
function onNodeClick(taskId) {
    // 1. Выделить точку в 3D
    highlightPoint3D(taskId);

    // 2. Открыть правую панель с деталями
    showDetailPanel(taskId);
}
```

---

## 9. ГОЛОСОВОЙ ВВОД

### Текущая проблема
Голосовой ввод не работает в v3.9

### Решение

```javascript
// Web Speech API
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'ru-RU';
recognition.continuous = false;

const micBtn = document.getElementById('mic-btn');
let isListening = false;

micBtn.addEventListener('click', () => {
    if (isListening) {
        recognition.stop();
        micBtn.classList.remove('listening');
        isListening = false;
    } else {
        recognition.start();
        micBtn.classList.add('listening');
        isListening = true;
    }
});

recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    document.getElementById('task-input').value = text;

    // Автоматически создать задачу
    createTaskFromVoice(text);
};

recognition.onend = () => {
    micBtn.classList.remove('listening');
    isListening = false;
};

recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    micBtn.classList.remove('listening');
    isListening = false;
};
```

```css
#mic-btn.listening {
    background: rgba(255, 107, 107, 0.2);
    border-color: #FF6B6B;
    animation: pulse-mic 1s infinite;
}

@keyframes pulse-mic {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
    50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
}
```

---

## РЕЗЮМЕ ЗАДАЧ ДЛЯ GEMINI

### Критические (v3.10)
1. ☐ Node Editor → выдвижная панель снизу (не модалка!)
2. ☐ Resizable панель (тянуть за верхнюю границу)
3. ☐ 3D сцена масштабируется при resize (не деформируется)
4. ☐ Исправить голосовой ввод (Web Speech API)

### Важные (v3.11)
5. ☐ Ноды с реальными входами/выходами
6. ☐ Визуальные соединения (Bezier curves)
7. ☐ Типы сокетов с цветами
8. ☐ Иконки в хай-тек стиле (SVG вместо эмодзи)

### Финальные (v3.12)
9. ☐ Библиотека нод по блокам (Invest, Design, Build, Sales)
10. ☐ Экспорт результатов (PDF, Excel)
11. ☐ Синхронизация 3D точек ↔ нод

---

*Это архитектурный документ. Gemini должен следовать этой спецификации!*
