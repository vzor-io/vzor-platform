# Полная архитектура нод VZOR

> **Документ для Gemini Pro.** Содержит полную спецификацию: как создаются задачи, как Agent Zero их подхватывает, откуда берутся данные, как происходит вычисление, где отображаются результаты.

---

## 1. Общая концепция

### 1.1 Что такое "точка" / "нода" / "задача"

Это **одна и та же сущность** в разных представлениях:

| Представление | Где видно | Что показывает |
|---------------|-----------|----------------|
| **Точка** | 3D граф (Three.js) | Позиция в пространстве, цвет статуса, связи |
| **Нода** | Node Editor (Canvas) | Входы, выходы, провода, параметры |
| **Задача** | Правая панель (React) | Полные настройки, результаты |

**Принцип:** Один источник правды (TaskStore) → три view слушают изменения.

### 1.2 Два режима работы

```
┌─────────────────────────────────────────────────────────────────┐
│  АВТОМАТИЧЕСКИЙ РЕЖИМ                                           │
│  ═══════════════════                                            │
│                                                                  │
│  Пользователь: "Инвест-анализ, участок 77:01:0001234:567"       │
│                              │                                   │
│                              ▼                                   │
│                     ┌─────────────────┐                          │
│                     │   AGENT ZERO    │                          │
│                     │                 │                          │
│                     │  1. Парсит      │                          │
│                     │  2. Создаёт     │                          │
│                     │  3. Настраивает │                          │
│                     │  4. Связывает   │                          │
│                     └────────┬────────┘                          │
│                              │                                   │
│                              ▼                                   │
│          Появляется готовый граф с настроенными задачами        │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  РУЧНОЙ РЕЖИМ (страховка)                                        │
│  ════════════════════════                                        │
│                                                                  │
│  Пользователь вручную:                                          │
│  • Добавляет ноды                                                │
│  • Настраивает параметры                                         │
│  • Соединяет проводами                                           │
│  • Запускает выполнение                                          │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. Жизненный цикл задачи

### 2.1 Создание задачи

```
ШАГИ СОЗДАНИЯ (автоматический режим):

1. ПОЛЬЗОВАТЕЛЬ вводит команду
   │
   │  "Инвест-анализ, участок 77:01:0001234:567"
   │
   ▼
2. AGENT ZERO парсит команду
   │
   │  {
   │    block: "invest",
   │    params: {
   │      cadastral: "77:01:0001234:567"
   │    }
   │  }
   │
   ▼
3. AGENT ZERO загружает ШАБЛОН блока
   │
   │  templates/invest-analysis.json
   │  → список типовых задач для инвест-анализа
   │
   ▼
4. AGENT ZERO создаёт ЗАДАЧИ
   │
   │  Для каждой задачи из шаблона:
   │  • Генерирует UUID
   │  • Назначает агента (SubAgent)
   │  • Подключает базы знаний
   │  • Устанавливает методологию
   │  • Заполняет параметры из команды
   │
   ▼
5. AGENT ZERO строит СВЯЗИ (DAG)
   │
   │  Определяет какие задачи зависят от каких
   │  Градостр. анализ → Анализ локации → ТЭО → ...
   │
   ▼
6. AGENT ZERO отправляет в STORE
   │
   │  TaskStore.setTasks(tasks, connections)
   │
   ▼
7. ВСЕ VIEWS обновляются автоматически
   │
   ├── 3D граф: появляются точки
   ├── Node Editor: появляются ноды с проводами
   └── Правая панель: готова показать детали
```

### 2.2 Структура задачи (Task)

```typescript
interface Task {
    // === ИДЕНТИФИКАЦИЯ ===
    id: string;                     // UUID — ключ связи всех views
    name: string;                   // "Градостроительный анализ"
    description?: string;           // Подробное описание
    block: BlockType;               // 'invest' | 'design' | 'build' | 'sales'

    // === КОНТЕКСТ (Bundle) ===
    context: {
        // Откуда брать данные
        knowledgeSources: KnowledgeSource[];

        // Как обрабатывать
        methodology: Methodology;

        // Входные параметры
        parameters: Record<string, any>;

        // Данные от предыдущих задач (заполняется при выполнении)
        inputData?: any;
    };

    // === ИСПОЛНИТЕЛЬ ===
    agent: {
        type: AgentType;            // 'analyst' | 'designer' | 'economist' | ...
        model: string;              // 'deepseek-r1' | 'gpt-4' | 'claude'
        systemPrompt?: string;      // Кастомный промпт (опционально)
    };

    // === ВЫХОДЫ ===
    outputs: {
        formats: OutputFormat[];    // ['pdf', 'excel', 'json']
        destination: string;        // Путь к папке результатов
    };

    // === СОСТОЯНИЕ ===
    status: TaskStatus;             // 'pending' | 'ready' | 'running' | 'done' | 'error'
    progress: number;               // 0-100
    currentStep?: string;           // "Загрузка базы знаний..."
    error?: string;                 // Текст ошибки

    // === РЕЗУЛЬТАТ (после выполнения) ===
    result?: TaskResult;

    // === ПОЗИЦИИ ===
    position2D: { x: number; y: number };      // Node Editor
    position3D: [number, number, number];      // 3D граф

    // === СВЯЗИ ===
    dependencies: string[];         // IDs задач, от которых зависит
    dependents: string[];           // IDs задач, которые зависят от этой

    // === TIMESTAMPS ===
    createdAt: number;
    startedAt?: number;
    completedAt?: number;
}
```

---

## 3. Источники данных (Knowledge Sources)

### 3.1 Типы источников

```typescript
type KnowledgeSourceType =
    | 'document'    // Локальный файл (PDF, DOCX, TXT)
    | 'api'         // Внешний API (Росреестр, 2ГИС, ...)
    | 'database'    // База данных (PostgreSQL, MongoDB)
    | 'url'         // Веб-страница
    | 'embedding'   // Векторная база (Pinecone, Chroma);

interface KnowledgeSource {
    id: string;
    name: string;                   // "ПЗЗ Москвы"
    type: KnowledgeSourceType;

    // Для document
    filePath?: string;              // "/knowledge/pzz-moscow.pdf"

    // Для api
    endpoint?: string;              // "https://rosreestr.gov.ru/api/..."
    apiKey?: string;                // Хранится в .env!
    method?: 'GET' | 'POST';
    headers?: Record<string, string>;

    // Для database
    connectionString?: string;
    query?: string;

    // Для url
    url?: string;
    selector?: string;              // CSS selector для парсинга

    // Для embedding
    collection?: string;
    similarityThreshold?: number;

    // Мета
    domain: string[];               // ['градостроительство', 'право']
    region?: string;                // 'moscow' | 'russia' | 'global'
    lastUpdated?: number;
}
```

### 3.2 Как источники подключаются к задаче

```
┌─────────────────────────────────────────────────────────────────┐
│  ШАБЛОН БЛОКА (templates/invest-analysis.json)                  │
│                                                                  │
│  {                                                               │
│    "tasks": [                                                    │
│      {                                                           │
│        "templateId": "gradostroit-analysis",                    │
│        "name": "Градостроительный анализ",                      │
│        "defaultKnowledge": [                                     │
│          "pzz-regional",       // ← ID источника               │
│          "snip-42-13330",      // ← ID источника               │
│          "gpzu-api"            // ← ID источника               │
│        ],                                                        │
│        "defaultMethodology": "extended-analysis",               │
│        "defaultAgent": "analyst"                                │
│      }                                                           │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  AGENT ZERO                                                      │
│                                                                  │
│  1. Читает шаблон                                               │
│  2. Для каждого ID источника:                                   │
│     • Загружает конфигурацию из KnowledgeRegistry               │
│     • Проверяет доступность (API ключи, файлы)                  │
│     • Если источник региональный — подставляет регион           │
│  3. Собирает финальный список sources для задачи                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  ЗАДАЧА (Task)                                                   │
│                                                                  │
│  context: {                                                      │
│    knowledgeSources: [                                          │
│      {                                                           │
│        id: "pzz-moscow",                                        │
│        name: "ПЗЗ Москвы",                                      │
│        type: "document",                                         │
│        filePath: "/knowledge/pzz/moscow-2024.pdf"               │
│      },                                                          │
│      {                                                           │
│        id: "gpzu-api",                                          │
│        name: "Росреестр ГПЗУ",                                  │
│        type: "api",                                              │
│        endpoint: "https://rosreestr.gov.ru/api/gpzu",           │
│        apiKey: "${ROSREESTR_API_KEY}"  // из .env               │
│      }                                                           │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 Реестр источников знаний

```typescript
// knowledge/registry.ts

export const KNOWLEDGE_REGISTRY: Record<string, Partial<KnowledgeSource>> = {
    // === ГРАДОСТРОИТЕЛЬСТВО ===
    'pzz-regional': {
        name: 'ПЗЗ региона',
        type: 'document',
        domain: ['градостроительство', 'право'],
        // filePath определяется по региону
    },
    'snip-42-13330': {
        name: 'СП 42.13330 Градостроительство',
        type: 'document',
        filePath: '/knowledge/snip/sp-42-13330-2016.pdf',
        domain: ['градостроительство', 'нормативы'],
    },
    'gpzu-api': {
        name: 'Росреестр ГПЗУ API',
        type: 'api',
        endpoint: 'https://rosreestr.gov.ru/api/v1/gpzu',
        method: 'GET',
        domain: ['градостроительство', 'право'],
    },

    // === АНАЛИТИКА РЫНКА ===
    '2gis-api': {
        name: '2ГИС API',
        type: 'api',
        endpoint: 'https://catalog.api.2gis.com/3.0',
        domain: ['локация', 'инфраструктура'],
    },
    'cian-parser': {
        name: 'ЦИАН парсер',
        type: 'url',
        url: 'https://www.cian.ru',
        selector: '.offer-card',
        domain: ['рынок', 'конкуренты'],
    },
    'domclick-api': {
        name: 'ДомКлик API',
        type: 'api',
        endpoint: 'https://api.domclick.ru/v1',
        domain: ['рынок', 'ипотека'],
    },

    // === НОРМАТИВЫ ===
    'gesn-database': {
        name: 'ГЭСН (сметные нормативы)',
        type: 'database',
        connectionString: '${GESN_DB_URL}',
        domain: ['строительство', 'сметы'],
    },
    'ter-regional': {
        name: 'ТЕР региона',
        type: 'database',
        domain: ['строительство', 'сметы'],
    },

    // === EMBEDDINGS (RAG) ===
    'legal-docs-rag': {
        name: 'Правовые документы (RAG)',
        type: 'embedding',
        collection: 'legal_documents',
        similarityThreshold: 0.75,
        domain: ['право'],
    },
};
```

---

## 4. Методологии

### 4.1 Что такое методология

**Методология** — это набор инструкций КАК агент должен обрабатывать данные.

```typescript
interface Methodology {
    id: string;
    name: string;                   // "DCF-анализ"
    description: string;

    // Шаги выполнения
    steps: MethodologyStep[];

    // Шаблон промпта для LLM
    promptTemplate: string;

    // Формат ожидаемого результата
    outputSchema: JSONSchema;

    // Валидация результата
    validators?: Validator[];
}

interface MethodologyStep {
    id: string;
    name: string;                   // "Сбор исходных данных"
    description: string;
    requiredInputs: string[];       // Какие данные нужны
    producedOutputs: string[];      // Что производит
}
```

### 4.2 Пример методологии

```typescript
const DCF_METHODOLOGY: Methodology = {
    id: 'dcf-analysis',
    name: 'DCF-анализ (дисконтированные денежные потоки)',
    description: 'Оценка инвестиционной привлекательности через NPV, IRR, DPP',

    steps: [
        {
            id: 'collect-inputs',
            name: 'Сбор исходных данных',
            requiredInputs: ['площадь', 'этажность', 'цена_продажи', 'себестоимость'],
            producedOutputs: ['input_table']
        },
        {
            id: 'build-cashflow',
            name: 'Построение денежного потока',
            requiredInputs: ['input_table', 'график_продаж', 'график_строительства'],
            producedOutputs: ['cashflow_monthly']
        },
        {
            id: 'calculate-metrics',
            name: 'Расчёт показателей',
            requiredInputs: ['cashflow_monthly', 'discount_rate'],
            producedOutputs: ['npv', 'irr', 'dpp', 'pi']
        },
        {
            id: 'sensitivity',
            name: 'Анализ чувствительности',
            requiredInputs: ['cashflow_monthly'],
            producedOutputs: ['sensitivity_matrix']
        }
    ],

    promptTemplate: `
Ты финансовый аналитик. Выполни DCF-анализ проекта.

## Исходные данные:
{{parameters}}

## База знаний:
{{knowledge}}

## Шаги:
1. Построй помесячный денежный поток
2. Рассчитай NPV при ставке дисконтирования {{discount_rate}}%
3. Рассчитай IRR
4. Рассчитай дисконтированный срок окупаемости (DPP)
5. Проведи анализ чувствительности (±10%, ±20% от базовых параметров)

## Формат ответа:
Верни JSON согласно схеме outputSchema.
    `,

    outputSchema: {
        type: 'object',
        properties: {
            npv: { type: 'number', description: 'NPV в рублях' },
            irr: { type: 'number', description: 'IRR в процентах' },
            dpp: { type: 'number', description: 'DPP в месяцах' },
            pi: { type: 'number', description: 'Индекс прибыльности' },
            recommendation: { type: 'string', enum: ['GO', 'NO-GO', 'CONDITIONAL'] },
            cashflow: { type: 'array', items: { type: 'object' } },
            sensitivity: { type: 'object' }
        },
        required: ['npv', 'irr', 'dpp', 'recommendation']
    }
};
```

---

## 5. Агенты (SubAgents)

### 5.1 Типы агентов

```typescript
type AgentType =
    | 'analyst'       // Аналитик (инвест-анализ)
    | 'lawyer'        // Юрист (правовая экспертиза)
    | 'architect'     // Архитектор (концепции, визуализация)
    | 'engineer'      // Инженер (расчёты, конструктив)
    | 'economist'     // Экономист (финмодели, сметы)
    | 'marketer'      // Маркетолог (рынок, продажи)
    | 'manager';      // Менеджер (координация, отчёты)

interface AgentConfig {
    type: AgentType;
    model: LLMModel;                // 'deepseek-r1' | 'gpt-4' | 'claude-3'
    temperature: number;            // 0.0 - 1.0
    maxTokens: number;
    systemPrompt: string;           // Базовый промпт агента
    tools?: AgentTool[];            // Доступные инструменты
}
```

### 5.2 Как Agent Zero назначает агента

```
┌─────────────────────────────────────────────────────────────────┐
│  AGENT ZERO: Логика назначения агента                           │
│                                                                  │
│  1. Смотрит на тип задачи (из шаблона)                          │
│     │                                                            │
│     ├── "gradostroit-analysis" → analyst                        │
│     ├── "legal-check"          → lawyer                         │
│     ├── "architecture-concept" → architect                      │
│     ├── "financial-model"      → economist                      │
│     └── ...                                                      │
│                                                                  │
│  2. Определяет модель LLM по сложности                          │
│     │                                                            │
│     ├── Простые задачи    → DeepSeek V3 (дешевле)              │
│     ├── Сложные расчёты   → DeepSeek R1 (reasoning)            │
│     ├── Креативные        → Claude 3 (creative)                │
│     └── Критические       → GPT-4 (надёжность)                 │
│                                                                  │
│  3. Формирует финальный AgentConfig                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 Промпты агентов

```typescript
const AGENT_PROMPTS: Record<AgentType, string> = {
    analyst: `
Ты опытный аналитик в сфере девелопмента недвижимости.

Твои компетенции:
- Градостроительный анализ
- Анализ рынка и конкурентов
- Инвестиционный анализ
- SWOT-анализ
- Оценка рисков

Правила работы:
1. Всегда опирайся на предоставленную базу знаний
2. Структурируй ответ по шагам методологии
3. Указывай источники данных
4. Выделяй риски и ограничения
5. Давай конкретные рекомендации
    `,

    economist: `
Ты финансовый аналитик / экономист в девелопменте.

Твои компетенции:
- Финансовое моделирование (DCF, NPV, IRR)
- Сметное ценообразование (ГЭСН, ТЕР)
- Бюджетирование проектов
- Анализ чувствительности
- Оценка эффективности инвестиций

Правила работы:
1. Всегда показывай формулы расчётов
2. Используй актуальные индексы и коэффициенты
3. Проверяй результаты на адекватность
4. Указывай допущения и ограничения
5. Формируй данные в Excel-совместимом формате
    `,

    // ... другие агенты
};
```

---

## 6. Выполнение задачи (Execution)

### 6.1 Алгоритм выполнения

```
┌─────────────────────────────────────────────────────────────────┐
│  ЗАПУСК: Пользователь нажал "Выполнить" или автозапуск         │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. ПРОВЕРКА ГОТОВНОСТИ                                          │
│                                                                  │
│  • Все зависимости выполнены? (dependencies)                    │
│  • Все обязательные параметры заполнены?                        │
│  • Источники знаний доступны?                                   │
│                                                                  │
│  Если НЕТ → status = 'pending', ждём                            │
│  Если ДА  → переходим к шагу 2                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. СБОР ВХОДНЫХ ДАННЫХ                                          │
│                                                                  │
│  status = 'running'                                              │
│  currentStep = "Сбор входных данных..."                         │
│  progress = 10%                                                  │
│                                                                  │
│  • Получить результаты от зависимых задач (inputData)           │
│  • Собрать параметры из context.parameters                      │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. ЗАГРУЗКА БАЗЫ ЗНАНИЙ                                         │
│                                                                  │
│  currentStep = "Загрузка базы знаний..."                        │
│  progress = 20%                                                  │
│                                                                  │
│  Для каждого source в context.knowledgeSources:                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  switch (source.type):                                    │   │
│  │    case 'document':                                       │   │
│  │      → Читаем PDF/DOCX, извлекаем текст                  │   │
│  │      → Если большой → делаем chunks для RAG              │   │
│  │                                                           │   │
│  │    case 'api':                                            │   │
│  │      → Вызываем API с apiKey из .env                     │   │
│  │      → Парсим ответ                                       │   │
│  │                                                           │   │
│  │    case 'database':                                       │   │
│  │      → Выполняем SQL запрос                              │   │
│  │                                                           │   │
│  │    case 'url':                                            │   │
│  │      → Fetch страницы                                     │   │
│  │      → Парсим по selector                                 │   │
│  │                                                           │   │
│  │    case 'embedding':                                      │   │
│  │      → Similarity search по запросу                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Результат: knowledge_context (текст для промпта)               │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. ФОРМИРОВАНИЕ ПРОМПТА                                         │
│                                                                  │
│  currentStep = "Формирование запроса..."                        │
│  progress = 40%                                                  │
│                                                                  │
│  prompt = methodology.promptTemplate                             │
│    .replace('{{parameters}}', JSON.stringify(parameters))       │
│    .replace('{{knowledge}}', knowledge_context)                  │
│    .replace('{{inputData}}', JSON.stringify(inputData))         │
│                                                                  │
│  systemPrompt = AGENT_PROMPTS[agent.type]                       │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. ВЫЗОВ LLM (агент работает)                                   │
│                                                                  │
│  currentStep = "Агент обрабатывает..."                          │
│  progress = 50-90% (обновляется по мере streaming)              │
│                                                                  │
│  response = await llm.chat({                                    │
│    model: agent.model,                                          │
│    messages: [                                                   │
│      { role: 'system', content: systemPrompt },                 │
│      { role: 'user', content: prompt }                          │
│    ],                                                            │
│    temperature: agent.temperature,                              │
│    max_tokens: agent.maxTokens,                                 │
│    stream: true  // для отображения прогресса                   │
│  });                                                             │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. ОБРАБОТКА РЕЗУЛЬТАТА                                         │
│                                                                  │
│  currentStep = "Обработка результата..."                        │
│  progress = 90%                                                  │
│                                                                  │
│  • Парсинг JSON из ответа (если outputSchema)                   │
│  • Валидация по схеме                                           │
│  • Генерация документов:                                        │
│    - PDF отчёт (если 'pdf' в outputs.formats)                   │
│    - Excel таблица (если 'excel' в outputs.formats)             │
│    - JSON файл (если 'json' в outputs.formats)                  │
│  • Сохранение в outputs.destination                             │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. ЗАВЕРШЕНИЕ                                                   │
│                                                                  │
│  status = 'done'                                                 │
│  progress = 100%                                                 │
│  completedAt = Date.now()                                       │
│                                                                  │
│  result = {                                                      │
│    data: parsedResponse,           // Структурированные данные  │
│    documents: [                                                  │
│      { type: 'pdf', path: '/results/task-123/report.pdf' },    │
│      { type: 'excel', path: '/results/task-123/data.xlsx' }    │
│    ],                                                            │
│    meta: {                                                       │
│      executionTime: 45000,         // мс                        │
│      tokensUsed: 12500,                                         │
│      model: 'deepseek-r1'                                       │
│    }                                                             │
│  }                                                               │
│                                                                  │
│  → Уведомить зависимые задачи (dependents)                      │
│  → Обновить все views через TaskStore                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 Обработка ошибок

```typescript
try {
    await executeTask(task);
} catch (error) {
    task.status = 'error';
    task.error = error.message;

    // Классификация ошибки
    if (error instanceof KnowledgeSourceError) {
        task.error = `Ошибка загрузки базы знаний: ${error.sourceName}`;
        // Предложить альтернативный источник или ручной ввод
    } else if (error instanceof LLMError) {
        task.error = `Ошибка LLM: ${error.message}`;
        // Retry с другой моделью или уменьшенным контекстом
    } else if (error instanceof ValidationError) {
        task.error = `Некорректный результат: ${error.message}`;
        // Показать сырой ответ для ручной обработки
    }

    // Обновить UI
    TaskStore.updateTask(task.id, { status: 'error', error: task.error });
}
```

---

## 7. Отображение результатов

### 7.1 Где показываются результаты

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  3D ГРАФ                                                  │   │
│  │                                                           │   │
│  │      ●────●────●                                          │   │
│  │     /│\   │   /│\     Цвет точки = статус                │   │
│  │    ● ● ● ● ● ● ●      🟢 = done                          │   │
│  │                       🔵 = running                        │   │
│  │                       ⚪ = pending                         │   │
│  │                       🔴 = error                          │   │
│  │                                                           │   │
│  │  [Hover на точку] → tooltip с кратким результатом        │   │
│  │  [Клик на точку]  → выбор, детали в правой панели        │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────┐  ┌──────────────────────────────────┐  │
│  │  NODE EDITOR        │  │  ПРАВАЯ ПАНЕЛЬ (детали)          │  │
│  │                     │  │                                   │  │
│  │  ┌───────────────┐  │  │  📊 ГРАДОСТРОИТ. АНАЛИЗ          │  │
│  │  │ Градостр. ✓  │  │  │                                   │  │
│  │  │               │  │  │  Статус: ✅ Выполнено            │  │
│  │  │ 📄 report.pdf │  │  │  Время: 45 сек                   │  │
│  │  │ "Макс.эт: 25" │  │  │                                   │  │
│  │  └───────────────┘  │  │  ─────────────────────────────   │  │
│  │         │           │  │                                   │  │
│  │         ▼           │  │  📄 РЕЗУЛЬТАТЫ                   │  │
│  │  ┌───────────────┐  │  │                                   │  │
│  │  │ Анализ лок.   │  │  │  📕 report.pdf (2.3 MB)          │  │
│  │  │               │  │  │     [Открыть] [Скачать]          │  │
│  │  │ ⏳ running... │  │  │                                   │  │
│  │  └───────────────┘  │  │  📗 data.xlsx (156 KB)           │  │
│  │                     │  │     [Открыть] [Скачать]          │  │
│  └─────────────────────┘  │                                   │  │
│                           │  ─────────────────────────────   │  │
│                           │                                   │  │
│                           │  📋 КРАТКИЕ РЕЗУЛЬТАТЫ           │  │
│                           │                                   │  │
│                           │  • Макс. этажность: 25           │  │
│                           │  • Площадь застройки: 15 000 м²  │  │
│                           │  • Плотность: 25 000 м²/га       │  │
│                           │  • Ограничения: охранная зона    │  │
│                           │                                   │  │
│                           │  [▼ Показать полный отчёт]       │  │
│                           │                                   │  │
│                           └──────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 Превью результата в ноде

```
┌────────────────────────────────────────┐
│  Градостроительный анализ         ✅ ▼ │  ← статус + кнопка развернуть
├────────────────────────────────────────┤
│                                        │
│  📄 report.pdf                         │  ← файлы результата
│  📊 data.xlsx                          │
│  ─────────────────────────────────     │
│  "Максимальная этажность: 25          │  ← первые строки результата
│   Площадь застройки: 15 000 м²        │
│   Ограничения: охранная зона..."      │
│                                        │
│  [▼ Развернуть]                        │
│                                        │
└────────────────────────────────────────┘
```

### 7.3 Структура результата

```typescript
interface TaskResult {
    // Структурированные данные (для следующих задач)
    data: Record<string, any>;

    // Сгенерированные документы
    documents: Array<{
        type: 'pdf' | 'excel' | 'json' | 'image' | 'dwg';
        name: string;           // "report.pdf"
        path: string;           // "/results/task-123/report.pdf"
        size: number;           // в байтах
        preview?: string;       // Первые N символов или thumbnail URL
    }>;

    // Метаданные выполнения
    meta: {
        executionTime: number;  // мс
        tokensUsed: number;
        model: string;
        steps: Array<{
            name: string;
            duration: number;
            status: 'ok' | 'warning' | 'error';
            message?: string;
        }>;
    };
}
```

---

## 8. Визуальная структура ноды

### 8.1 Полная анатомия ноды

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ┌───┐                                                       ┌───┐ │
│  │ ◆ │ Context Bundle                         Result    [●]  │ ● │ │
│  └───┘   • knowledge                                         └───┘ │
│          • methodology                                              │
│          • parameters                          Data     [●]  ┌───┐ │
│          • inputData                                         │ ● │ │
│                                                              └───┘ │
│  ┌───┐                                                              │
│  │ ● │ Agent Closure ─────────▶ [EXECUTE]      Meta     [○]  ┌───┐ │
│  └───┘                                                       │ ○ │ │
│                                                              └───┘ │
│  ════════════════════════════════════════════════════════════════  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  АГЕНТ:   [Analyst          ▼]   MODEL: [DeepSeek R1  ▼]    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  БАЗА ЗНАНИЙ:                                         [+]   │   │
│  │  ☑ ПЗЗ Москвы                                               │   │
│  │  ☑ СНиП 42.13330                                            │   │
│  │  ☐ МГСН 1.01-99                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  МЕТОДОЛОГИЯ:  [Расширенный анализ                      ▼]  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ПАРАМЕТРЫ:                                           [+]   │   │
│  │  Кадастровый №:  [77:01:0001234:567          ]              │   │
│  │  Площадь:        [2.35                       ] га           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ВЫХОД:                                                      │   │
│  │  ☑ PDF отчёт   ☑ Excel   ☑ JSON                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ════════════════════════════════════════════════════════════════  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ████████████████████████████░░░░░░░░░░ 75%                 │   │
│  │  Этап: Агент обрабатывает...                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  [▶ ВЫПОЛНИТЬ]                                    [RUNNING ⟳]      │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘

ЛЕГЕНДА СОКЕТОВ:
  ◆ Ромб (красный)     = Bundle (контекст)
  ● Круг (бирюзовый)   = Closure (агент)
  ● Круг (зелёный)     = Document (результат)
  ● Круг (жёлтый)      = Data (JSON)
  ○ Круг-обводка       = Meta (опционально)
```

### 8.2 Типы сокетов

| Тип | Цвет | Форма | Описание |
|-----|------|-------|----------|
| bundle | #FF6B6B (красный) | ◆ Ромб | Контекст задачи (knowledge + method + params + input) |
| closure | #4ECDC4 (бирюзовый) | ● Круг | Агент-функция |
| data | #FFD700 (жёлтый) | ● Круг | Данные JSON для следующей ноды |
| document | #32CD32 (зелёный) | ● Круг | Результат (PDF, Excel) |
| meta | #FFFFFF (белый) | ○ Обводка | Метаданные (опционально) |

### 8.3 Состояния ноды

| Рамка | Статус | Описание |
|-------|--------|----------|
| Серая | pending | Ожидание (не все входы готовы) |
| Оранжевая | ready | Готова к выполнению |
| Синяя + пульсация | running | Выполняется |
| Зелёная | done | Успешно завершена |
| Красная | error | Ошибка |
| Бирюзовая подсветка | selected | Выбрана |

---

## 9. Панели ввода данных (как в Grasshopper)

### 9.1 Типы панелей ввода

В Grasshopper данные вводятся через специальные компоненты:
- **Number Slider** — числа
- **Panel** — текст, списки
- **Toggle** — boolean

В VZOR аналогично:

```
┌──────────────────────────────────────────────────────────────────┐
│  ПАНЕЛЬ ПАРАМЕТРОВ (отдельная нода-источник)                     │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  📋 ПАРАМЕТРЫ УЧАСТКА                               [●]────────▶
│  │                                                               │ │
│  │  Кадастровый №:                                               │ │
│  │  ┌─────────────────────────────────────────────────────┐     │ │
│  │  │ 77:01:0001234:567                                   │     │ │
│  │  └─────────────────────────────────────────────────────┘     │ │
│  │                                                               │ │
│  │  Адрес:                                                       │ │
│  │  ┌─────────────────────────────────────────────────────┐     │ │
│  │  │ г. Москва, ул. Тверская, д. 1                       │     │ │
│  │  └─────────────────────────────────────────────────────┘     │ │
│  │                                                               │ │
│  │  Площадь (га):                                                │ │
│  │  ┌───────────────────────────────────────────────────────┐   │ │
│  │  │ ●────────────────────○──────────────────────────────  │   │ │
│  │  │  0                  2.35                         10   │   │ │
│  │  └───────────────────────────────────────────────────────┘   │ │
│  │                                                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                                    │
                                    │ params (JSON)
                                    ▼
                        ┌──────────────────────┐
                        │  ГРАДОСТР. АНАЛИЗ    │
                        │                      │
                        │  ◆ Context ◀─────────│
                        │                      │
                        └──────────────────────┘
```

### 9.2 Нода "База знаний"

```
┌──────────────────────────────────────────────────────────────────┐
│  📚 БАЗА ЗНАНИЙ: ПЗЗ                                     [●]────────▶
│                                                                   │
│  Тип: [Документ              ▼]                                  │
│                                                                   │
│  Файл: /knowledge/pzz/moscow-2024.pdf                            │
│        [📂 Выбрать файл]                                         │
│                                                                   │
│  Домен:                                                          │
│  ☑ Градостроительство                                            │
│  ☑ Право                                                         │
│  ☐ Экономика                                                     │
│                                                                   │
│  Регион: [Москва             ▼]                                  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 9.3 Нода "Методология"

```
┌──────────────────────────────────────────────────────────────────┐
│  📐 МЕТОДОЛОГИЯ: DCF-анализ                              [●]────────▶
│                                                                   │
│  Шаблон: [DCF-анализ         ▼]                                  │
│                                                                   │
│  Шаги:                                                           │
│  1. ☑ Сбор исходных данных                                       │
│  2. ☑ Построение денежного потока                                │
│  3. ☑ Расчёт показателей                                         │
│  4. ☑ Анализ чувствительности                                    │
│                                                                   │
│  Ставка дисконтирования (%):                                     │
│  ┌───────────────────────────────────────────────────────┐       │
│  │ ●──────────────────○────────────────────────────────  │       │
│  │  5                15                              30  │       │
│  └───────────────────────────────────────────────────────┘       │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 10. Синхронизация и Store

### 10.1 Структура TaskStore

```typescript
// store/taskStore.ts

import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';

interface TaskStore {
    // === ДАННЫЕ ===
    tasks: Map<string, Task>;
    connections: Connection[];
    knowledgeSources: Map<string, KnowledgeSource>;
    methodologies: Map<string, Methodology>;

    // === UI STATE ===
    selectedTaskId: string | null;
    hoveredTaskId: string | null;
    viewMode: '3d' | 'nodes' | 'split';

    // === ACTIONS ===

    // Tasks
    addTask: (task: Task) => void;
    updateTask: (id: string, updates: Partial<Task>) => void;
    removeTask: (id: string) => void;
    executeTask: (id: string) => Promise<void>;

    // Selection
    selectTask: (id: string | null) => void;
    hoverTask: (id: string | null) => void;

    // Connections
    addConnection: (conn: Connection) => void;
    removeConnection: (connId: string) => void;

    // Bulk operations
    setFromTemplate: (template: BlockTemplate) => void;
    clear: () => void;
}

export const useTaskStore = create<TaskStore>()(
    immer((set, get) => ({
        tasks: new Map(),
        connections: [],
        knowledgeSources: new Map(),
        methodologies: new Map(),
        selectedTaskId: null,
        hoveredTaskId: null,
        viewMode: 'split',

        selectTask: (id) => set((state) => {
            state.selectedTaskId = id;
        }),

        updateTask: (id, updates) => set((state) => {
            const task = state.tasks.get(id);
            if (task) {
                Object.assign(task, updates);
            }
        }),

        executeTask: async (id) => {
            const { tasks, updateTask } = get();
            const task = tasks.get(id);
            if (!task) return;

            try {
                updateTask(id, { status: 'running', progress: 0 });

                // ... логика выполнения ...

                updateTask(id, { status: 'done', progress: 100, result });
            } catch (error) {
                updateTask(id, { status: 'error', error: error.message });
            }
        },

        // ... остальные методы
    }))
);
```

### 10.2 Подписка компонентов

```typescript
// === 3D View ===
const Viewport3D = () => {
    const tasks = useTaskStore(state => Array.from(state.tasks.values()));
    const selectedId = useTaskStore(state => state.selectedTaskId);
    const selectTask = useTaskStore(state => state.selectTask);

    return (
        <Canvas>
            {tasks.map(task => (
                <TaskPoint
                    key={task.id}
                    position={task.position3D}
                    status={task.status}
                    isSelected={task.id === selectedId}
                    onClick={() => selectTask(task.id)}
                />
            ))}
        </Canvas>
    );
};

// === Node Editor ===
const NodeEditor = () => {
    const tasks = useTaskStore(state => Array.from(state.tasks.values()));
    const connections = useTaskStore(state => state.connections);
    const selectTask = useTaskStore(state => state.selectTask);

    const nodes = tasks.map(taskToReactFlowNode);
    const edges = connections.map(connToReactFlowEdge);

    return (
        <ReactFlow
            nodes={nodes}
            edges={edges}
            onNodeClick={(_, node) => selectTask(node.id)}
        />
    );
};

// === Right Panel ===
const TaskDetailsPanel = () => {
    const selectedId = useTaskStore(state => state.selectedTaskId);
    const task = useTaskStore(state =>
        selectedId ? state.tasks.get(selectedId) : null
    );

    if (!task) return <EmptyState />;

    return <TaskDetails task={task} />;
};
```

---

## 11. API и Backend

### 11.1 Эндпоинты

```
POST   /api/tasks              # Создать задачу
GET    /api/tasks/:id          # Получить задачу
PUT    /api/tasks/:id          # Обновить задачу
DELETE /api/tasks/:id          # Удалить задачу
POST   /api/tasks/:id/execute  # Выполнить задачу

GET    /api/knowledge          # Список источников знаний
POST   /api/knowledge          # Добавить источник
GET    /api/knowledge/:id      # Получить источник

GET    /api/methodologies      # Список методологий
GET    /api/methodologies/:id  # Получить методологию

POST   /api/agent-zero/parse   # Парсинг команды Agent Zero
POST   /api/agent-zero/build   # Построить граф задач

WS     /ws/tasks/:id/progress  # WebSocket для прогресса
```

### 11.2 WebSocket для прогресса

```typescript
// Backend (FastAPI)
@app.websocket("/ws/tasks/{task_id}/progress")
async def task_progress(websocket: WebSocket, task_id: str):
    await websocket.accept()

    async for update in task_executor.stream_progress(task_id):
        await websocket.send_json({
            "type": "progress",
            "taskId": task_id,
            "progress": update.progress,
            "currentStep": update.step,
            "partialResult": update.partial_result
        })

    await websocket.close()


// Frontend
const useTaskProgress = (taskId: string) => {
    const updateTask = useTaskStore(state => state.updateTask);

    useEffect(() => {
        const ws = new WebSocket(`ws://localhost:8000/ws/tasks/${taskId}/progress`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateTask(taskId, {
                progress: data.progress,
                currentStep: data.currentStep
            });
        };

        return () => ws.close();
    }, [taskId]);
};
```

---

## 12. Файловая структура

```
VZOR/
├── docs/
│   └── design/
│       └── node-architecture-full.md    # ← Этот документ
│
├── platform/
│   ├── frontend/
│   │   ├── src/
│   │   │   ├── components/
│   │   │   │   ├── Viewport3D/          # 3D граф (Three.js)
│   │   │   │   ├── NodeEditor/          # Node Editor (@xyflow)
│   │   │   │   ├── TaskPanel/           # Правая панель
│   │   │   │   └── nodes/               # Компоненты нод
│   │   │   │       ├── TaskNode.tsx
│   │   │   │       ├── KnowledgeNode.tsx
│   │   │   │       ├── MethodologyNode.tsx
│   │   │   │       └── ParametersNode.tsx
│   │   │   │
│   │   │   ├── store/
│   │   │   │   └── taskStore.ts         # Zustand store
│   │   │   │
│   │   │   ├── types/
│   │   │   │   ├── task.ts
│   │   │   │   ├── knowledge.ts
│   │   │   │   ├── methodology.ts
│   │   │   │   └── agent.ts
│   │   │   │
│   │   │   └── engine/
│   │   │       ├── executor.ts          # Выполнение задач
│   │   │       ├── graphBuilder.ts      # Построение графа
│   │   │       └── dataFlow.ts          # Data flow логика
│   │   │
│   │   └── package.json
│   │
│   └── backend/
│       ├── app/
│       │   ├── api/
│       │   │   ├── tasks.py
│       │   │   ├── knowledge.py
│       │   │   └── agent_zero.py
│       │   │
│       │   ├── services/
│       │   │   ├── task_executor.py
│       │   │   ├── knowledge_loader.py
│       │   │   └── llm_client.py
│       │   │
│       │   └── models/
│       │       ├── task.py
│       │       └── knowledge.py
│       │
│       └── requirements.txt
│
├── agent-core/
│   ├── agents/                          # Конфигурации агентов
│   │   ├── analyst.json
│   │   ├── economist.json
│   │   └── ...
│   │
│   ├── templates/                       # Шаблоны блоков
│   │   ├── invest-analysis.json
│   │   ├── design.json
│   │   ├── construction.json
│   │   └── sales.json
│   │
│   ├── knowledge/                       # Базы знаний
│   │   ├── registry.ts
│   │   ├── pzz/
│   │   ├── snip/
│   │   └── ...
│   │
│   └── methodologies/                   # Методологии
│       ├── dcf-analysis.json
│       ├── swot.json
│       └── ...
│
└── storage/
    └── results/                         # Результаты задач
        └── {task-id}/
            ├── report.pdf
            ├── data.xlsx
            └── meta.json
```

---

## 13. Следующие шаги для Gemini

1. **Создать TypeScript типы** в `platform/frontend/src/types/`
2. **Реализовать TaskStore** в `platform/frontend/src/store/taskStore.ts`
3. **Создать компонент TaskNode** в `platform/frontend/src/components/nodes/TaskNode.tsx`
4. **Интегрировать ReactFlow** для Node Editor
5. **Добавить синхронизацию** между 3D и Node Editor
6. **Реализовать backend API** на FastAPI
7. **Подключить LLM** для выполнения задач

---

*Документ создан: 2026-02-03*
*Версия: 1.0*
