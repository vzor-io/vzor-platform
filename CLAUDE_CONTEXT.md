# CLAUDE CONTEXT — VZOR Platform

> Этот файл содержит контекст проекта для Claude. При новом чате скажи:
> "Прочитай CLAUDE_CONTEXT.md и войди в контекст"

---

## Что такое VZOR

**VZOR** — платформа для девелопмента недвижимости с AI-агентами и 3D визуализацией.

Позволяет автоматизировать процессы девелопмента через визуальный интерфейс, где:
- **Точки** в 3D графе = задачи
- **Agent Zero** = оркестратор, который автоматически создаёт задачи и наполняет их
- **Node Editor** = ручной режим управления (страховка)

---

## Ключевая концепция: Два режима — одни данные

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│                     3D ГРАФ (точки)                              │
│                   АВТОМАТИЧЕСКИЙ РЕЖИМ                           │
│                                                                  │
│         ●────●────●────●                                        │
│        /│\   │   /│\   │        Agent Zero создаёт              │
│       ● ● ● ● ● ● ● ●          точки и связи автоматически      │
│                                                                  │
│   [Клик на точку ●] → справа панель с параметрами               │
│                                                                  │
├══════════════════════════════════════════════════════════════════┤
│                                                                  │
│                     NODE EDITOR (ноды)                           │
│                   РУЧНОЙ РЕЖИМ (страховка)                       │
│                                                                  │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐                   │
│   │ Точка 1 │────▶│ Точка 2 │────▶│ Точка 3 │   ЗЕРКАЛО        │
│   └─────────┘     └─────────┘     └─────────┘   тех же точек    │
│                                                                  │
│   [Те же параметры, но можно править ВРУЧНУЮ]                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Аналогия:** Как автопилот и штурвал в самолёте — одна система, два способа управления.

---

## Блоки девелопмента

Весь процесс делится на блоки (циклы):

1. **Инвест-анализ** — анализ участка, локации, конкурентов, ТЭО
2. **Проектирование** — архитектура, инженерия, экспертиза
3. **Строительство** — подрядчик, контроль, снабжение
4. **Продажи** — маркетинг, продажи, сервис

В каждом блоке — набор задач. Пользователь говорит:
> "Блок инвест-анализ, участок 77:01:0001234:567"

Agent Zero автоматически создаёт все задачи блока.

---

## Структура задачи (точки/ноды)

Каждая задача содержит:

| Категория | Описание |
|-----------|----------|
| **Входные данные** | Кадастровый номер, адрес, площадь... |
| **База знаний** | ПЗЗ, СНиПы, ГПЗУ, API Росреестра... |
| **Методология** | Метод анализа (SWOT, DCF, скоринг...) |
| **Агент** | Тип агента (Analyst, Designer...), LLM модель |
| **Выход** | Формат результата (PDF, Excel, JSON, 3D модель) |
| **Связи** | От каких задач зависит, какие блокирует |

---

## Workflow выполнения

```
1. Пользователь: "Блок инвест-анализ, участок X"
2. Agent Zero создаёт структуру задач (превью)
3. Пользователь смотрит, при необходимости правит в Node Editor
4. Пользователь: "Выполняй"
5. Агенты работают, генерируют результаты
6. Результаты: отчёты PDF, Excel, данные для следующих задач
```

---

## Техническая архитектура

### Текущая структура проекта (после реорганизации 2025-02-01)

```
VZOR/
├── CLAUDE_CONTEXT.md        # ← Этот файл (контекст для Claude)
├── README.md                # Описание проекта
├── .env.example             # Шаблон переменных окружения
├── .gitignore               # Git ignore
│
├── docs/                    # 📚 Документация
│   ├── architecture/        # Техническая архитектура
│   ├── design/              # Спецификации фич
│   ├── decisions/           # ADR (почему так решили)
│   ├── guides/              # Руководства
│   ├── overview/            # Общее описание
│   └── drafts/              # Черновики
│
├── platform/                # 🖥️ Основной продукт (пока скелет)
│   ├── frontend/            # React + Vite (будет)
│   ├── backend/             # FastAPI (будет)
│   └── shared/              # Общие схемы
│
├── agent-core/              # 🤖 Движок агентов (бывший core/)
│   ├── agents/              # Конфигурации агентов
│   ├── prompts/             # Системные промпты
│   ├── knowledge/           # Базы знаний
│   └── ...
│
├── web_platform_v2/         # ⚠️ РАБОЧИЕ ПРОТОТИПЫ (не трогать!)
│   ├── frontend/
│   │   ├── index_v3.5.html  # Версия с Node Editor
│   │   ├── index_v3.6.html  # Последняя версия
│   │   └── .git/            # Отдельный git (связь с GitHub Pages)
│   └── backend/
│
├── blender/                 # 🎬 Интеграция с Blender
├── scripts/                 # 🔧 Скрипты автоматизации
├── docker/                  # Docker конфигурации
│
└── archive/                 # 📦 Архив
    └── legacy_prototypes/   # Старые версии (web_platform v1, temp файлы)
```

**ВАЖНО:** `web_platform_v2/` содержит рабочие прототипы v3.5/v3.6. Не перемещать и не трогать без явного разрешения!

### Версии фронтенда

- `index_v3.1.html` ... `index_v3.6.html` — итерации UI
- `index_GOLDEN_REF.html` — эталонная версия
- `index_template_stable.html` — стабильный шаблон

**ВАЖНО:** Не трогать версии без явного разрешения. Есть связки с GitHub.

---

## Решено: Стиль Node Editor

### Выбран: Grasshopper-стиль

**Дата решения:** 2025-02-01

**Почему Grasshopper:**
- Проверенная система для расчётов
- Математически сильная логика data flow
- Визуально обновлённый в Grasshopper 2 (Rhino 8)
- UX удобства можно взять из Blender

**Демо-файлы созданы:** `docs/demos/node_styles/`
- `index.html` — навигация между стилями
- `demo_grasshopper.html`
- `demo_blender.html`
- `demo_hybrid.html`

---

## Архитектура ноды (Task Node)

### Визуальная структура

```
                         ┌─────────────────────────────────────┐
                         │                                     │
     ВХОДЫ (inputs)      │         НОДА ЗАДАЧИ                │      ВЫХОДЫ (outputs)
     ═══════════════     │         ══════════════              │      ════════════════
                         │                                     │
  ●─────────────────────▶│  ┌─────────────────────────────┐   │
  Данные от пред. задачи │  │                             │   │
                         │  │      ВНУТРЕННЯЯ ЛОГИКА      │   │
  ●─────────────────────▶│  │                             │   │─────────────────────▶●
  База знаний            │  │  1. Получить входы          │   │  Результат (документ)
                         │  │  2. Загрузить базу знаний   │   │
  ●─────────────────────▶│  │  3. Применить методологию   │   │─────────────────────▶●
  Методология            │  │  4. Агент обрабатывает      │   │  Данные для след. ноды
                         │  │  5. Сформировать выход      │   │
  ●─────────────────────▶│  │                             │   │─────────────────────▶●
  Параметры              │  │      [АГЕНТ: Analyst]       │   │  Метаданные
                         │  │      [LLM: DeepSeek R1]     │   │
                         │  └─────────────────────────────┘   │
                         │                                     │
                         │  [▶ ВЫПОЛНИТЬ]    [СТАТУС: ⏸]      │
                         │                                     │
                         └─────────────────────────────────────┘
```

### Типы входов

| Вход | Тип | Описание |
|------|-----|----------|
| **Данные** | `any` | Результат предыдущей задачи (JSON, текст, файл) |
| **База знаний** | `knowledge` | Ссылка на документы/API (ПЗЗ, СНиПы...) |
| **Методология** | `method` | Как обрабатывать (DCF, SWOT, скоринг...) |
| **Параметры** | `params` | Конкретные значения (кадастр, площадь, радиус...) |

### Типы выходов

| Выход | Тип | Описание |
|-------|-----|----------|
| **Результат** | `document` | PDF, Excel, текст отчёта |
| **Данные** | `json` | Структурированные данные для следующей ноды |
| **Метаданные** | `meta` | Время выполнения, статус, ошибки |

### Логика Data Flow (как в Grasshopper)

- Данные текут **слева → направо** (никогда назад)
- **Steady-state**: пересчёт только когда что-то изменилось
- **Зависимости**: нода не выполняется, пока не получит все входы
- Изменение входа → автоматический пересчёт downstream нод

### Добавление входов

**ПКМ на ноде** → меню:
```
┌─────────────────────┐
│ + Добавить вход     │
│   ├─ Данные         │
│   ├─ База знаний    │
│   ├─ Методология    │
│   └─ Параметр       │
│ ─────────────────── │
│ + Добавить выход    │
│ ─────────────────── │
│ Настройки агента    │
│ Удалить ноду        │
└─────────────────────┘
```

Или: подключение провода автоматически создаёт вход нужного типа.

### Псевдокод логики ноды

```python
class TaskNode:
    def execute(self):
        # 1. Проверить что все ОБЯЗАТЕЛЬНЫЕ входы подключены
        if not self.inputs['methodology'].is_connected:
            raise Error("Методология не подключена")

        # 2. Собрать все входные данные
        input_data = self.inputs['data'].get_value()
        knowledge = self.inputs['knowledge'].get_documents()
        method = self.inputs['methodology'].get_method()
        params = self.inputs['params'].get_values()

        # 3. Сформировать контекст для агента
        context = {
            "task": self.name,
            "input_data": input_data,
            "knowledge": knowledge,
            "parameters": params
        }

        # 4. Применить методологию через агента
        prompt = method.generate_prompt(context)
        result = self.agent.run(prompt)

        # 5. Сформировать выходы
        self.outputs['result'].set_value(result.document)
        self.outputs['data'].set_value(result.structured_data)
        self.outputs['meta'].set_value(result.metadata)

        # 6. Триггерить downstream ноды
        self.notify_downstream()
```

---

## Визуальный дизайн ноды

### Цвета сокетов по типу данных

| Цвет | Тип | Описание |
|------|-----|----------|
| **Жёлтый** | `data` | Данные (JSON, текст) |
| **Голубой** | `knowledge` | База знаний |
| **Фиолетовый** | `method` | Методология |
| **Серый** | `params` | Параметры |
| **Зелёный** | `document` | Результат (PDF, Excel) |
| **Белый** | `meta` | Метаданные |

### Формы сокетов

| Форма | Значение |
|-------|----------|
| **Круг ●** | Обязательный вход |
| **Круг с обводкой ○** | Опциональный вход |
| **Ромб ◆** | Список/множество значений |

### Цвета состояний ноды (рамка/фон)

| Цвет | Состояние | Описание |
|------|-----------|----------|
| **Серый** | Pending | Готова, ждёт выполнения |
| **Оранжевый** | Warning | Не все входы подключены |
| **Красный** | Error | Ошибка выполнения |
| **Синий + пульсация** | Running | Агент работает |
| **Зелёный** | Done | Успешно выполнено |
| **Бирюзовая подсветка** | Selected | Нода выбрана |

### Источники дизайна
- [Grasshopper Object Types](https://modelab.gitbooks.io/grasshopper-primer/content/1-foundations/1-2/1_grasshopper-object-types.html)
- [Blender Fields & Sockets](https://docs.blender.org/manual/en/latest/modeling/geometry_nodes/fields.html)
- [Grasshopper 2 Features](https://howtorhino.com/rhino-grasshopper-tutorials/grasshopper-2-features/)

---

## Прогресс выполнения в ноде

### Правила отображения
- **< 1 сек** — ничего не показывать (мгновенно)
- **1-10 сек** — пульсирующая рамка + spinner
- **> 10 сек** — progress bar + текст этапа

### Визуально (длинные задачи)
```
┌──────────────────────────┐
│  Градостроит. анализ     │  ← синяя пульсирующая рамка
│                          │
│  1. База знаний      ✓   │
│  2. Анализ данных    ✓   │
│  3. Методология      ⟳   │  ← текущий этап
│  4. Формирование     ○   │
│                          │
│  ████████░░░░ 65%        │  ← progress bar
└──────────────────────────┘
```

### Источник
[Loading & Progress Indicators UX](https://uxdesign.cc/loading-progress-indicators-ui-components-series-f4b1fc35339a)

---

## Превью результата в ноде

### Три режима
1. **Свёрнуто (по умолчанию):** иконка типа + имя файла
2. **Развёрнуто (по клику ▼):** первые 3-5 строк результата
3. **Полный просмотр:** в правой панели при выборе ноды

### Визуально
```
┌────────────────────────────┐
│  Градостроит. анализ   ✓ ▼ │
├────────────────────────────┤
│ 📄 report.pdf (2.3 MB)     │  ← файлы результата
│ 📊 data.json               │
│ ─────────────────────────  │
│ "Макс. этажность: 25       │  ← превью текста
│  Площадь: 15 000 м²..."    │
└────────────────────────────┘
```

---

## Синхронизация 3D граф ↔ Node Editor

### Архитектура: Единый Store

```
TaskStore (Zustand/Redux)
    │
    ├── 3D Граф (Three.js) — слушает изменения
    ├── Node Editor (Canvas) — слушает изменения
    └── Right Panel (React) — слушает изменения
```

### Таблица синхронизации

| Действие | 3D Граф | Node Editor | Right Panel |
|----------|---------|-------------|-------------|
| Клик на точку | **source** | выделить ноду | показать данные |
| Клик на ноду | выделить точку | **source** | показать данные |
| Изменить параметр | — | — | **source** → обновить оба |
| Добавить задачу | + точка | + нода | — |
| Удалить задачу | - точка | - нода | очистить |

### Принцип
Один источник правды (store) → все views реагируют на изменения.

---

## Нерешённые вопросы

- Анимация проводов при передаче данных
- Как агент отчитывается о прогрессе (WebSocket? SSE?)
- Хранение результатов (локально? облако?)
- Позиционирование: связать 3D координаты с 2D позицией ноды?

---

## Рекомендуемая структура проекта

(Обсуждалось, ждёт реорганизации)

```
VZOR/
├── README.md
├── .gitignore
├── docs/                    # Документация
│   ├── overview/            # Видение, глоссарий
│   ├── architecture/        # Техническая архитектура
│   ├── design/              # Спецификации фич
│   └── decisions/           # ADR (почему так решили)
├── platform/                # Основной продукт
│   ├── frontend/
│   └── backend/
├── agent-core/              # Движок агентов
├── scripts/                 # Автоматизация
└── archive/                 # Старое
```

---

## Контакты и ресурсы

- **GitHub:** vzor-io/vzor-platform (деплой на GitHub Pages)
- **LLM:** DeepSeek R1/V3
- **Фреймворк агентов:** Agent Zero (форк)

---

## История обсуждений

### 2025-02-01: Первый сеанс с Claude Code

**Часть 1: Знакомство с проектом**
- Изучена структура проекта
- Определена концепция: точки = задачи, Agent Zero = оркестратор
- Node Editor = ручная страховка автоматического режима
- Проанализирован пример задачи "Градостроительный анализ"

**Часть 2: Реструктуризация (Gemini)**
- Gemini создал новую структуру папок: `docs/`, `platform/`, `agent-core/`, `archive/`
- `core` → `agent-core`
- `web_platform_v2` осталась в корне (рабочие прототипы)
- Создан README.md, .gitignore, .env.example

**Часть 3: Выбор стиля Node Editor**
- Gemini создал демо: `docs/demos/node_styles/`
- **Выбран Grasshopper-стиль** (data flow, расчётная логика)
- Визуал: Grasshopper 2 (Rhino 8)
- UX: некоторые элементы из Blender

**Часть 4: Архитектура ноды**
- Определены типы входов: Данные, База знаний, Методология, Параметры
- Определены типы выходов: Результат, Данные, Метаданные
- Описана логика data flow (слева → направо, steady-state)
- Написан псевдокод внутренней логики ноды

**Часть 5: Визуальный дизайн**
- Цвета сокетов по типам данных (жёлтый=data, голубой=knowledge, и т.д.)
- Формы сокетов (круг=обязательный, круг с обводкой=опциональный, ромб=список)
- Цвета состояний ноды (серый, оранжевый, красный, синий, зелёный)

**Часть 6: UX элементы**
- Прогресс выполнения: < 1 сек — ничего, 1-10 сек — spinner, > 10 сек — progress bar
- Превью результата: свёрнуто/развёрнуто/полный просмотр в панели
- Синхронизация: единый TaskStore → все views слушают изменения

**Часть 7: Полный алгоритм работы (для Gemini)**

См. отдельный файл: `docs/design/node-editor-algorithm.md`

### 2026-02-03: Полная архитектура нод

**Создан:** `docs/design/node-architecture-full.md`

Документ содержит:
- Полный жизненный цикл задачи (от создания до результата)
- Как Agent Zero подхватывает и настраивает задачи
- Источники знаний (документы, API, базы данных, парсинг, RAG)
- Методологии и их структура
- Агенты (SubAgents) и их промпты
- Алгоритм выполнения задачи (7 шагов)
- Отображение результатов (3D, ноды, панель)
- Полная визуальная анатомия ноды
- Панели ввода данных (как в Grasshopper)
- TaskStore и синхронизация
- API эндпоинты и WebSocket
- Файловая структура проекта

**Ключевые концепции (из Blender 5.0):**
- **Bundle** — объединение всех входных параметров в один сокет
- **Closure** — Agent Zero как передаваемая функция

**Следующие шаги:**
- Gemini: реализовать прототип по алгоритму
- Создать детальный прототип ноды (HTML/CSS)
- Реализовать Node Editor на Canvas
- Интеграция с 3D графом через единый store

---

*Последнее обновление: 2025-02-01 (вечер)*
