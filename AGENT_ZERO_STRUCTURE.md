# Agent Zero — Структура на сервере

**Сервер:** `vzor@95.174.95.209`
**Данные:** `/home/vzor/agent-zero-data/` (в Docker: `/a0/usr`)
**Обновлено:** 2026-02-21 (v5.3 — делегирование подагентам, исправление vzor-analyst/planner)

---

## Полное дерево

```
/home/vzor/agent-zero-data/
│
│
│   ══════════════════════════════════════════════════════
│   1. РОЛЬ — кто агент и как работает
│      Загружается КАЖДЫЙ разговор. Агент никогда не забывает.
│   ══════════════════════════════════════════════════════
│
├── agents/
│   │
│   ├── agent0/                                         ГЛАВНЫЙ АГЕНТ
│   │   │
│   │   ├── _context.md                                 Контекст проекта (видит всегда)
│   │   │                                               ─────────────────────────────
│   │   │                                               Что за проект, блоки, задачи,
│   │   │                                               инфраструктура, принципы.
│   │   │                                               + Раздел "Текущее состояние" —
│   │   │                                               агент заполняет в конце сессии.
│   │   │                                               + Инструкция при СТАРТЕ: читай
│   │   │                                               контекст → продолжай работу.
│   │   │                                               + Инструкция при ФИНИШЕ: обнови
│   │   │                                               все поля → сохрани bash-командой.
│   │   │
│   │   └── prompts/
│   │       └── agent.system.main.role.md               ★ ГЛАВНЫЙ ПРОМПТ АГЕНТА
│   │                                                   ─────────────────────────────
│   │                                                   533 строки. Версия 5.3.
│   │                                                   Последнее обновление: 2026-02-21
│   │                                                   Содержимое ниже в разделе
│   │                                                   "Структура промпта".
│   │
│   ├── vzor-analyst/                                   Подагент: анализ, финмодели
│   │   ├── _context.md                                 ✔ Обновлён v5.3
│   │   └── prompts/agent.system.main.role.md           ✔ /opt/venv/bin/python3, --project
│   ├── vzor-planner/                                   Подагент: планирование задач
│   │   ├── _context.md                                 ✔ Обновлён v5.3
│   │   └── prompts/agent.system.main.role.md           ✔ /opt/venv/bin/python3, --project,
│   │                                                      clone-template
│   ├── vzor-deployer/                                  Подагент: деплой, Docker, Git
│   │   └── (без изменений — shell-скрипты)
│   ├── vzor-debugger/                                  Подагент: отладка, логи
│   │   └── (без изменений — диагностика)
│   ├── default/                                        Шаблон (не трогать)
│   ├── developer/                                      Встроенный профиль
│   ├── researcher/                                     Встроенный профиль
│   └── _example/                                       Пример (не трогать)
│
│
│   ══════════════════════════════════════════════════════
│   2. ЗНАНИЯ — справочники и ментальные модели
│      Агент ищет здесь по смыслу (векторный поиск FAISS).
│      Индексирует автоматически при запуске.
│      Доступ из промпта: cat /a0/usr/knowledge/custom/main/<файл>
│   ══════════════════════════════════════════════════════
│
├── knowledge/
│   ├── custom/
│   │   ├── main/                                       ОСНОВНАЯ БАЗА ЗНАНИЙ (106 файлов)
│   │   │   │
│   │   │   │                                           --- Справочники VZOR (7 файлов) ---
│   │   │   ├── 00-vzor-overview.md                     Проект VZOR
│   │   │   ├── 01-server-infrastructure.md             Инфраструктура сервера
│   │   │   ├── 02-deployment-procedures.md             Процедуры деплоя
│   │   │   ├── 03-api-credentials.md                   API ключи
│   │   │   ├── 04-vzor-task-system.md                  Система задач
│   │   │   ├── 05-vzor-dev-structure.md                ★ Структура девелоперского проекта
│   │   │   │                                           (197 задач, 4 блока, зависимости)
│   │   │   │                                           Промпт читает этот файл через:
│   │   │   │                                           cat /a0/usr/knowledge/custom/main/
│   │   │   │                                               05-vzor-dev-structure.md
│   │   │   ├── 06-normative-reference.md               Нормативные ссылки
│   │   │   │
│   │   │   │                                           --- Ментальные модели (99 файлов) ---
│   │   │   │                                           ✔ ЗАГРУЖЕНЫ 2026-02-17
│   │   │   │                                           Префикс mm_, 8 дисциплин.
│   │   │   │                                           Промпт читает через:
│   │   │   │                                           cat /a0/usr/knowledge/custom/main/
│   │   │   │                                               mm_<файл>.md
│   │   │   │
│   │   │   ├── mm_m01_Карта_—_не_территория.md     ┐
│   │   │   ├── mm_m02_Круг_компетенций.md          │
│   │   │   ├── mm_m03_Мышление_от_первых_принц...  │  Общие (9)
│   │   │   ├── ...                                 │
│   │   │   ├── mm_m09_Бритва_Оккама.md             ┘
│   │   │   ├── mm_m10_...                          ┐  Наука (20)
│   │   │   ├── ...                                 ┘  m10–m29
│   │   │   ├── mm_m30_...                          ┐  Системное мышление (11)
│   │   │   ├── ...                                 ┘  m30–m40
│   │   │   ├── mm_m41_...                          ┐  Математика (7)
│   │   │   ├── ...                                 ┘  m41–m47
│   │   │   ├── mm_m48_...                          ┐  Экономика (12)
│   │   │   ├── ...                                 ┘  m48–m59
│   │   │   ├── mm_m60_...                          ┐  Искусство (11)
│   │   │   ├── ...                                 ┘  m60–m70
│   │   │   ├── mm_m71_...                          ┐  Война (5)
│   │   │   ├── ...                                 ┘  m71–m75
│   │   │   ├── mm_m76_...                          ┐  Человеческая природа (23)
│   │   │   ├── ...                                 │  m76–m98
│   │   │   ├── mm_m98_Предвзятость_подтверждения   ┘
│   │   │   └── mm_m101_Сценарное_планирование...      + доп. модели (m99–m101)
│   │   │
│   │   ├── solutions/                                  Решения проблем
│   │   └── fragments/                                  Фрагменты знаний
│   │
│   └── default/                                        Встроенные знания (не трогать)
│
│
│   ══════════════════════════════════════════════════════
│   3. ПАМЯТЬ — что запомнил из разговоров
│      Автоматическая. Агент сам записывает важное.
│   ══════════════════════════════════════════════════════
│
├── memory/
│   ├── default/                                        Текстовые воспоминания
│   └── embeddings/                                     Векторы для поиска по смыслу
│
│
│   ══════════════════════════════════════════════════════
│   4. ИНСТРУМЕНТЫ — .md (описание) + .py (код)
│      ⚠ Это НЕ встроенные tools агента!
│      Агент вызывает ВСЕ через bash (code_execution_tool).
│      Промпт содержит точные команды для вызова.
│      Python: /opt/venv/bin/python3 (не python3!)
│   ══════════════════════════════════════════════════════
│
├── instruments/
│   └── custom/
│       ├── ragflow_search/                             ★ Поиск по RAGFlow (bash)
│       │   ├── ragflow_search.md                       Описание (Problem/Solution)
│       │   └── ragflow_search.py                       Скрипт поиска
│       │                                               Вызов: /opt/venv/bin/python3
│       │                                                 .../ragflow_search.py
│       │                                                 search "запрос" --kb "КОД"
│       │
│       ├── vzor_tasks/                                 ★ Управление задачами v2.0 (bash)
│       │   ├── vzor_tasks.md                           Описание (Problem/Solution)
│       │   └── vzor_tasks.py                           Скрипт задач → PostgreSQL → 3D-граф
│       │                                               ─────────────────────────────
│       │                                               Версия 2.0: мультипроектность
│       │                                               Все команды требуют --project
│       │                                               Новые команды:
│       │                                                 clone-template, list-projects,
│       │                                                 delete-project
│       │                                               ─────────────────────────────
│       │                                               Вызов: /opt/venv/bin/python3
│       │                                                 .../vzor_tasks.py
│       │                                                 clone-template --project <slug>
│       │                                                 list --project <slug>
│       │                                                 create --project <slug> ...
│       │                                                 update <id> --project <slug> ...
│       │                                                 report --project <slug>
│       │                                                 list-projects
│       │                                                 delete-project --project <slug>
│       │
│       ├── vzor_deploy/                                Деплой изменений на сервер
│       ├── vzor_diagnostics/                           Диагностика сервера
│       ├── vzor_git/                                   Git операции
│       └── vzor_backup/                                Бэкапы
│
│
│   ══════════════════════════════════════════════════════
│   5. ДОКУМЕНТЫ — тяжёлые файлы (RAGFlow)
│      Отдельный сервис. Агент ищет bash-командой
│      ragflow_search.py.
│   ══════════════════════════════════════════════════════
│
│   RAGFlow (http://95.174.95.209:8088)
│       ├── ЭС  — Электроснабжение (833 чанка)         ПУЭ, кабели, щиты, нагрузки
│       ├── ВК  — Водоснабжение и канализация (403)     Вода, трубопроводы, насосы
│       ├── ОВиК — Отопление, вентиляция (473)          Теплопотери, ИТП, воздухообмен
│       ├── ПБ  — Пожарная безопасность (363)           Эвакуация, АПС, СОУЭ
│       ├── ГС  — Газоснабжение (222)                   Газопровод, подключение
│       ├── АР  — Архитектурные решения (119)           Планировки, фасады, инсоляция
│       ├── ОДИ — Доступность для МГН (25)              Пандусы, тактильные указатели
│       ├── СС  — Сети связи (149)                      Телефон, интернет, домофон
│       ├── ТУ  — Техусловия и регламенты (213)         ПП РФ 87, экспертиза
│       ├── Общее — Проектное дело (92)                 Общие вопросы
│       ├── Поставщики (2627)                           Прайсы, КП
│       ├── Технология (1202)                           Технологические карты
│       └── Экономика (0)                               Пока пуста
│       Итого: 13 баз, 6721 чанков
│
│
│   ══════════════════════════════════════════════════════
│   6. БАЗА ДАННЫХ — PostgreSQL (мультипроектная)
│      Таблица agent_zero.tasks + agent_zero.task_dependencies
│      Уникальность: (project, task_id) — составной ключ
│      Шаблон: project = '_template' (197 задач)
│      Проекты: clone-template копирует шаблон в новый project
│   ══════════════════════════════════════════════════════
│
│   PostgreSQL (vzor-postgres:5432, db: vzor_db)
│       │
│       ├── agent_zero.tasks
│       │   ├── id (serial PK)
│       │   ├── task_id (varchar)          P1.T1.S1, P2.T3, и т.д.
│       │   ├── project (varchar)          '_template' | 'zhk-lesnoy-nsk' | ...
│       │   ├── title (varchar)
│       │   ├── description (text)
│       │   ├── phase (int)                1-4 (блоки)
│       │   ├── level (int)                0=блок, 1=секция, 2=задача
│       │   ├── status (varchar)           pending|in_progress|completed|blocked
│       │   ├── progress (int)             0-100
│       │   ├── priority (varchar)         low|medium|high|critical
│       │   ├── agent (varchar)            Кто выполняет
│       │   ├── tags (text[])
│       │   ├── metadata (jsonb)
│       │   ├── parent_task_id (varchar)   FK → (project, task_id)
│       │   ├── created_at, updated_at
│       │   └── UNIQUE (project, task_id)  ★ Составной ключ
│       │
│       └── agent_zero.task_dependencies
│           ├── id (serial PK)
│           ├── task_id (varchar)
│           ├── depends_on_task_id (varchar)
│           ├── dependency_type (varchar)   blocks|blocked_by|related
│           ├── project (varchar)           ★ Привязка к проекту
│           └── UNIQUE (project, task_id, depends_on_task_id)
│
│
│   ══════════════════════════════════════════════════════
│   7. РАБОЧЕЕ ПРОСТРАНСТВО
│   ══════════════════════════════════════════════════════
│
├── workdir/                                            Агент сохраняет сюда документы
│   ├── zhk-solnechny-moscow/                           Тест 1 (NO-GO, данные из головы)
│   ├── zhk-parkovy-spb/                                Тест 2 (GO, данные адекватные)
│   ├── zhk-rechnoy-kazan/                              Тест 3 (УСЛОВНОЕ GO, vzor_tasks работает)
│   ├── zhk-lesnoy-nsk/                                 Тест 4 (мультипроектность ✔)
│   │   ├── _context.md
│   │   └── 01_investment_analysis/
│   │       ├── market_analysis.md
│   │       ├── legal_analysis.md
│   │       ├── urban_analysis.md
│   │       └── product_concept.md
│   │
│   └── ГГ-ММ-ДД_ЧЧ-МИ-СС_<проблема>/                Анализ по ментальным моделям
│       ├── problem_diagnosis.md
│       ├── questionnaire.md
│       ├── mental_models_selected.md
│       ├── reasoning_<модель>.md
│       └── analysis_report.md
│
├── settings.json                                       Настройки (модели, API ключи)
├── secrets.env                                         Секреты
├── AGENT_ZERO_STRUCTURE.md                             ← Копия этого файла на сервере
└── chats/                                              История чатов


FileBrowser: https://vzor-ai.com/fm
```

---

## Структура промпта (role.md)

**Файл:** `agents/agent0/prompts/agent.system.main.role.md`
**Размер:** 501 строка (v5.2)
**Обновлён:** 2026-02-21

Промпт состоит из 10 разделов. Все инструменты вызываются через bash (code_execution_tool).

### 1. Кто ты
Идентичность: **девелопер** (не ассистент). Мыслит категориями: деньги, время, риски, нормативы РФ. Сам предлагает решения.

### 2. Начало сессии ★ НОВЫЙ (v5.2)

**ПЕРВОЕ что агент делает при каждом разговоре** (до любой работы):
1. Читает `_context.md` — где остановился, какой проект, какая задача
2. Проверяет `list-projects` — какие проекты активны
3. Если есть проект — проверяет `report --project <slug>`
4. Продолжает с того места ИЛИ спрашивает что делать

**Зачем:** агент не начинает с чистого листа. Каждая сессия — продолжение предыдущей.

### 3. Как ты думаешь
6-шаговый процесс рассуждения перед каждым решением:

```
Постановка → Контекст → Данные → Варианты → Рекомендация → Действие
```

Откуда берёт данные:
- Нормативы → bash-команда RAGFlow (точная команда в промпте)
- Задачи → bash-команда `vzor_tasks` с `--project`
- Структура проекта → `cat /a0/usr/knowledge/custom/main/05-vzor-dev-structure.md`

### 4. КРИТИЧЕСКОЕ ПРАВИЛО: Данные ⚠️ (v3)

**Запрет на выдумывание цифр.** Перед любым расчётом агент ОБЯЗАН:
- Цены продажи → искать через RAGFlow или спросить пользователя
- Себестоимость → искать через RAGFlow или спросить пользователя
- Стоимость земли → спросить пользователя
- Если данных нет → пометить `⚠️ ТРЕБУЕТСЯ УТОЧНЕНИЕ` и указать допущение

Включает пример правильного/неправильного поведения и ориентировочные диапазоны цен.

### 5. Управление проектом (обновлён в v5.2)

**Мультипроектность** — каждый проект изолирован:
- Шаблон `_template` (197 задач) не трогается
- Для нового проекта → `clone-template --project <slug>`
- Все команды vzor_tasks с `--project <slug>`

**Создание нового проекта** (8 шагов):
1. Пойми задачу — уточни 3-5 параметров
2. Определи slug — `zhk-<название>-<город>` (транслит)
3. **Клонируй шаблон** — `clone-template --project <slug>` ★ ПЕРВЫЙ ШАГ
4. Загрузи скелет — `cat .../05-vzor-dev-structure.md`
5. Адаптируй — добавь/убери задачи с `--project`
6. Создай рабочую папку — `mkdir -p /a0/usr/workdir/<slug>/`
7. Работай по блокам — **ОДНА ПОДЗАДАЧА ЗА РАЗ** ★ НОВОЕ (v5.2)
8. Конец сессии — обнови `_context.md`

**Гранулярность работы** ★ НОВОЕ (v5.2):
```
1. Возьми следующую pending-задачу (L2) из текущего блока
2. Отметь как in_progress
3. Выполни: найди данные → рассуждай → создай документ
4. Отметь как completed
5. Сообщи результат (2-3 строки)
6. Сразу бери следующую задачу — не жди команды
```
**Зачем:** ответ за 1-3 мин (а не 15), контролируемый прогресс, не теряется контекст.

**Переход между блоками** ★ НОВОЕ (v5.2):
После завершения ВСЕХ задач блока:
1. Отчёт `report --project <slug> --by-phase`
2. Итог пользователю: файлы, цифры, проблемы
3. "Блок N завершён. Перехожу к Блоку N+1 — [название]"
4. **Не ждёт команды** — начинает следующий блок

**Ведение существующего проекта:**
- При старте → читай `_context.md` (раздел "Текущее состояние")
- `list-projects` → какие проекты есть
- `report --project <slug>` → прогресс
- Продолжить с места остановки → не спрашивай "чем помочь?"

### 6. Принципы
8 правил (добавлен #8 в v5):
1. Не придумывай данные
2. Создавай файлы, не текст в чат
3. Проверяй по нормативам через RAGFlow
4. Считай деньги
5. Предупреждай о рисках
6. Думай головой (добавляй/убирай задачи)
7. Делегируй подагентам
8. **Всегда указывай --project** ★ НОВЫЙ

### 7. Инструменты

**RAGFlow — bash-команда** (не встроенный tool!):
```bash
/opt/venv/bin/python3 /a0/usr/instruments/custom/ragflow_search/ragflow_search.py search "запрос" --kb "КОД"
```
13 баз знаний, 6721 чанков.

**vzor_tasks v2.0 — bash-команда** (не встроенный tool!):
```bash
# Клонировать шаблон (первый шаг нового проекта)
.../vzor_tasks.py clone-template --project zhk-lesnoy-nsk

# Список проектов
.../vzor_tasks.py list-projects

# Список задач проекта
.../vzor_tasks.py list --project zhk-lesnoy-nsk

# Создать задачу
.../vzor_tasks.py create --task-id P1.T5 --title "..." --phase 1 --level 1 --priority high --project zhk-lesnoy-nsk

# Обновить статус
.../vzor_tasks.py update P1.T2.S3 --status completed --progress 100 --project zhk-lesnoy-nsk

# Зависимости
.../vzor_tasks.py deps P1.T2.S3 --add P1.T2.S1 --type blocks --project zhk-lesnoy-nsk

# Отчёт
.../vzor_tasks.py report --project zhk-lesnoy-nsk --by-phase

# Удалить проект
.../vzor_tasks.py delete-project --project zhk-lesnoy-nsk
```
Задачи отображаются в 3D-графе на vzor-ai.com.

**call_subordinate** — делегирование подагентам (встроенный tool, НЕ bash):
```json
{
    "tool_name": "call_subordinate",
    "tool_args": {
        "profile": "vzor-analyst",
        "message": "Ты — аналитик проекта <slug>. Задача: ...",
        "reset": "true"
    }
}
```

Правила делегирования (v5.3):
| Когда | Кому |
|-------|------|
| 5+ задач за раз | `vzor-planner` |
| Финмодель, стресс-тест, NPV/IRR | `vzor-analyst` |
| Деплой, Docker, Git | `vzor-deployer` |
| Ошибки, RCA | `vzor-debugger` |
| 1-3 простые операции | Сделай сам (НЕ делегируй) |

**Чтение файлов из knowledge — bash-команда:**
```bash
cat /a0/usr/knowledge/custom/main/<файл>.md
ls /a0/usr/knowledge/custom/main/mm_*.md
```

### 8. Ментальные модели — решётка Чарли Мангера

Полный пайплайн анализа проблем через ментальные модели:

```
Шаг 0: Инициализация
  └─ Приветствие, объяснение чем помочь

Шаг 1: Диагностика проблемы
  ├─ Уточняющие вопросы (до 5)
  ├─ Резюме → ключевая фраза (имя_проблемы)
  ├─ Создать папку: /workdir/ГГ-ММ-ДД_ЧЧ-МИ-СС_<проблема>/
  └─ → problem_diagnosis.md

Шаг 2: Выбор ментальных моделей
  ├─ 2.1: Анкета (до 5 вопросов) → questionnaire.md
  ├─ 2.2: ls /a0/usr/knowledge/custom/main/mm_*.md
  ├─ 2.3: cat каждого кандидата, оценка разделов
  ├─ 2.4: Финальный отбор — МАКСИМУМ 3 модели
  └─ 2.5: → mental_models_selected.md

Шаг 3: Итеративный анализ
  ├─ Для каждой модели: cat /a0/usr/knowledge/custom/main/mm_<файл>.md
  ├─ Следовать разделу «Шаги мышления»
  ├─ Искать доказательства через RAGFlow bash-команду
  └─ → reasoning_<имя_модели>.md

Шаг 4: Синтез и отчёт
  └─ → analysis_report.md
       ├─ Резюме
       ├─ Постановка проблемы
       ├─ Анализ по каждой модели
       ├─ Синтез и интегрированные выводы
       ├─ Варианты действий и рекомендации
       └─ Источники
```

**Связь с knowledge:** промпт ссылается на файлы `mm_*` (99 шт.) в `knowledge/custom/main/`. Каждый файл модели содержит: Описание, Когда избегать, Ключевые слова, Шаги мышления, Коучинговые вопросы. 8 дисциплин: общие, наука, системное мышление, математика, экономика, искусство, война, человеческая природа.

### 9. Формат ответов
Markdown. Разделы, списки, таблицы, жирный для выводов. Короткие абзацы.

---

## Связи: что на что ссылается

```
role.md (промпт, 501 строка, v5.2)
  │
  │   --- Начало сессии (v5.2) ---
  ├──→ _context.md                    1) Читает контекст (где остановился)
  ├──→ vzor_tasks list-projects       2) Проверяет активные проекты
  ├──→ vzor_tasks report --project    3) Проверяет прогресс
  │    └── Продолжает с места остановки ИЛИ спрашивает что делать
  │
  │   --- Инструменты (все вызываются через bash) ---
  ├──→ ragflow_search.py              bash: /opt/venv/bin/python3 .../ragflow_search.py
  │    └── RAGFlow API (13 KB)              search "запрос" --kb "КОД"
  ├──→ vzor_tasks.py v2.0             bash: /opt/venv/bin/python3 .../vzor_tasks.py
  │    ├── PostgreSQL                       Все команды с --project <slug>
  │    │   ├── _template (197 задач)        Шаблон, не трогать
  │    │   ├── zhk-lesnoy-nsk              Проект 1 (clone от шаблона)
  │    │   ├── zhk-rechnoy-kazan           Проект 2 ...
  │    │   └── ...                         Неограниченно проектов
  │    └── 3D-граф vzor-ai.com             Визуализация задач по проектам
  ├──→ call_subordinate               Встроенный tool → подагенты
  │
  │   --- Файлы knowledge (читаются через cat) ---
  ├──→ /a0/usr/knowledge/custom/main/
  │    ├── 05-vzor-dev-structure.md      Шаблон проекта (197 задач)
  │    ├── mm_*.md (99 файлов)           Ментальные модели
  │    └── 0x-*.md (7 файлов)            Справочники VZOR
  │
  │   --- Рабочий цикл (v5.2) ---
  │    Одна подзадача за раз:
  │    pending → in_progress → выполнение → completed → следующая
  │    После блока → отчёт → переход к следующему блоку
  │
  │   --- Конец сессии ---
  └──→ _context.md                    Обновляет "Текущее состояние"
       └── Дата, проект, блок, задача, что сделано, следующий шаг
```

---

## Исправленные проблемы

### Проблема 1: ragflow_search "Tool not found" (v3)
**Причина:** Агент вызывал `ragflow_search` как встроенный tool. На самом деле это bash-скрипт.
**Фикс:** В промпте явно указано, что RAGFlow — это bash-команда через `code_execution_tool`. Точная команда с `/opt/venv/bin/python3`.
**Результат:** ✔ Агент вызывает RAGFlow через bash.

### Проблема 2: Файл структуры не найден (v3)
**Причина:** Агент искал `cat /a0/usr/knowledge/05-vzor-dev-structure.md`. Реальный путь: `/a0/usr/knowledge/custom/main/05-vzor-dev-structure.md`.
**Фикс:** Точный путь + fallback через `find`.
**Результат:** ✔ Агент читает файл по правильному пути.

### Проблема 3: Данные из головы (v3)
**Причина:** Агент поставил цену = себестоимости (125 000), получил убыток -2,6 млрд.
**Фикс:** Раздел "КРИТИЧЕСКОЕ ПРАВИЛО: Данные" с ЗАПРЕЩЕНО, обязательным поиском, форматом ⚠️, примерами, ориентирами цен.
**Результат:** ✔ Адекватные цифры, все допущения помечены.

### Проблема 4: vzor_tasks "Tool not found" (v4)
**Причина:** Та же что с RAGFlow — агент вызывал как встроенный tool.
**Фикс:** Точные bash-команды для всех операций vzor_tasks.
**Результат:** ✔ Агент создаёт/обновляет задачи в PostgreSQL.

### Проблема 5: Нет изоляции проектов (v5)
**Причина:** В таблице `agent_zero.tasks` не было колонки `project`. Все задачи в одном пространстве — шаблон, ЖК Солнечный, ЖК Речной перемешаны. Агент обновлял шаблонные задачи вместо проектных.
**Фикс:**
1. **БД:** Добавлена колонка `project` в `tasks` и `task_dependencies`. Unique constraint изменён с `(task_id)` на `(project, task_id)`. Все FK обновлены на составные ключи.
2. **vzor_tasks.py v2.0:** Все команды требуют `--project`. Новые команды: `clone-template`, `list-projects`, `delete-project`.
3. **role.md v5:** Шаг "Клонируй шаблон" первым в создании проекта. Принцип #8 "Всегда указывай --project".
**Результат:** ✔ Тест 4 (ЖК Лесной): 197 задач клонированы в `zhk-lesnoy-nsk`, шаблон чистый (0 completed), полная изоляция.

### Проблема 6: Медленные ответы (v5.2)
**Причина:** Агент пытался делать весь блок (6+ задач) за один запрос. 19 code_execution вызовов, 10-15 минут на ответ.
**Фикс:** Раздел "КРИТИЧЕСКОЕ ПРАВИЛО: Гранулярность" — одна подзадача L2 за раз. Взял → in_progress → выполнил → completed → сообщил → следующая.
**Результат:** ✔ Тест 5: 1 команда вместо 19. Ответ за секунды.

### Проблема 7: Нет автопродолжения между сессиями (v5.2)
**Причина:** Агент не читал `_context.md` при старте. Каждая сессия начиналась с нуля — агент спрашивал "чем помочь?" даже если есть незавершённые задачи.
**Фикс:** Раздел "## Начало сессии" — ПЕРВЫМ делом: `cat _context.md` → `list-projects` → `report --project`. Продолжить с места остановки.
**Результат:** ✔ Тест 5: агент при "Привет" сразу прочитал контекст и вывел список проектов.

### Проблема 8: Нет перехода между блоками (v5.2)
**Причина:** Агент завершал Блок 1 и останавливался. Не переходил к Блоку 2 без явной команды.
**Фикс:** Раздел "Переход между блоками" — после завершения блока: отчёт → итог → "Перехожу к Блоку N+1" → начинает без команды.
**Результат:** Инструкция на месте. Требуется тест с полным прохождением блока.

### Проблема 9: Подагенты не вызываются (v5.3)
**Причина:** Тройная проблема:
1. В промпте role.md секция `call_subordinate` была расплывчатой — "делегируй когда нужно" без конкретных триггеров
2. Подагенты vzor-analyst и vzor-planner использовали `python3` вместо `/opt/venv/bin/python3` — команды не работали
3. Подагенты не знали про `--project` — писали в template вместо проекта
**Фикс:**
1. **role.md v5.3:** Секция `call_subordinate` переписана — JSON-пример, таблица "когда делегировать", 3 правила (когда обязательно / что указывать / когда НЕ делегировать)
2. **vzor-analyst:** Переписан role.md и _context.md — правильные пути, `--project`, RAGFlow
3. **vzor-planner:** Переписан role.md и _context.md — правильные пути, `--project`, `clone-template`
4. **vzor-deployer, vzor-debugger:** Не тронуты (shell-скрипты, не нуждаются в --project)
**Результат:** ✔ Тест 6: A0 вызвал `call_subordinate` → A1 (vzor-analyst) выполнил 9 команд → создал `detailed_financial_model.md` (178 строк, NPV/IRR/стресс-тест).

---

## Результаты тестов

### Тест 1: ЖК Солнечный (Москва) — v1, ДО фиксов
| Параметр | Значение | Проблема |
|----------|----------|----------|
| RAGFlow | "Tool not found" | Вызывал как built-in tool |
| Knowledge | "No such file" | Неправильный путь |
| Цена продажи | 125 000 руб./м2 | Из головы |
| Себестоимость | 125 000 руб./м2 | = цена продажи (!) |
| Прибыль | **-2,6 млрд руб.** | Убыток |
| Решение | NO-GO | Ошибочное |
| Задачи в БД | Не создавались | vzor_tasks не работал |

### Тест 2: ЖК Парковый (СПб) — v3, ПОСЛЕ фиксов 1-3
| Параметр | Значение | Статус |
|----------|----------|--------|
| RAGFlow | ✔ Вызван 2+ раза | bash работает |
| Knowledge | ✔ Прочитан | Правильный путь |
| Цена продажи | 250 000 руб./м2 (⚠️) | Адекватная |
| Себестоимость | 132 000 руб./м2 (⚠️) | Адекватная |
| Прибыль | **+5,3 млрд руб.** | Маржа 15,8% |
| Решение | GO | Корректное |
| Задачи в БД | Не создавались | vzor_tasks ещё не починен |

### Тест 3: ЖК Речной (Казань) — v4, ПОСЛЕ фикса 4
| Параметр | Значение | Статус |
|----------|----------|--------|
| RAGFlow | ✔ Работает | — |
| Цена продажи | 120 000 руб./м2 (⚠️) | Адекватная |
| Себестоимость | 91 000 руб./м2 (⚠️) | Адекватная |
| Прибыль | **+737 млн руб.** | ROS 17.6%, ROC 22.6% |
| Решение | УСЛОВНОЕ GO | Корректное |
| Задачи в БД | ✔ 13 completed | vzor_tasks работает |
| Проблема | Задачи без project | Шаблон испорчен |

### Тест 4: ЖК Лесной (Новосибирск) — v5, ПОСЛЕ фикса 5
| Параметр | Значение | Статус |
|----------|----------|--------|
| clone-template | ✔ 197 задач клонированы | `--project zhk-lesnoy-nsk` |
| Шаблон | ✔ Чистый (0 completed) | Не тронут |
| Проектные задачи | ✔ 5 completed в `zhk-lesnoy-nsk` | Изоляция работает |
| Файлы | 5 файлов в workdir | Блок 1 в процессе |
| list-projects | ✔ Показывает оба | `_template` и `zhk-lesnoy-nsk` |

### Тест 5: "Привет" — v5.2, ПОСЛЕ фиксов 6-8
| Параметр | v5.1 (было) | v5.2 (стало) |
|----------|-------------|--------------|
| Первое действие | Сразу начинал работать | ✔ Читает `_context.md` + `list-projects` |
| Команд за запрос | 19 code_execution | ✔ 1 команда |
| Время ответа | ~5-10 мин | ✔ Секунды |
| Поведение | Делал весь блок | ✔ Сообщает статус, ждёт указаний |
| Знает проекты | Нет | ✔ Перечислил 5 проектов с прогрессом |

### Тест 6: Делегирование финмодели — v5.3, ПОСЛЕ фикса 9
| Параметр | Значение | Статус |
|----------|----------|--------|
| Запрос | "Детальная финмодель с NPV, IRR, стресс-тест" | Запущен |
| A0 действие | `call_subordinate` → profile: `vzor-analyst` | ✔ Делегировал |
| A1 действие | 9 `code_execution_tool` вызовов | ✔ Работал сам |
| Файл | `detailed_financial_model.md` (178 строк) | ✔ Создан |
| NPV | 354.7 млн руб. (ставка 15%) | ✔ Рассчитан |
| IRR | 19.1% | ✔ Рассчитан |
| Стресс-тест | 3 сценария (базовый/оптимист/пессимист) | ✔ Выполнен |
| Допущения | Все помечены ⚠️ ТРЕБУЕТСЯ УТОЧНЕНИЕ | ✔ Честно |

---

## Версии промпта

| Версия | Строк | Дата | Что изменилось |
|--------|-------|------|----------------|
| v1 | 264 | 2026-02-21 | Начальный: идентичность, рассуждение, проект, модели |
| v2 | 264 | 2026-02-21 | + ментальные модели (полный пайплайн) |
| v3 | 335 | 2026-02-21 | + КРИТИЧЕСКОЕ ПРАВИЛО Данные, RAGFlow bash-fix, path fix |
| v4 | 373 | 2026-02-21 | + vzor_tasks bash-команды (create/list/update/report) |
| v5 | 415 | 2026-02-21 | + Мультипроектность: clone-template, --project, принцип #8 |
| v5.1 | 439 | 2026-02-21 | + analysis_report сохраняется в файл (не в чат) |
| v5.2 | 501 | 2026-02-21 | + Начало сессии, гранулярность, переход блоков, _context.md v2 |
| **v5.3** | **533** | **2026-02-21** | **+ Делегирование: правила, JSON-пример, триггеры. Фикс vzor-analyst/planner** |

---

## Статус (2026-02-21)

| Шаг | Статус | Что |
|-----|--------|-----|
| 99 файлов моделей в knowledge | ✔ | 99 файлов `mm_*` загружены, FAISS индексирует |
| Алгоритм моделей в промпт | ✔ | Полный пайплайн (Шаги 0–4) с bash-командами |
| Промпт — девелоперское мышление | ✔ | Идентичность, рассуждение, управление проектом |
| _context.md — самообновление | ✔ | v2: "Текущее состояние" + инструкции старт/финиш |
| Фикс 1: RAGFlow как bash-команда | ✔ | Точная команда в промпте |
| Фикс 2: точный путь к knowledge | ✔ | `/a0/usr/knowledge/custom/main/` |
| Фикс 3: запрет на данные из головы | ✔ | Раздел "КРИТИЧЕСКОЕ ПРАВИЛО", пометки ⚠️ |
| Фикс 4: vzor_tasks как bash-команда | ✔ | Точные команды с `/opt/venv/bin/python3` |
| Фикс 5: изоляция проектов | ✔ | `project` колонка, vzor_tasks v2.0, clone-template |
| Фикс 6: гранулярность (скорость) | ✔ | Одна подзадача за раз, 1 команда вместо 19 |
| Фикс 7: автопродолжение сессий | ✔ | "Начало сессии" — читает контекст первым делом |
| Фикс 8: переход между блоками | ✔ | Автопереход: отчёт → итог → следующий блок |
| Фикс 9: делегирование подагентам | ✔ | Правила в role.md, фикс vzor-analyst/planner |
| Тест 1 (ЖК Солнечный) | ⚠️ | Убыток из-за данных из головы |
| Тест 2 (ЖК Парковый) | ✔ | RAGFlow работает, GO |
| Тест 3 (ЖК Речной) | ⚠️ | Задачи работают, но без изоляции |
| Тест 4 (ЖК Лесной) | ✔ | Полная изоляция, шаблон чистый |
| Тест 5 ("Привет") | ✔ | 1 команда, читает контекст, знает проекты |
| **Тест 6 (Делегирование)** | **✔** | **A0→A1 (vzor-analyst), финмодель 178 строк, NPV/IRR/стресс-тест** |

---

## Локальные источники (рабочий стол)

```
C:\Users\solle\Desktop\vzor-ai.com\
├── AGENT_ZERO_STRUCTURE.md              ← ВЫ ЗДЕСЬ (этот файл)
├── role_v5.md                           Копия промпта v5.3 (533 строки)
├── vzor_tasks.py                        Копия скрипта v2.0
└── МЕНТАЛЬНЫЕ МЫСЛИ_0\
    └── ментальные мысли\
        └── gemini-plus-mental-models-repo\
            ├── Mental_Models\                 99 файлов-источников моделей
            │   ├── Mental_Model_General\      m01–m09
            │   ├── Mental_Model_Science\      m10–m29
            │   ├── Mental_Model_SysThinking\  m30–m40
            │   ├── Mental_Model_Math\         m41–m47
            │   ├── Mental_Model_Economics\    m48–m59
            │   ├── Mental_Model_Art\          m60–m70
            │   ├── Mental_Model_War\          m71–m75
            │   └── Mental_Model_HumanNature\  m76–m98
            └── Additional_Info\               Доп. материалы
```
